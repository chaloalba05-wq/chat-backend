<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Live Chat</title>
  <style>
    /* ===== GLOBAL STYLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      height: -webkit-fill-available;
      display: flex;
      flex-direction: column;
      background: #f8f9fa;
      overflow: hidden;
      touch-action: manipulation;
    }

    /* ===== RESPONSIVE HEADER ===== */
    #header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
      padding: 12px 16px;
      height: auto;
      min-height: 70px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      flex-shrink: 0;
      position: relative;
      z-index: 100;
    }

    .logo-text {
      font-size: clamp(1.8rem, 6vw, 2.5rem);
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
      margin: 0;
      line-height: 1.2;
    }

    .logo-subtext {
      font-size: clamp(0.8rem, 3vw, 1rem);
      opacity: 0.95;
      margin-top: 4px;
      letter-spacing: 0.5px;
      font-weight: 400;
    }

    /* ===== REGISTRATION SECTION ===== */
    #register {
      padding: 30px 20px;
      text-align: center;
      background: white;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: calc(100vh - 70px);
      padding-bottom: max(20px, env(safe-area-inset-bottom));
    }

    .register-container {
      max-width: 400px;
      width: 100%;
      padding: 25px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      margin: 0 auto;
    }

    .register-container h2 {
      color: #333;
      margin-bottom: 25px;
      font-size: clamp(1.4rem, 5vw, 1.8rem);
      font-weight: 600;
    }

    .register-container h3 {
      color: #555;
      margin-bottom: 25px;
      font-size: clamp(1rem, 4vw, 1.2rem);
      font-weight: 400;
    }

    /* ===== INPUT FIELDS ===== */
    input {
      padding: 16px;
      font-size: 16px;
      border-radius: 12px;
      border: 2px solid #e0e0e0;
      width: 100%;
      transition: all 0.3s ease;
      background: #fafafa;
      -webkit-appearance: none;
      appearance: none;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    #whatsapp {
      margin: 20px 0;
      font-size: clamp(16px, 4vw, 18px);
    }

    /* ===== BUTTONS ===== */
    button {
      padding: 16px 24px;
      font-size: clamp(16px, 4vw, 18px);
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      letter-spacing: 0.5px;
      user-select: none;
      min-height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    button:active {
      transform: scale(0.98);
    }

    .start-chat-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      width: 100%;
      margin-top: 15px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .start-chat-btn:hover {
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(-1px);
    }

    /* ===== CHAT SECTION - FIXED ===== */
    #chat {
      display: none;
      flex-direction: column;
      height: 100vh;
      height: -webkit-fill-available;
      background: #f8f9fa;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      z-index: 1000;
      overflow: hidden;
    }

    .chat-wrapper {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      overflow: hidden;
      min-height: 0;
    }

    /* ===== MESSAGES SECTION - FIXED BOX WITH SCROLL ===== */
    .messages-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
      position: relative;
      background: #f8f9fa;
    }

    .chat-header {
      padding: 16px;
      background: white;
      border-bottom: 1px solid #e8e8e8;
      flex-shrink: 0;
      z-index: 10;
      position: sticky;
      top: 0;
    }

    .chat-header h3 {
      margin: 0;
      color: #333;
      font-size: clamp(1.1rem, 4vw, 1.3rem);
      font-weight: 600;
    }

    .chat-header span {
      color: #667eea;
      font-weight: 500;
    }

    /* Messages container - FIXED SCROLLABLE BOX */
    #messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      scroll-behavior: smooth;
      will-change: transform;
      backface-visibility: hidden;
      transform: translateZ(0);
      display: flex;
      flex-direction: column;
      min-height: 0;
      background: #f8f9fa;
    }

    /* Bottom padding for messages */
    #messages::after {
      content: '';
      flex: 0 0 16px;
    }

    /* Optimized scrollbar */
    #messages::-webkit-scrollbar {
      width: 6px;
    }

    #messages::-webkit-scrollbar-track {
      background: rgba(241, 241, 241, 0.5);
      border-radius: 3px;
    }

    #messages::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.5);
      border-radius: 3px;
    }

    #messages::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.7);
    }

    /* Firefox scrollbar */
    #messages {
      scrollbar-width: thin;
      scrollbar-color: rgba(102, 126, 234, 0.5) rgba(241, 241, 241, 0.5);
    }

    /* ===== INPUT SECTION - FIXED AT BOTTOM ===== */
    .input-section {
      flex-shrink: 0;
      background: white;
      border-top: 1px solid #e8e8e8;
      z-index: 10;
      position: sticky;
      bottom: 0;
      padding-bottom: max(16px, env(safe-area-inset-bottom));
    }

    .input-area-container {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .upload-progress {
      width: 100%;
      background-color: #f3f3f3;
      border-radius: 10px;
      margin: 8px 16px;
      overflow: hidden;
      display: none;
      flex-shrink: 0;
    }

    .progress-bar {
      height: 6px;
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s ease;
    }

    .file-preview {
      padding: 8px 16px;
      background: #f8f9fa;
      border-radius: 20px;
      font-size: 14px;
      color: #666;
      margin: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .sending-indicator,
    .error-message {
      padding: 8px 16px;
      font-size: 14px;
      text-align: center;
      display: none;
      flex-shrink: 0;
    }

    .sending-indicator {
      color: #666;
      background: #fff9c4;
    }

    .error-message {
      color: #d32f2f;
      background: #ffebee;
    }

    .input-area {
      padding: 16px;
      background: white;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    #messageInput {
      flex: 1;
      border: 2px solid #e8e8e8;
      margin: 0;
      font-size: clamp(14px, 4vw, 16px);
      padding: 14px 16px;
      min-height: 50px;
      max-height: 120px;
      border-radius: 25px;
      background: #f8f9fa;
      resize: none;
      overflow-y: auto;
    }

    .action-buttons {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .file-upload-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .file-upload-btn {
      background: transparent;
      color: #667eea;
      border: none;
      padding: 12px;
      cursor: pointer;
      font-size: 22px;
      border-radius: 50%;
      min-height: 50px;
      min-width: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .file-upload-btn:active {
      background: rgba(102, 126, 234, 0.1);
      transform: scale(0.95);
    }

    .file-upload-label {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
      display: none;
    }

    .send-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 14px 24px;
      border-radius: 25px;
      font-weight: 600;
      min-height: 50px;
      min-width: 80px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .send-btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    /* ===== MESSAGE BUBBLES ===== */
    .message-container {
      margin: 12px 0;
      padding: 14px 18px;
      border-radius: 20px;
      max-width: 85%;
      word-wrap: break-word;
      position: relative;
      animation: fadeIn 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      line-height: 1.4;
      flex-shrink: 0;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .user-message {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: auto;
      margin-right: 8px;
      border-bottom-right-radius: 6px;
    }

    .other-message {
      background: white;
      border: 1px solid #e8e8e8;
      margin-right: auto;
      margin-left: 8px;
      border-bottom-left-radius: 6px;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .message-sender {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .user-message .message-sender {
      color: rgba(255,255,255,0.95);
    }

    .other-message .message-sender {
      color: #444;
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.8;
      font-weight: 400;
    }

    .user-message .message-time {
      color: rgba(255,255,255,0.8);
    }

    .other-message .message-time {
      color: #666;
    }

    .message-content {
      word-wrap: break-word;
      font-size: clamp(14px, 4vw, 16px);
      line-height: 1.5;
      overflow-wrap: break-word;
      word-break: break-word;
    }

    .read-status {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.8);
      margin-top: 6px;
      text-align: right;
      font-style: italic;
    }

    /* ===== FILE UPLOAD ===== */
    #fileInput {
      display: none;
    }

    /* ===== ATTACHMENTS ===== */
    .attachment {
      margin-top: 12px;
      padding: 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      border-left: 4px solid #4CAF50;
    }

    .other-message .attachment {
      background: #f8f9fa;
      border-left-color: #667eea;
    }

    .attachment a {
      color: #2196F3;
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .attachment a:hover {
      text-decoration: underline;
    }

    .attachment img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 8px;
      border: 1px solid #e0e0e0;
    }

    /* ===== SCROLL TO BOTTOM BUTTON ===== */
    .scroll-to-bottom-btn {
      position: absolute;
      bottom: 100px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      z-index: 5;
      transition: all 0.3s ease;
      opacity: 0;
      visibility: hidden;
    }
    
    .scroll-to-bottom-btn.visible {
      opacity: 1;
      visibility: visible;
    }
    
    .scroll-to-bottom-btn:hover {
      background: #764ba2;
      transform: translateY(-2px);
    }

    /* ===== TYPING INDICATOR ===== */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      background: white;
      border-radius: 20px;
      margin: 8px 0;
      width: fit-content;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: #667eea;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-6px);
      }
    }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center;
      color: #999;
      padding: 40px 20px;
      font-size: 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 200px;
    }

    /* ===== RESPONSIVE ADJUSTMENTS ===== */
    @media (max-width: 768px) {
      #header {
        padding: 10px 16px;
        min-height: 60px;
      }

      .logo-text {
        font-size: 1.6rem;
      }

      .register-container {
        padding: 20px;
        margin: 0 16px;
      }

      .input-area {
        padding: 12px;
        gap: 8px;
      }

      #messageInput {
        padding: 12px 16px;
        min-height: 46px;
      }

      .file-upload-btn,
      .send-btn {
        min-height: 46px;
        min-width: 46px;
      }

      .message-container {
        max-width: 90%;
        padding: 12px 16px;
        margin: 8px 0;
      }

      .attachment img {
        max-height: 150px;
      }
      
      .scroll-to-bottom-btn {
        bottom: 90px;
        right: 16px;
        width: 36px;
        height: 36px;
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      #header {
        padding: 8px 12px;
        min-height: 56px;
      }

      .logo-text {
        font-size: 1.4rem;
      }

      .logo-subtext {
        font-size: 0.75rem;
      }

      .register-container {
        padding: 16px;
        border-radius: 12px;
      }

      .register-container h2 {
        font-size: 1.2rem;
      }

      .register-container h3 {
        font-size: 0.95rem;
      }

      .input-area {
        padding: 10px;
      }

      .message-container {
        max-width: 92%;
        padding: 10px 14px;
      }

      .send-btn {
        min-width: 70px;
        padding: 12px 20px;
      }

      .file-upload-btn {
        font-size: 20px;
      }
      
      .scroll-to-bottom-btn {
        bottom: 85px;
        right: 12px;
        width: 32px;
        height: 32px;
        font-size: 14px;
      }
    }

    /* ===== SAFE AREA SUPPORT ===== */
    @supports (padding: max(0px)) {
      body, #register, .input-area {
        padding-left: max(16px, env(safe-area-inset-left));
        padding-right: max(16px, env(safe-area-inset-right));
      }
    }

    /* ===== LOADING STATES ===== */
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* ===== CONNECTION STATUS ===== */
    .connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      z-index: 1000;
      display: none;
    }

    .connected {
      background: #4CAF50;
      color: white;
    }

    .disconnected {
      background: #f44336;
      color: white;
    }

    /* ===== LOADING OVERLAY ===== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      display: none;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      margin-top: 16px;
      color: #333;
      font-size: 14px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ===== LINK STYLES ===== */
    .message-content a {
      color: #2196F3;
      text-decoration: none;
      font-weight: 500;
      word-break: break-all;
    }
    
    .message-content a:hover {
      text-decoration: underline;
    }
    
    .user-message .message-content a {
      color: rgba(255, 255, 255, 0.9);
      text-decoration: underline;
    }
    
    .user-message .message-content a:hover {
      color: white;
    }
  </style>
</head>
<body>

<!-- Header with logo -->
<div id="header">
  <div class="logo-text">ALBASTUZ3D</div>
  <div class="logo-subtext">OFFICIAL SUPPORT</div>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text" id="loadingText">Restoring chat session...</div>
</div>

<!-- Registration section -->
<div id="register">
  <div class="register-container">
    <h2>Welcome to Albastuz3D Support</h2>
    <h3>Enter your WhatsApp number to start chatting</h3>
    <input id="whatsapp" placeholder="+2547xxxxxxx" type="tel">
    <button class="start-chat-btn" onclick="register()">
      Start Chat
    </button>
  </div>
</div>

<!-- Chat section -->
<div id="chat">
  <div class="chat-wrapper">
    <!-- Messages Section - Fixed box with scroll -->
    <div class="messages-section">
      <div class="chat-header">
        <h3>Chat: <span id="chatNumber"></span></h3>
      </div>
      
      <!-- Scroll to bottom button -->
      <button class="scroll-to-bottom-btn" id="scrollToBottomBtn" title="Scroll to bottom">
        ‚Üì
      </button>
      
      <!-- Scrollable messages box -->
      <div id="messages">
        <!-- Messages will appear here -->
        <div class="empty-state">
          <div>No messages yet. Start the conversation!</div>
        </div>
      </div>
    </div>
    
    <!-- Input Section - Always fixed at bottom -->
    <div class="input-section">
      <div class="input-area-container">
        <div class="upload-progress" id="uploadProgress">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="file-preview" id="filePreview"></div>
        
        <div class="sending-indicator" id="sendingIndicator">Sending...</div>
        <div class="error-message" id="errorMessage">Please wait before sending another message</div>
        
        <div class="input-area">
          <textarea id="messageInput" placeholder="Type your message here..." rows="1"></textarea>
          <div class="action-buttons">
            <div class="file-upload-container">
              <button class="file-upload-btn" onclick="document.getElementById('fileInput').click()" title="Attach file">
                üìé
              </button>
              <span class="file-upload-label">file upload</span>
            </div>
            <button class="send-btn" onclick="sendMessage()" id="sendButton">
              Send
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <input type="file" id="fileInput" onchange="handleFileSelect()">
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  // ===== GLOBAL VARIABLES =====
  const socket = io("https://chat-backend-p2b9.onrender.com", {
    reconnection: true,
    reconnectionAttempts: Infinity,
    reconnectionDelay: 1000,
    reconnectionDelayMax: 5000,
    timeout: 20000,
    transports: ['websocket', 'polling'],
    query: {
      clientType: 'user',
      version: '2.0'
    }
  });
  
  let whatsapp = "";
  let selectedFile = null;
  let isScrolledToBottom = true;
  
  // ===== SESSION PERSISTENCE MANAGER =====
  const SessionManager = {
    STORAGE_KEYS: {
      SESSION: 'chat_session',
      MESSAGES: 'chat_messages_',
      OFFLINE_MESSAGES: 'offline_messages_'
    },
    
    SESSION_DURATION: 24 * 60 * 60 * 1000, // 24 hours
    
    // Save complete session state
    saveSession() {
      if (!whatsapp) return;
      
      try {
        const session = {
          whatsapp: whatsapp,
          timestamp: Date.now(),
          isInChat: document.getElementById("chat").style.display === "flex",
          inputValue: document.getElementById("messageInput").value || ''
        };
        
        localStorage.setItem(this.STORAGE_KEYS.SESSION, JSON.stringify(session));
        console.log('üíæ Saved session state');
      } catch (error) {
        console.error('Error saving session:', error);
      }
    },
    
    // Restore session on page load
    restoreSession() {
      try {
        const sessionData = localStorage.getItem(this.STORAGE_KEYS.SESSION);
        if (!sessionData) return null;
        
        const session = JSON.parse(sessionData);
        
        // Check if session is expired
        if (Date.now() - session.timestamp > this.SESSION_DURATION) {
          this.clearSession();
          return null;
        }
        
        console.log('üìÇ Restored session:', session);
        return session;
      } catch (error) {
        console.error('Error restoring session:', error);
        return null;
      }
    },
    
    // Clear session data
    clearSession() {
      try {
        localStorage.removeItem(this.STORAGE_KEYS.SESSION);
        console.log('üßπ Cleared session data');
      } catch (error) {
        console.error('Error clearing session:', error);
      }
    },
    
    // Save current view state
    saveViewState() {
      if (!whatsapp) return;
      
      try {
        const viewState = {
          whatsapp: whatsapp,
          chatVisible: document.getElementById("chat").style.display === "flex",
          lastScrollPosition: document.getElementById("messages")?.scrollTop || 0
        };
        
        sessionStorage.setItem('chat_view_state', JSON.stringify(viewState));
      } catch (error) {
        console.error('Error saving view state:', error);
      }
    },
    
    // Restore view state
    restoreViewState() {
      try {
        const viewState = sessionStorage.getItem('chat_view_state');
        if (viewState) {
          return JSON.parse(viewState);
        }
      } catch (error) {
        console.error('Error restoring view state:', error);
      }
      return null;
    }
  };
  
  // ===== ENHANCED LOCAL STORAGE FOR MESSAGE PERSISTENCE =====
  const MessageStorage = {
    storageKey: 'chat_messages_',
    
    getStorageKey() {
      return this.storageKey + (whatsapp || 'unregistered');
    },
    
    saveMessages(messages) {
      if (!whatsapp) return;
      
      try {
        const key = this.getStorageKey();
        const data = {
          messages: messages,
          lastUpdated: Date.now(),
          whatsapp: whatsapp
        };
        localStorage.setItem(key, JSON.stringify(data));
        console.log('üíæ Saved messages to localStorage:', messages.length);
      } catch (error) {
        console.error('Error saving messages to localStorage:', error);
        // Clear if storage is full
        if (error.name === 'QuotaExceededError') {
          this.clearOldMessages();
        }
      }
    },
    
    loadMessages() {
      if (!whatsapp) return [];
      
      try {
        const key = this.getStorageKey();
        const data = localStorage.getItem(key);
        if (!data) return [];
        
        const parsed = JSON.parse(data);
        
        // Check if data is not too old (24 hours)
        const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
        if (parsed.lastUpdated < oneDayAgo) {
          console.log('üßπ Clearing old messages from localStorage');
          localStorage.removeItem(key);
          return [];
        }
        
        console.log('üìÇ Loaded messages from localStorage:', parsed.messages.length);
        return parsed.messages || [];
      } catch (error) {
        console.error('Error loading messages from localStorage:', error);
        return [];
      }
    },
    
    clearOldMessages() {
      try {
        // Clear messages older than 2 days
        const twoDaysAgo = Date.now() - (2 * 24 * 60 * 60 * 1000);
        
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith(this.storageKey)) {
            try {
              const data = JSON.parse(localStorage.getItem(key));
              if (data.lastUpdated && data.lastUpdated < twoDaysAgo) {
                localStorage.removeItem(key);
                console.log('üóëÔ∏è Cleared old messages for:', key);
              }
            } catch (e) {
              // Invalid JSON, remove it
              localStorage.removeItem(key);
            }
          }
        }
      } catch (error) {
        console.error('Error clearing old messages:', error);
      }
    }
  };
  
  // ===== ENHANCED PERSISTENT CONNECTION MANAGER =====
  const PersistentConnection = {
    isConnected: false,
    reconnectAttempts: 0,
    maxReconnectAttempts: 50,
    reconnectDelay: 1000,
    maxReconnectDelay: 60000,
    heartbeatInterval: null,
    connectionCheckInterval: null,
    lastActivityTime: Date.now(),
    connectionState: 'disconnected',
    offlineMessages: [],
    lastSuccessfulConnection: null,
    
    init() {
      this.setupConnectionPersistence();
      this.setupActivityTracking();
      this.setupVisibilityTracking();
      this.setupOfflineStorage();
      console.log('üîó Enhanced persistent connection manager initialized');
    },
    
    setupConnectionPersistence() {
      // Heartbeat to keep connection alive
      this.heartbeatInterval = setInterval(() => {
        if (socket.connected) {
          socket.emit('heartbeat', { 
            timestamp: Date.now(),
            whatsapp: whatsapp || 'not-registered'
          });
          console.log('‚ù§Ô∏è Heartbeat sent');
        }
      }, 25000);
      
      // Check connection status periodically
      this.connectionCheckInterval = setInterval(() => {
        this.checkConnection();
      }, 10000);
    },
    
    setupActivityTracking() {
      const activityEvents = ['mousedown', 'mousemove', 'keydown', 'touchstart', 'scroll', 'click'];
      activityEvents.forEach(event => {
        document.addEventListener(event, () => {
          this.lastActivityTime = Date.now();
        }, { passive: true });
      });
      
      setInterval(() => {
        const inactiveTime = Date.now() - this.lastActivityTime;
        if (inactiveTime < 60000 && socket.connected) {
          socket.emit('activity_ping', { whatsapp: whatsapp || 'not-registered' });
        }
      }, 60000);
    },
    
    setupVisibilityTracking() {
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          console.log('üëÄ Page became visible, checking connection...');
          this.reconnectIfNeeded();
          
          const timeAway = Date.now() - this.lastActivityTime;
          if (timeAway > 30000 && whatsapp && socket.connected) {
            console.log('üîÑ Refreshing messages after being away');
            socket.emit("get_messages", { whatsapp: whatsapp });
          }
        }
      });
      
      window.addEventListener('focus', () => {
        console.log('üéØ Window focused, checking connection...');
        this.reconnectIfNeeded();
      });
      
      window.addEventListener('online', () => {
        console.log('üåê Internet connection restored');
        this.showConnectionStatus('connected', 'Back online - Reconnecting...');
        this.reconnectWithBackoff();
      });
      
      window.addEventListener('offline', () => {
        console.log('üåê Internet connection lost');
        this.showConnectionStatus('disconnected', 'Offline - Messages will be saved locally');
      });
    },
    
    setupOfflineStorage() {
      window.addEventListener('load', () => {
        this.checkOfflineMessages();
      });
    },
    
    checkOfflineMessages() {
      try {
        const offlineData = localStorage.getItem('offline_messages_' + whatsapp);
        if (offlineData) {
          const messages = JSON.parse(offlineData);
          console.log('üì® Found offline messages:', messages.length);
          
          if (messages.length > 0 && socket.connected) {
            this.resendOfflineMessages(messages);
          }
        }
      } catch (error) {
        console.error('Error checking offline messages:', error);
      }
    },
    
    saveOfflineMessage(message) {
      try {
        const key = 'offline_messages_' + whatsapp;
        let messages = [];
        
        const existing = localStorage.getItem(key);
        if (existing) {
          messages = JSON.parse(existing);
        }
        
        messages.push({
          ...message,
          offlineTimestamp: Date.now()
        });
        
        if (messages.length > 20) {
          messages = messages.slice(-20);
        }
        
        localStorage.setItem(key, JSON.stringify(messages));
        console.log('üíæ Saved offline message:', message);
      } catch (error) {
        console.error('Error saving offline message:', error);
      }
    },
    
    resendOfflineMessages(messages) {
      console.log('üì§ Resending offline messages:', messages.length);
      
      messages.forEach((msg, index) => {
        setTimeout(() => {
          if (socket.connected) {
            socket.emit("user_message", {
              whatsapp: whatsapp,
              userId: whatsapp,
              message: msg.text || msg.message,
              attachment: msg.attachment,
              isResend: true,
              originalTimestamp: msg.timestamp
            });
            console.log('üîÑ Resent offline message:', msg);
          }
        }, index * 1000);
      });
      
      localStorage.removeItem('offline_messages_' + whatsapp);
    },
    
    checkConnection() {
      if (!socket.connected) {
        this.reconnectWithBackoff();
      } else {
        if (this.connectionState !== 'connected') {
          this.connectionState = 'connected';
          this.lastSuccessfulConnection = Date.now();
          this.showConnectionStatus('connected', 'Connected');
        }
      }
    },
    
    reconnectWithBackoff() {
      if (this.reconnectAttempts >= this.maxReconnectAttempts) {
        console.log('üõë Max reconnection attempts reached');
        this.showConnectionStatus('disconnected', 'Connection failed. Please refresh the page.');
        return;
      }
      
      const delay = Math.min(
        this.reconnectDelay * Math.pow(1.5, this.reconnectAttempts),
        this.maxReconnectDelay
      );
      
      console.log(`üîÑ Attempting reconnect in ${Math.round(delay/1000)}s (attempt ${this.reconnectAttempts + 1})`);
      
      this.connectionState = 'reconnecting';
      this.showConnectionStatus('reconnecting', `Reconnecting... (${this.reconnectAttempts + 1}/${this.maxReconnectAttempts})`);
      
      setTimeout(() => {
        if (!socket.connected) {
          this.reconnectAttempts++;
          console.log(`üîå Reconnection attempt ${this.reconnectAttempts}`);
          socket.disconnect();
          socket.connect();
        }
      }, delay);
    },
    
    reconnectIfNeeded() {
      if (!socket.connected) {
        console.log('üîå Page became visible, reconnecting...');
        this.reconnectAttempts = 0;
        this.connectionState = 'reconnecting';
        socket.connect();
      }
    },
    
    showConnectionStatus(status, message) {
      let statusDiv = document.getElementById('connectionStatus');
      if (!statusDiv) {
        statusDiv = document.createElement('div');
        statusDiv.id = 'connectionStatus';
        statusDiv.className = 'connection-status';
        document.body.appendChild(statusDiv);
      }
      
      statusDiv.className = `connection-status ${status}`;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      
      if (status === 'connected') {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 5000);
      }
    },
    
    resetReconnection() {
      this.reconnectAttempts = 0;
      this.connectionState = 'connected';
      this.lastSuccessfulConnection = Date.now();
      console.log('üîÑ Reconnection counter reset');
    },
    
    cleanup() {
      if (this.heartbeatInterval) {
        clearInterval(this.heartbeatInterval);
      }
      if (this.connectionCheckInterval) {
        clearInterval(this.connectionCheckInterval);
      }
    }
  };
  
  // Initialize persistent connection
  PersistentConnection.init();
  
  // ===== SENDING CONTROL SYSTEM =====
  const sendController = {
    isSending: false,
    cooldown: false,
    debounceTimer: null,
    enterKeyCooldown: false,
    lastSendTime: 0,
    consecutiveSends: 0,
    
    canSend() {
      const now = Date.now();
      
      if (this.isSending) {
        console.log('‚ö†Ô∏è Already sending, please wait...');
        return { canSend: false, reason: 'Already sending' };
      }
      
      if (this.cooldown) {
        console.log('‚ö†Ô∏è Send cooldown active');
        return { canSend: false, reason: 'Cooldown active' };
      }
      
      if (this.debounceTimer) {
        console.log('‚ö†Ô∏è Debounce active');
        return { canSend: false, reason: 'Debounce active' };
      }
      
      if (this.consecutiveSends >= 3) {
        const timeSinceLast = now - this.lastSendTime;
        if (timeSinceLast < 1000) {
          console.log('‚ö†Ô∏è Too many rapid sends');
          return { canSend: false, reason: 'Too many rapid sends' };
        }
      }
      
      return { canSend: true };
    },
    
    beginSend() {
      this.isSending = true;
      this.lastSendTime = Date.now();
      this.consecutiveSends++;
      
      setTimeout(() => {
        this.consecutiveSends = 0;
      }, 2000);
      
      this.debounceTimer = setTimeout(() => {
        this.debounceTimer = null;
      }, 500);
    },
    
    finishSend() {
      this.isSending = false;
      this.cooldown = true;
      
      setTimeout(() => {
        this.cooldown = false;
      }, 1000);
    },
    
    reset() {
      this.isSending = false;
      this.cooldown = false;
      if (this.debounceTimer) {
        clearTimeout(this.debounceTimer);
        this.debounceTimer = null;
      }
    }
  };
  
  // ===== FORMAT FUNCTIONS =====
  function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString([], { 
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
  
  // ===== LINK DETECTION AND FORMATTING =====
  function createClickableLinks(text) {
    // Regular expression to find URLs
    const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+)/g;
    
    // Replace URLs with anchor tags
    return text.replace(urlRegex, function(url) {
      // Add http:// if starts with www
      let href = url;
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        href = 'http://' + url;
      }
      
      // Create a clean display URL (remove protocol for display)
      let displayUrl = url;
      if (displayUrl.startsWith('http://')) {
        displayUrl = displayUrl.substring(7);
      } else if (displayUrl.startsWith('https://')) {
        displayUrl = displayUrl.substring(8);
      }
      
      // Shorten long URLs for display
      if (displayUrl.length > 30) {
        displayUrl = displayUrl.substring(0, 27) + '...';
      }
      
      return `<a href="${href}" target="_blank" rel="noopener noreferrer">${displayUrl}</a>`;
    });
  }
  
  // ===== SCROLL MANAGEMENT =====
  function setupScrollListener() {
    const messagesDiv = document.getElementById("messages");
    const scrollToBottomBtn = document.getElementById("scrollToBottomBtn");
    
    messagesDiv.addEventListener('scroll', function() {
      const scrollTop = messagesDiv.scrollTop;
      const scrollHeight = messagesDiv.scrollHeight;
      const clientHeight = messagesDiv.clientHeight;
      
      isScrolledToBottom = (scrollHeight - scrollTop - clientHeight) < 50;
      
      if (!isScrolledToBottom) {
        scrollToBottomBtn.classList.add('visible');
      } else {
        scrollToBottomBtn.classList.remove('visible');
      }
    }, { passive: true });
    
    scrollToBottomBtn.addEventListener('click', scrollToBottom);
  }
  
  function scrollToBottom() {
    const messagesDiv = document.getElementById("messages");
    if (messagesDiv) {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      isScrolledToBottom = true;
      document.getElementById("scrollToBottomBtn").classList.remove('visible');
    }
  }
  
  function scrollToBottomSmooth() {
    const messagesDiv = document.getElementById("messages");
    if (messagesDiv && isScrolledToBottom) {
      messagesDiv.scrollTo({
        top: messagesDiv.scrollHeight,
        behavior: 'smooth'
      });
    }
  }
  
  // ===== ENHANCED SOCKET EVENT LISTENERS =====
  socket.on("connect", () => {
    console.log("‚úÖ Connected to server with ID:", socket.id);
    PersistentConnection.showConnectionStatus('connected', 'Connected');
    PersistentConnection.resetReconnection();
    
    if (whatsapp) {
      console.log("üîÑ Re-registering after reconnect:", whatsapp);
      socket.emit("register", { whatsapp: whatsapp });
      
      const localMessages = MessageStorage.loadMessages();
      if (localMessages.length > 0) {
        console.log("üìÇ Displaying messages from localStorage:", localMessages.length);
        displayMessages(localMessages, false);
      }
      
      socket.emit("get_messages", { whatsapp: whatsapp });
    }
  });

  socket.on("disconnect", (reason) => {
    console.log("‚ùå Disconnected from server:", reason);
    PersistentConnection.connectionState = 'disconnected';
    
    if (reason === 'io server disconnect') {
      PersistentConnection.showConnectionStatus('disconnected', 'Server disconnected - Reconnecting...');
      setTimeout(() => socket.connect(), 2000);
    } else if (reason === 'io client disconnect') {
      PersistentConnection.showConnectionStatus('disconnected', 'Disconnected');
    } else {
      PersistentConnection.showConnectionStatus('disconnected', 'Connection lost - Reconnecting...');
      PersistentConnection.reconnectWithBackoff();
    }
  });

  socket.on("connect_error", (error) => {
    console.error("üîå Connection error:", error.message);
    PersistentConnection.showConnectionStatus('disconnected', 'Connection error. Reconnecting...');
  });

  socket.on("reconnect", (attemptNumber) => {
    console.log(`üîÑ Reconnected after ${attemptNumber} attempts`);
    PersistentConnection.showConnectionStatus('connected', 'Reconnected');
    PersistentConnection.resetReconnection();
    
    if (whatsapp) {
      setTimeout(() => {
        socket.emit("get_messages", { whatsapp: whatsapp });
      }, 1000);
    }
  });

  socket.on("reconnect_attempt", (attemptNumber) => {
    console.log(`üîÑ Reconnection attempt ${attemptNumber}`);
  });

  socket.on("reconnecting", (attemptNumber) => {
    console.log(`üîÑ Reconnecting... attempt ${attemptNumber}`);
    PersistentConnection.showConnectionStatus('disconnected', `Reconnecting... (${attemptNumber})`);
  });

  socket.on("reconnect_failed", () => {
    console.log('üõë Reconnection failed');
    PersistentConnection.showConnectionStatus('disconnected', 'Connection failed. Working offline.');
    
    const messagesDiv = document.getElementById("messages");
    if (messagesDiv) {
      const offlineNotice = document.createElement("div");
      offlineNotice.className = "message-container other-message";
      offlineNotice.innerHTML = `
        <div class="message-header">
          <span class="message-sender">System</span>
          <span class="message-time">${formatTime(new Date())}</span>
        </div>
        <div class="message-content">
          ‚ö†Ô∏è You are currently offline. Messages will be saved locally and sent when you reconnect.
        </div>
      `;
      messagesDiv.appendChild(offlineNotice);
    }
  });

  socket.on("registered", (data) => {
    console.log("‚úÖ Registration successful:", data);
    
    try {
      localStorage.setItem('last_whatsapp', whatsapp);
      localStorage.setItem('last_registration', Date.now());
    } catch (error) {
      console.error('Error saving registration info:', error);
    }
  });

  socket.on("new_message", (msg) => {
    console.log("üì® New message received from server:", {
      id: msg.id,
      sender: msg.sender,
      timestamp: msg.timestamp,
      preview: (msg.text || msg.message || '').substring(0, 50)
    });
    
    displayMessage(msg);
    saveAllMessagesToStorage();
    
    if (msg.sender === "user") {
      finishMessageSend();
    }
  });

  socket.on("message_history", (messages) => {
    console.log("üìú Message history from server:", messages.length, "messages");
    
    const localMessages = MessageStorage.loadMessages();
    const allMessages = mergeMessages(localMessages, messages);
    
    displayMessages(allMessages);
    MessageStorage.saveMessages(allMessages);
    
    // Hide loading overlay when messages are loaded
    document.getElementById('loadingOverlay').style.display = 'none';
  });

  function mergeMessages(localMessages, serverMessages) {
    const messageMap = new Map();
    
    localMessages.forEach(msg => {
      if (msg.id) {
        messageMap.set(msg.id, msg);
      }
    });
    
    serverMessages.forEach(msg => {
      if (msg.id) {
        messageMap.set(msg.id, msg);
      }
    });
    
    const merged = Array.from(messageMap.values());
    merged.sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());
    
    console.log(`üîÑ Merged ${localMessages.length} local + ${serverMessages.length} server = ${merged.length} total messages`);
    return merged;
  }

  function saveAllMessagesToStorage() {
    const messagesDiv = document.getElementById("messages");
    if (!messagesDiv) return;
    
    const messages = [];
    const messageElements = messagesDiv.querySelectorAll('.message-container');
    
    messageElements.forEach(element => {
      const messageId = element.dataset.messageId;
      const sender = element.classList.contains('user-message') ? 'user' : 'agent';
      const contentElement = element.querySelector('.message-content');
      const timeElement = element.querySelector('.message-time');
      
      if (contentElement && timeElement) {
        const message = {
          id: messageId || Date.now().toString(),
          sender: sender,
          text: contentElement.textContent.trim(),
          timestamp: new Date().toISOString(),
          message: contentElement.textContent.trim()
        };
        
        messages.push(message);
      }
    });
    
    if (messages.length > 0) {
      MessageStorage.saveMessages(messages);
    }
  }

  // ===== MESSAGE DISPLAY FUNCTIONS =====
  function createMessageElement(msg) {
    const messageDiv = document.createElement("div");
    messageDiv.className = "message-container " + 
      (msg.sender === "user" ? "user-message" : "other-message");
    
    let content = "";
    if (msg.attachment) {
      content = formatAttachment(msg.attachment);
    }
    
    const senderName = msg.sender === "user" ? "You" : (msg.agentName || "Support");
    const messageText = msg.text || msg.message || '';
    
    messageDiv.innerHTML = `
      <div class="message-header">
        <span class="message-sender">${senderName}</span>
        <span class="message-time" title="${formatDateTime(msg.timestamp)}">
          ${formatTime(msg.timestamp)}
        </span>
      </div>
      <div class="message-content">${createClickableLinks(messageText)}</div>
      ${content}
      ${msg.read ? `<div class="read-status">‚úì Read ${formatTime(msg.readAt)}</div>` : ''}
    `;
    
    messageDiv.dataset.messageId = msg.id || 'no-id';
    
    return messageDiv;
  }

  function displayMessage(msg, scroll = true) {
    const messagesDiv = document.getElementById("messages");
    
    const emptyState = messagesDiv.querySelector('.empty-state');
    if (emptyState) {
      emptyState.remove();
    }
    
    const messageElement = createMessageElement(msg);
    messagesDiv.appendChild(messageElement);
    
    if (scroll && (isScrolledToBottom || msg.sender === "user")) {
      Promise.resolve().then(() => {
        scrollToBottomSmooth();
      });
    }
  }

  function displayMessages(messages, scroll = true) {
    const messagesDiv = document.getElementById("messages");
    
    messagesDiv.innerHTML = '';
    
    if (messages.length === 0) {
      const emptyState = document.createElement("div");
      emptyState.className = "empty-state";
      emptyState.innerHTML = '<div>No messages yet. Start the conversation!</div>';
      messagesDiv.appendChild(emptyState);
      return;
    }
    
    const fragment = document.createDocumentFragment();
    
    const sortedMessages = messages.sort((a, b) => 
      new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime()
    );
    
    sortedMessages.forEach(msg => {
      const messageElement = createMessageElement(msg);
      fragment.appendChild(messageElement);
    });
    
    messagesDiv.appendChild(fragment);
    
    if (scroll) {
      setTimeout(scrollToBottom, 50);
    }
  }

  function formatAttachment(attachment) {
    if (!attachment) return '';
    
    const fileType = attachment.mimetype ? attachment.mimetype.split('/')[0] : 'file';
    let icon = 'üìÑ';
    let preview = '';
    
    const fileUrl = attachment.url || attachment.path;
    const fileName = attachment.originalname || attachment.filename || 'file';
    const fileSize = attachment.size ? formatFileSize(attachment.size) : '';
    
    if (fileType === 'image') {
      icon = 'üñºÔ∏è';
      preview = `<img src="${fileUrl}" alt="${fileName}" loading="lazy" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 8px; border: 1px solid #e0e0e0;">`;
    } else if (fileType === 'video') {
      icon = 'üé¨';
      preview = `<div style="margin-top: 8px;"><video src="${fileUrl}" controls preload="metadata" style="max-width: 100%; max-height: 200px; border-radius: 8px;"></video></div>`;
    } else if (fileType === 'audio') {
      icon = 'üéµ';
      preview = `<div style="margin-top: 8px;"><audio src="${fileUrl}" controls preload="metadata" style="width: 100%;"></audio></div>`;
    } else if (attachment.mimetype && attachment.mimetype.includes('pdf')) {
      icon = 'üìï';
    }
    
    return `
      <div class="attachment">
        <a href="${fileUrl}" target="_blank" download="${fileName}">
          ${icon} ${fileName}
          ${fileSize ? `<span style="color: #666; font-size: 0.9em; margin-left: 8px;">(${fileSize})</span>` : ''}
        </a>
        ${preview}
      </div>
    `;
  }

  // ===== ENHANCED REGISTRATION WITH SESSION RESTORATION =====
  function register() {
    const input = document.getElementById("whatsapp");
    whatsapp = input.value.trim();
    
    if (!whatsapp) {
      alert("Please enter a WhatsApp number");
      return;
    }

    if (!/^\+?[\d\s\-\(\)]+$/.test(whatsapp)) {
      alert("Please enter a valid phone number");
      return;
    }

    console.log("Registering:", whatsapp);
    socket.emit("register", { whatsapp: whatsapp });

    showChatInterface();
    
    // Save session
    SessionManager.saveSession();
    
    // Load messages from localStorage first
    const localMessages = MessageStorage.loadMessages();
    if (localMessages.length > 0) {
      console.log("üìÇ Loading messages from localStorage:", localMessages.length);
      displayMessages(localMessages, false);
    }
    
    // Then get messages from server
    socket.emit("get_messages", { whatsapp: whatsapp });
    
    // Focus on message input after registration
    setTimeout(() => {
      document.getElementById("messageInput").focus();
    }, 300);
  }

  function showChatInterface() {
    document.getElementById("register").style.display = "none";
    document.getElementById("chat").style.display = "flex";
    document.getElementById("chatNumber").textContent = whatsapp;
    
    sendController.reset();
    
    // Setup scroll listener after chat is visible
    setTimeout(setupScrollListener, 100);
  }

  // ===== AUTOMATIC SESSION RESTORATION ON PAGE LOAD =====
  function restoreChatSession() {
    const session = SessionManager.restoreSession();
    
    if (session && session.isInChat && session.whatsapp) {
      console.log('üîÑ Restoring chat session for:', session.whatsapp);
      
      // Show loading overlay
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loadingText').textContent = 'Restoring chat session...';
      
      // Set the whatsapp number
      whatsapp = session.whatsapp;
      
      // Show chat interface immediately for better UX
      showChatInterface();
      
      // Restore input value if any
      if (session.inputValue) {
        document.getElementById('messageInput').value = session.inputValue;
      }
      
      // Connect to socket and re-register
      if (socket && !socket.connected) {
        socket.connect();
      }
      
      // Load messages from localStorage immediately
      const localMessages = MessageStorage.loadMessages();
      if (localMessages.length > 0) {
        console.log("üìÇ Loading messages from localStorage:", localMessages.length);
        displayMessages(localMessages, false);
        document.getElementById('loadingText').textContent = 'Loading messages...';
      }
      
      // Register with server and get updated messages
      setTimeout(() => {
        if (socket.connected) {
          socket.emit("register", { whatsapp: whatsapp });
          socket.emit("get_messages", { whatsapp: whatsapp });
        } else {
          // If socket not connected, still hide loading after a timeout
          setTimeout(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
          }, 2000);
        }
      }, 1000);
      
      return true;
    }
    
    return false;
  }

  // ===== FILE HANDLING =====
  function handleFileSelect() {
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    
    if (fileInput.files.length > 0) {
      selectedFile = fileInput.files[0];
      filePreview.innerHTML = `üìé ${selectedFile.name} (${formatFileSize(selectedFile.size)})`;
      filePreview.style.display = 'flex';
    } else {
      selectedFile = null;
      filePreview.innerHTML = '';
      filePreview.style.display = 'none';
    }
  }

  function uploadFile(callback) {
    if (!selectedFile) {
      if (callback) callback(null);
      return;
    }

    const formData = new FormData();
    formData.append('file', selectedFile);

    const xhr = new XMLHttpRequest();
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');

    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';

    xhr.upload.addEventListener('progress', function(e) {
      if (e.lengthComputable) {
        const percentComplete = (e.loaded / e.total) * 100;
        progressBar.style.width = percentComplete + '%';
      }
    });

    xhr.addEventListener('load', function() {
      progressDiv.style.display = 'none';
      
      if (xhr.status === 200) {
        try {
          const response = JSON.parse(xhr.responseText);
          if (response.success && callback) {
            callback(response.file);
          } else {
            alert('Upload failed: ' + (response.message || 'Unknown error'));
            if (callback) callback(null);
          }
        } catch (e) {
          alert('Upload failed: Invalid response from server');
          if (callback) callback(null);
        }
      } else {
        alert('Upload failed with status: ' + xhr.status);
        if (callback) callback(null);
      }
      
      document.getElementById('fileInput').value = '';
      document.getElementById('filePreview').innerHTML = '';
      document.getElementById('filePreview').style.display = 'none';
      selectedFile = null;
    });

    xhr.addEventListener('error', function() {
      progressDiv.style.display = 'none';
      alert('Upload failed. Please check your connection.');
      if (callback) callback(null);
    });

    xhr.open('POST', '/upload');
    xhr.send(formData);
  }

  // ===== MESSAGE SENDING =====
  function sendMessage() {
    const canSend = sendController.canSend();
    if (!canSend.canSend) {
      showError(canSend.reason);
      return;
    }
    
    const text = document.getElementById("messageInput").value.trim();
    const fileInput = document.getElementById('fileInput');
    
    if (!text && !fileInput.files.length) {
      alert("Please enter a message or select a file");
      return;
    }
    
    sendController.beginSend();
    
    const sendButton = document.getElementById('sendButton');
    const sendingIndicator = document.getElementById('sendingIndicator');
    const errorMessage = document.getElementById('errorMessage');
    
    sendButton.disabled = true;
    sendButton.textContent = "...";
    sendingIndicator.style.display = 'block';
    errorMessage.style.display = 'none';
    
    const sendTimeout = setTimeout(() => {
      console.log("‚ö†Ô∏è Send timeout - clearing sending state");
      finishMessageSend();
      showError("Message sent but waiting for confirmation. It may appear shortly.");
    }, 10000);
    
    if (fileInput.files.length > 0) {
      uploadFile(function(fileInfo) {
        if (fileInfo) {
          console.log("üì§ Sending message with attachment to server");
          
          const messageData = {
            whatsapp: whatsapp,
            userId: whatsapp,
            message: text,
            attachment: fileInfo
          };
          
          if (socket.connected) {
            socket.emit("user_message", messageData);
          } else {
            console.log("üì¥ Offline - saving message for later");
            PersistentConnection.saveOfflineMessage(messageData);
            showError("Offline - Message saved locally. Will send when reconnected.");
            clearTimeout(sendTimeout);
            finishMessageSend();
          }
        } else {
          if (text) {
            const messageData = {
              whatsapp: whatsapp,
              userId: whatsapp,
              message: text
            };
            
            if (socket.connected) {
              socket.emit("user_message", messageData);
            } else {
              console.log("üì¥ Offline - saving message for later");
              PersistentConnection.saveOfflineMessage(messageData);
              showError("Offline - Message saved locally. Will send when reconnected.");
              clearTimeout(sendTimeout);
              finishMessageSend();
            }
          } else {
            clearTimeout(sendTimeout);
            finishMessageSend();
          }
        }
        
        document.getElementById("messageInput").value = "";
        fileInput.value = "";
        document.getElementById("filePreview").innerHTML = "";
        document.getElementById("filePreview").style.display = 'none';
        
        const messageInput = document.getElementById("messageInput");
        messageInput.style.height = 'auto';
        messageInput.style.height = '50px';
      });
    } else {
      console.log("üì§ Sending text message to server");
      
      const messageData = {
        whatsapp: whatsapp,
        userId: whatsapp,
        message: text
      };
      
      if (socket.connected) {
        socket.emit("user_message", messageData);
      } else {
        console.log("üì¥ Offline - saving message for later");
        PersistentConnection.saveOfflineMessage(messageData);
        showError("Offline - Message saved locally. Will send when reconnected.");
        clearTimeout(sendTimeout);
        finishMessageSend();
      }
      
      document.getElementById("messageInput").value = "";
      
      const messageInput = document.getElementById("messageInput");
      messageInput.style.height = 'auto';
      messageInput.style.height = '50px';
    }
  }
  
  function finishMessageSend() {
    sendController.finishSend();
    
    const sendButton = document.getElementById('sendButton');
    const sendingIndicator = document.getElementById('sendingIndicator');
    
    sendButton.disabled = false;
    sendButton.textContent = "Send";
    sendingIndicator.style.display = 'none';
    
    // Save session state after sending message
    SessionManager.saveSession();
    
    document.getElementById("messageInput").focus();
  }
  
  function showError(message) {
    const errorMessage = document.getElementById('errorMessage');
    errorMessage.textContent = message;
    errorMessage.style.display = 'block';
    
    setTimeout(() => {
      errorMessage.style.display = 'none';
    }, 5000);
  }

  // ===== EVENT LISTENERS =====
  document.getElementById("messageInput").addEventListener("keydown", function(e) {
    // Check if Enter is pressed WITHOUT Shift
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault(); // Prevent default behavior (new line)
      sendMessage();
    }
    // If Shift+Enter is pressed, allow default behavior (new line)
  });

  document.getElementById("messageInput").addEventListener("input", function() {
    this.style.height = 'auto';
    const newHeight = Math.min(this.scrollHeight, 120);
    this.style.height = newHeight + 'px';
    
    // Auto-save input state
    SessionManager.saveSession();
  });

  // Handle back button on mobile
  window.addEventListener('popstate', function() {
    if (document.getElementById("chat").style.display === "flex") {
      document.getElementById("chat").style.display = "none";
      document.getElementById("register").style.display = "flex";
      
      saveAllMessagesToStorage();
      SessionManager.saveSession();
    }
  });

  // ===== ENHANCED CLEANUP =====
  window.addEventListener('beforeunload', function() {
    // Save session state before leaving
    saveAllMessagesToStorage();
    SessionManager.saveSession();
    
    if (socket && socket.connected) {
      socket.emit('client_disconnecting', { 
        whatsapp: whatsapp,
        reason: 'page_closed'
      });
    }
    
    PersistentConnection.cleanup();
    
    if (socket) {
      socket.disconnect();
    }
    
    console.log('üßπ Cleanup completed');
  });

  // Auto-save session state periodically
  setInterval(() => {
    if (whatsapp) {
      SessionManager.saveSession();
      saveAllMessagesToStorage();
    }
  }, 30000);

  // Auto-cleanup old localStorage messages
  setInterval(() => {
    MessageStorage.clearOldMessages();
  }, 5 * 60 * 1000);
  
  // ===== INITIALIZATION =====
  window.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Enhanced chat application loading...');
    
    // Try to restore previous session
    const sessionRestored = restoreChatSession();
    
    if (!sessionRestored) {
      // No session to restore, show registration normally
      console.log('üìù No previous session found, showing registration');
      document.getElementById('loadingOverlay').style.display = 'none';
      
      // Try to restore last WhatsApp number
      try {
        const lastWhatsapp = localStorage.getItem('last_whatsapp');
        const lastRegistration = localStorage.getItem('last_registration');
        
        if (lastWhatsapp && lastRegistration) {
          const registrationTime = parseInt(lastRegistration);
          const oneHourAgo = Date.now() - (60 * 60 * 1000);
          
          if (registrationTime > oneHourAgo) {
            document.getElementById("whatsapp").value = lastWhatsapp;
            console.log('üì± Restored last WhatsApp number:', lastWhatsapp);
          }
        }
      } catch (error) {
        console.error('Error restoring last WhatsApp number:', error);
      }
      
      document.getElementById("whatsapp").focus();
    }
    
    console.log('üíæ Session persistence: ACTIVE');
    console.log('üì° Enhanced reconnection: ACTIVE');
    console.log('üì¥ Offline message support: ACTIVE');
  });

  // Save session state on visibility change
  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'hidden') {
      SessionManager.saveSession();
    }
  });
</script>
</body>
</html>