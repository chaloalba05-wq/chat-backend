<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Live Chat</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    #chat { display: none; margin-top: 20px; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
    input, button { padding: 8px; margin-top: 5px; font-size: 14px; }
    .message { margin: 5px 0; padding: 8px; border-radius: 5px; }
    .user-message { background-color: #e3f2fd; text-align: right; }
    .other-message { background-color: #f5f5f5; }
  </style>
</head>
<body>

<div id="register">
  <h3>Enter WhatsApp number</h3>
  <input id="whatsapp" placeholder="+2547xxxxxxx" style="width: 200px;">
  <button onclick="register()">Start Chat</button>
</div>

<div id="chat">
  <h3>Chat: <span id="chatNumber"></span></h3>
  <div id="messages"></div>
  <div>
    <input id="messageInput" placeholder="Type your message" style="width: 300px;">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const socket = io("https://chat-backend-p2b9.onrender.com");
  let whatsapp = "";

  socket.on("connect", () => {
    console.log("Connected to server with ID:", socket.id);
  });

  socket.on("registered", (data) => {
    console.log("Registration successful:", data);
  });

  socket.on("new_message", (msg) => {
    console.log("New message received:", msg);
    const messagesDiv = document.getElementById("messages");
    const messageDiv = document.createElement("div");
    messageDiv.className = "message " + (msg.sender === "user" ? "user-message" : "other-message");
    messageDiv.textContent = `${msg.sender}: ${msg.text}`;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  socket.on("message_history", (messages) => {
    console.log("Message history:", messages);
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";
    messages.forEach(msg => {
      const messageDiv = document.createElement("div");
      messageDiv.className = "message " + (msg.sender === "user" ? "user-message" : "other-message");
      messageDiv.textContent = `${msg.sender}: ${msg.text}`;
      messagesDiv.appendChild(messageDiv);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  function register() {
    whatsapp = document.getElementById("whatsapp").value.trim();
    if (!whatsapp) {
      alert("Please enter a WhatsApp number");
      return;
    }

    console.log("Registering:", whatsapp);
    socket.emit("register", { whatsapp: whatsapp });

    document.getElementById("register").style.display = "none";
    document.getElementById("chat").style.display = "block";
    document.getElementById("chatNumber").textContent = whatsapp;
    
    // Load message history
    socket.emit("get_messages", { whatsapp: whatsapp });
  }

  function sendMessage() {
    const text = document.getElementById("messageInput").value.trim();
    if (!text) return;

    console.log("Sending message:", text);
    socket.emit("send_message", {
      whatsapp: whatsapp,
      sender: "user",
      text: text
    });

    document.getElementById("messageInput").value = "";
  }

  // Allow sending message with Enter key
  document.getElementById("messageInput").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      sendMessage();
    }
  });
</script>

</body>
</html>