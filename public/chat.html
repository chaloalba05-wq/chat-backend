<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Live Chat</title>
  <style>
    body { 
      font-family: Arial; 
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Header styling - covers 1/6 of display */
    #header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
      padding: 15px 0;
      height: 16.67vh; /* Approximately 1/6 of viewport height */
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .logo-text {
      font-size: 2.5rem;
      font-weight: bold;
      letter-spacing: 1.5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin: 0;
    }
    
    .logo-subtext {
      font-size: 1rem;
      opacity: 0.9;
      margin-top: 5px;
      letter-spacing: 1px;
    }
    
    #register {
      padding: 40px 20px;
      text-align: center;
      background: white;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    #chat { 
      display: none; 
      flex: 1;
      flex-direction: column;
      height: calc(100vh - 16.67vh);
    }
    
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }
    
    .chat-header {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    #messages { 
      border: 1px solid #ddd;
      height: 400px;
      overflow-y: auto;
      padding: 15px;
      margin-bottom: 15px;
      background: #fafafa;
      border-radius: 10px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    input, button { 
      padding: 10px; 
      margin-top: 5px; 
      font-size: 14px; 
      border-radius: 5px;
    }
    
    #messageInput {
      flex: 1;
      border: 1px solid #ddd;
      margin-right: 10px;
    }
    
    .input-container {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    /* Updated message styles - FIXED FOR VERTICAL DISPLAY */
    .message-container {
      margin: 8px 0;
      padding: 10px 15px;
      border-radius: 12px;
      max-width: 80%;
      word-wrap: break-word;
      display: block;
      clear: both;
    }
    
    .user-message { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: auto;
      margin-right: 10px;
      text-align: right;
      float: right;
      clear: both;
    }
    
    .other-message { 
      background: white;
      border: 1px solid #e0e0e0;
      margin-right: auto;
      margin-left: 10px;
      text-align: left;
      float: left;
      clear: both;
    }
    
    .unread-message {
      background-color: #fff8e1 !important;
      border-left: 3px solid #ff9800;
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .user-message .message-sender {
      color: rgba(255,255,255,0.9);
    }
    
    .other-message .message-sender {
      color: #333;
    }
    
    .message-sender {
      font-weight: bold;
      font-size: 0.9rem;
    }
    
    .user-message .message-time {
      color: rgba(255,255,255,0.7);
    }
    
    .other-message .message-time {
      color: #666;
    }
    
    .message-time {
      font-size: 0.8rem;
      font-style: italic;
    }
    
    .message-content {
      word-wrap: break-word;
      line-height: 1.4;
      display: block;
    }
    
    .read-status {
      font-size: 0.8rem;
      color: #4CAF50;
      margin-top: 5px;
      text-align: right;
    }
    
    /* File upload styles */
    #fileInput { display: none; }
    .file-upload-btn {
      background: transparent;
      color: #555;
      border: none;
      padding: 8px;
      cursor: pointer;
      font-size: 18px;
      position: relative;
    }

    .file-upload-btn:hover {
      background:  #f0f0f0;
      border-radius: 50%;
    }
    
    .file-upload-label {
      font-size: 11px;
      color: #666;
      text-align: center;
      margin-top: 2px;
      display: block;
    }
    
    .file-upload-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .file-preview {
      display: inline-block;
      margin-left: 10px;
      font-size: 12px;
      color: #666;
      background: #f0f0f0;
      padding: 5px 10px;
      border-radius: 5px;
    }
    .attachment {
      display: block;
      margin-top: 8px;
      padding: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      border-left: 4px solid #4CAF50;
    }
    .other-message .attachment {
      background: #f8f9fa;
    }
    .attachment a {
      color: #2196F3;
      text-decoration: none;
      font-weight: bold;
    }
    .attachment a:hover {
      text-decoration: underline;
    }
    .file-icon {
      margin-right: 8px;
    }
    .upload-progress {
      width: 100%;
      background-color: #f3f3f3;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    .progress-bar {
      height: 25px;
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
      border-radius: 5px;
      text-align: center;
      color: white;
      line-height: 25px;
      width: 0%;
      transition: width 0.3s ease;
      font-weight: bold;
    }
    
    .send-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      font-weight: bold;
    }
    
    .send-btn:hover {
      background: #1976D2;
      transform: translateY(-1px);
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    
    /* Sending indicator */
    .sending-indicator {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      text-align: center;
      display: none;
    }
    
    /* Error message */
    .error-message {
      color: #d32f2f;
      font-size: 12px;
      text-align: center;
      margin-top: 5px;
      display: none;
    }
  </style>
</head>
<body>

<!-- Header with logo - covers 1/6 of display -->
<div id="header">
  <div class="logo-text">ALBASTUZ3D</div>
  <div class="logo-subtext">OFFICIAL SUPPORT</div>
</div>

<!-- Registration section -->
<div id="register">
  <div style="max-width: 400px; width: 100%;">
    <h2 style="color: #333; margin-bottom: 30px;">Welcome to Albastuz3D Support</h2>
    <h3>Enter your WhatsApp number to start chatting</h3>
    <input id="whatsapp" placeholder="+2547xxxxxxx" style="width: 100%; padding: 12px; font-size: 16px; margin: 20px 0;">
    <button onclick="register()" style="background: #667eea; color: white; padding: 12px 30px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
      Start Chat
    </button>
  </div>
</div>

<!-- Chat section -->
<div id="chat">
  <div class="chat-container">
    <div class="chat-header">
      <h3 style="margin: 0; color: #333;">Chat: <span id="chatNumber" style="color: #667eea;"></span></h3>
    </div>
    
    <div id="messages"></div>
    
    <div id="uploadProgress" style="display: none;">
      <div class="upload-progress">
        <div class="progress-bar" id="progressBar">0%</div>
      </div>
    </div>
    
    <div class="input-container">
      <input id="messageInput" placeholder="Type your message here..." style="flex: 1;">
      <div class="action-buttons">
        <div class="file-upload-container">
          <button class="file-upload-btn" onclick="document.getElementById('fileInput').click()" title="Attach file">
            üìé
          </button>
          <span class="file-upload-label">file upload</span>
        </div>
        <button class="send-btn" onclick="sendMessage()" id="sendButton">
          Send
        </button>
      </div>
    </div>
    <div class="sending-indicator" id="sendingIndicator">Sending...</div>
    <div class="error-message" id="errorMessage">Please wait before sending another message</div>
    <span id="filePreview" class="file-preview"></span>
    <input type="file" id="fileInput" onchange="handleFileSelect()">
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  // ===== GLOBAL VARIABLES WITH ANTI-DUPLICATE PROTECTION =====
  const socket = io("https://chat-backend-p2b9.onrender.com");
  let whatsapp = "";
  let selectedFile = null;
  let lastMessageTime = null;
  let isSending = false;
  let sendCooldown = false;
  let sentMessageIds = new Set(); // Track sent message IDs to prevent duplicates
  let pendingMessageId = null; // Track the ID of the message we just sent
  let debounceTimer = null;
  
  // ===== FORMAT FUNCTIONS =====
  function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString([], { 
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // ===== SOCKET EVENT LISTENERS =====
  socket.on("connect", () => {
    console.log("Connected to server with ID:", socket.id);
  });

  socket.on("registered", (data) => {
    console.log("Registration successful:", data);
  });

  // Handle incoming messages - FIXED DUPLICATE PREVENTION
  socket.on("new_message", (msg) => {
    console.log("New message received:", msg);
    
    // Generate unique message ID for duplicate checking
    const messageId = generateMessageId(msg);
    
    // Check if we've already seen this message
    if (sentMessageIds.has(messageId)) {
      console.log("‚ö†Ô∏è Duplicate message detected, skipping:", messageId);
      return;
    }
    
    // Add to sent message tracking
    sentMessageIds.add(messageId);
    
    // Clean up old message IDs (keep only last 100)
    if (sentMessageIds.size > 100) {
      const iterator = sentMessageIds.values();
      for (let i = 0; i < 50; i++) {
        sentMessageIds.delete(iterator.next().value);
      }
    }
    
    // FIX: Check if this is our own pending message
    if (pendingMessageId && messageId === pendingMessageId) {
      console.log("This is our own pending message, we already showed it");
      pendingMessageId = null; // Clear pending flag
      return; // Don't show it again
    }
    
    // Skip if this is our own message that was just sent (fallback)
    if (msg.sender === "user" && msg.whatsapp === whatsapp && lastMessageTime) {
      const messageTime = new Date(msg.timestamp).getTime();
      const timeDiff = Math.abs(messageTime - lastMessageTime);
      
      // If message was sent within last 3 seconds, skip it (already shown)
      if (timeDiff < 3000) {
        console.log("Skipping own recent message");
        return;
      }
    }
    
    displayMessage(msg);
  });

  // Handle message history
  socket.on("message_history", (messages) => {
    console.log("Message history:", messages);
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";
    messages.forEach(msg => {
      // Add historical messages to tracking
      const messageId = generateMessageId(msg);
      sentMessageIds.add(messageId);
      displayMessage(msg, false);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  // Generate unique message ID for duplicate tracking
  function generateMessageId(msg) {
    if (msg.id) return msg.id;
    if (msg.timestamp && msg.sender && msg.whatsapp) {
      return `${msg.sender}_${msg.whatsapp}_${msg.timestamp}_${(msg.text || msg.message || '').substring(0, 20)}`;
    }
    return `${Date.now()}_${Math.random()}`;
  }

  // ===== MESSAGE DISPLAY FUNCTIONS =====
  function displayMessage(msg, scroll = true) {
    const messagesDiv = document.getElementById("messages");
    const messageDiv = document.createElement("div");
    messageDiv.className = "message-container " + 
      (msg.sender === "user" ? "user-message" : "other-message") +
      (msg.read ? "" : " unread-message");
    
    let content = "";
    if (msg.attachment) {
      content = formatAttachment(msg.attachment);
    }
    
    const senderName = msg.sender === "user" ? "You" : (msg.agentName || "Support");
    
    messageDiv.innerHTML = `
      <div class="message-header">
        <span class="message-sender">${senderName}</span>
        <span class="message-time" title="${formatDateTime(msg.timestamp)}">
          ${formatTime(msg.timestamp)}
        </span>
      </div>
      <div class="message-content">${msg.text || msg.message || ''}</div>
      ${content}
      ${msg.read ? `<div class="read-status">‚úì Read ${formatTime(msg.readAt)}</div>` : ''}
    `;
    
    messagesDiv.appendChild(messageDiv);
    if (scroll) {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  }

  function formatAttachment(attachment) {
    if (!attachment) return '';
    
    const fileType = attachment.mimetype ? attachment.mimetype.split('/')[0] : 'file';
    let icon = 'üìÑ';
    let preview = '';
    
    // Use url if available, otherwise use path
    const fileUrl = attachment.url || attachment.path;
    const fileName = attachment.originalname || attachment.filename || 'file';
    const fileSize = attachment.size ? formatFileSize(attachment.size) : '';
    
    if (fileType === 'image') {
      icon = 'üñºÔ∏è';
      preview = `<br><img src="${fileUrl}" style="max-width: 200px; max-height: 150px; border-radius: 5px; margin-top: 5px; border: 1px solid #ddd;">`;
    } else if (fileType === 'video') {
      icon = 'üé¨';
    } else if (fileType === 'audio') {
      icon = 'üéµ';
    } else if (attachment.mimetype && attachment.mimetype.includes('pdf')) {
      icon = 'üìï';
    }
    
    return `
      <div class="attachment">
        <span class="file-icon">${icon}</span>
        <a href="${fileUrl}" target="_blank" download="${fileName}">
          ${fileName}
        </a>
        ${fileSize ? `<span style="color: #666; font-size: 11px; margin-left: 5px;">(${fileSize})</span>` : ''}
        ${preview}
      </div>
    `;
  }

  function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // ===== REGISTRATION =====
  function register() {
    whatsapp = document.getElementById("whatsapp").value.trim();
    if (!whatsapp) {
      alert("Please enter a WhatsApp number");
      return;
    }

    console.log("Registering:", whatsapp);
    socket.emit("register", { whatsapp: whatsapp });

    document.getElementById("register").style.display = "none";
    document.getElementById("chat").style.display = "flex";
    document.getElementById("chatNumber").textContent = whatsapp;
    
    // Load message history
    socket.emit("get_messages", { whatsapp: whatsapp });
  }

  // ===== FILE HANDLING =====
  function handleFileSelect() {
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    
    if (fileInput.files.length > 0) {
      selectedFile = fileInput.files[0];
      filePreview.innerHTML = `üìé ${selectedFile.name} (${formatFileSize(selectedFile.size)})`;
    } else {
      selectedFile = null;
      filePreview.innerHTML = '';
    }
  }

  function uploadFile(callback) {
    if (!selectedFile) {
      if (callback) callback(null);
      return;
    }

    const formData = new FormData();
    formData.append('file', selectedFile);

    const xhr = new XMLHttpRequest();
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');

    // Show progress bar
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';

    xhr.upload.addEventListener('progress', function(e) {
      if (e.lengthComputable) {
        const percentComplete = (e.loaded / e.total) * 100;
        progressBar.style.width = percentComplete + '%';
        progressBar.textContent = Math.round(percentComplete) + '%';
      }
    });

    xhr.addEventListener('load', function() {
      progressDiv.style.display = 'none';
      
      if (xhr.status === 200) {
        try {
          const response = JSON.parse(xhr.responseText);
          if (response.success && callback) {
            callback(response.file);
          } else {
            alert('Upload failed: ' + (response.message || 'Unknown error'));
            if (callback) callback(null);
          }
        } catch (e) {
          alert('Upload failed: Invalid response from server');
          if (callback) callback(null);
        }
      } else {
        alert('Upload failed with status: ' + xhr.status);
        if (callback) callback(null);
      }
      
      // Reset file input
      document.getElementById('fileInput').value = '';
      document.getElementById('filePreview').innerHTML = '';
      selectedFile = null;
    });

    xhr.addEventListener('error', function() {
      progressDiv.style.display = 'none';
      alert('Upload failed. Please check your connection.');
      if (callback) callback(null);
    });

    xhr.open('POST', '/upload');
    xhr.send(formData);
  }

  // ===== MESSAGE SENDING - FIXED DUPLICATE ISSUE =====
  function sendMessage() {
    // DEBOUNCE: Prevent rapid multiple clicks
    if (debounceTimer) {
      console.log("Debounce active, ignoring click");
      return;
    }
    
    debounceTimer = setTimeout(() => {
      debounceTimer = null;
    }, 300);
    
    // Layer 1: Check if already sending
    if (isSending) {
      showError("Please wait, message is being sent...");
      console.log("‚ö†Ô∏è Already sending, please wait...");
      return;
    }
    
    // Layer 2: Check cooldown
    if (sendCooldown) {
      showError("Please wait before sending another message");
      console.log("‚ö†Ô∏è Send cooldown active, please wait...");
      return;
    }
    
    const text = document.getElementById("messageInput").value.trim();
    const fileInput = document.getElementById('fileInput');
    
    // If no text and no file, don't send
    if (!text && !fileInput.files.length) {
      alert("Please enter a message or select a file");
      return;
    }
    
    // Layer 3: Check for duplicate content (if same content was sent recently)
    if (text && lastMessageTime) {
      const timeSinceLastMessage = Date.now() - lastMessageTime;
      if (timeSinceLastMessage < 2000) { // 2 second cooldown
        showError("Please wait a moment before sending another message");
        return;
      }
    }
    
    // Set sending state
    isSending = true;
    sendCooldown = true;
    lastMessageTime = Date.now();
    
    const sendButton = document.getElementById('sendButton');
    const sendingIndicator = document.getElementById('sendingIndicator');
    const errorMessage = document.getElementById('errorMessage');
    
    // Update UI
    sendButton.disabled = true;
    sendButton.textContent = "Sending...";
    sendingIndicator.style.display = 'block';
    errorMessage.style.display = 'none';
    
    // Create unique message ID for this send
    const messageId = `user_${whatsapp}_${Date.now()}_${text.substring(0, 20)}`;
    sentMessageIds.add(messageId);
    pendingMessageId = messageId; // Set as pending message
    
    // Send message logic
    if (fileInput.files.length > 0) {
      uploadFile(function(fileInfo) {
        // Reset sending state
        resetSendingState();
        
        if (fileInfo) {
          console.log("üì§ Sending message with attachment:", fileInfo);
          
          // Show message immediately in chat
          const tempMsg = {
            id: messageId,
            sender: "user",
            whatsapp: whatsapp,
            text: text,
            attachment: fileInfo,
            timestamp: new Date().toISOString(),
            read: false
          };
          displayMessage(tempMsg);
          
          // Send ONLY ONE event to backend
          socket.emit("user_message", {
            whatsapp: whatsapp,
            userId: whatsapp,
            message: text,
            attachment: fileInfo
          });
          
        } else {
          // File upload failed, send text only if exists
          if (text) {
            const tempMsg = {
              id: messageId,
              sender: "user",
              whatsapp: whatsapp,
              text: text,
              timestamp: new Date().toISOString(),
              read: false
            };
            displayMessage(tempMsg);
            
            socket.emit("user_message", {
              whatsapp: whatsapp,
              userId: whatsapp,
              message: text
            });
          }
        }
        
        // Clear inputs
        document.getElementById("messageInput").value = "";
        fileInput.value = "";
        document.getElementById("filePreview").innerHTML = "";
      });
    } else {
      // No file, just send text
      console.log("üì§ Sending text message:", text);
      
      // Show message immediately in chat
      const tempMsg = {
        id: messageId,
        sender: "user",
        whatsapp: whatsapp,
        text: text,
        timestamp: new Date().toISOString(),
        read: false
      };
      displayMessage(tempMsg);
      
      // Send ONLY ONE event to backend
      socket.emit("user_message", {
        whatsapp: whatsapp,
        userId: whatsapp,
        message: text
      });
      
      // Reset sending state after a short delay
      setTimeout(() => {
        resetSendingState();
        document.getElementById("messageInput").value = "";
      }, 500);
    }
  }
  
  // Helper function to reset sending state
  function resetSendingState() {
    isSending = false;
    
    // Remove cooldown after 1 second
    setTimeout(() => {
      sendCooldown = false;
    }, 1000);
    
    const sendButton = document.getElementById('sendButton');
    const sendingIndicator = document.getElementById('sendingIndicator');
    
    sendButton.disabled = false;
    sendButton.textContent = "Send";
    sendingIndicator.style.display = 'none';
  }
  
  // Helper function to show error
  function showError(message) {
    const errorMessage = document.getElementById('errorMessage');
    errorMessage.textContent = message;
    errorMessage.style.display = 'block';
    
    // Hide error after 3 seconds
    setTimeout(() => {
      errorMessage.style.display = 'none';
    }, 3000);
  }

  // ===== KEYBOARD EVENT HANDLING =====
  let enterKeyCooldown = false;
  document.getElementById("messageInput").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      // Prevent default to avoid form submission
      e.preventDefault();
      
      // Prevent multiple Enter key triggers
      if (enterKeyCooldown) {
        console.log("Enter key cooldown active");
        return;
      }
      
      enterKeyCooldown = true;
      sendMessage();
      
      // Reset cooldown after 1 second
      setTimeout(() => {
        enterKeyCooldown = false;
      }, 1000);
    }
  });

  // ===== CLEANUP ON PAGE UNLOAD =====
  window.addEventListener('beforeunload', function() {
    if (socket) {
      socket.disconnect();
    }
  });
</script>
</body>
</html>