<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Agent Chat Panel</title>
  <style>
    body { font-family: Arial; margin: 20px; background: #f5f5f5; }
    #users { margin-bottom: 10px; width: 300px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
    #messages { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; margin-bottom: 10px; background: white; border-radius: 4px; }
    input, button, select { padding: 8px; font-size: 14px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; }
    button { background: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { opacity: 0.9; }
    
    /* Message styles */
    .message-container {
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      max-width: 80%;
      word-wrap: break-word;
    }
    
    .user-message { 
      background-color: #e3f2fd; 
      margin-right: auto;
      margin-left: 0;
      border-left: 4px solid #2196F3;
    }
    
    .agent-message { 
      background-color: #dcedc8; 
      margin-left: auto;
      margin-right: 0;
      border-right: 4px solid #4CAF50;
    }
    
    .unread-message {
      background-color: #fff8e1 !important;
      border: 2px solid #ff9800;
      font-weight: bold;
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 12px;
      color: #666;
    }
    
    .message-time {
      font-size: 11px;
      color: #666;
    }
    
    .unread-count {
      background-color: #f44336;
      color: white;
      border-radius: 50%;
      padding: 2px 8px;
      font-size: 12px;
      margin-left: 5px;
    }
    
    .info-message { 
      background-color: #f5f5f5; 
      color: #666; 
      font-style: italic; 
      text-align: center;
      border: 1px dashed #ddd;
    }
    .system-message { 
      background-color: #ffecb3; 
      color: #333; 
      font-style: italic; 
      text-align: center;
      border: 1px solid #ffd54f;
    }
    
    /* Password overlay */
    #passwordOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    #passwordContainer {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    
    #passwordContainer h2 {
      margin-top: 0;
      color: #333;
      margin-bottom: 20px;
    }
    
    #agentNameInput, #passwordInput {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    #passwordError {
      color: #d32f2f;
      margin: 10px 0;
      min-height: 20px;
    }
    
    #chatContainer {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    #agentInfo {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    #agentStatus {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .status-online { background-color: #00e676; }
    .status-offline { background-color: #f44336; }
    
    #restrictions {
      background: #fff3cd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #ffeaa7;
      font-size: 13px;
    }
    
    .login-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .logout-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
  </style>
</head>
<body>

<!-- Password overlay -->
<div id="passwordOverlay">
  <div id="passwordContainer">
    <h2>üë§ Agent Login</h2>
    <p>Enter your agent credentials:</p>
    <input type="text" id="agentNameInput" placeholder="Agent Name" autocomplete="off">
    <input type="password" id="passwordInput" placeholder="Password" autocomplete="off">
    <div id="passwordError"></div>
    <button onclick="loginAgent()" class="login-btn">
      üîê Login as Agent
    </button>
    <div style="margin-top: 15px; font-size: 12px; color: #666;">
      <em>Contact super admin for credentials</em>
    </div>
  </div>
</div>

<!-- Main chat container (hidden until authenticated) -->
<div id="chatContainer">
  <div id="agentInfo">
    <div>
      <span id="agentStatus" class="status-online"></span>
      <strong>Agent:</strong> <span id="currentAgentName"></span> | 
      <strong>Status:</strong> <span id="currentAgentStatus">Online</span>
    </div>
    <button onclick="logoutAgent()" class="logout-btn">
      üö™ Logout
    </button>
  </div>
  
  <div id="restrictions" style="display: none;">
    <strong>‚ö† Restrictions:</strong> <span id="restrictionText"></span>
  </div>
  
  <h3>üí¨ Agent Chat Panel</h3>

  <div style="margin-bottom: 20px;">
    <label><strong>Select User (WhatsApp number):</strong></label>
    <select id="users">
      <option value="">-- Select a user --</option>
    </select>
    <span id="userCount" style="margin-left: 10px; color: #666; font-size: 13px;"></span>
    <button onclick="refreshUsers()" style="margin-left: 10px; padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
      üîÑ Refresh
    </button>
  </div>

  <div id="messages"></div>

  <div style="margin-top: 20px;">
    <input id="messageInput" placeholder="Type your reply..." style="width: 70%; padding: 10px;">
    <button onclick="sendMessage()" style="padding: 10px 20px; background: #4CAF50;">üì§ Send</button>
    <button onclick="clearChat()" style="background: #ff9800; color: white; padding: 10px 20px;">üóëÔ∏è Clear Chat</button>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  // Agent state
  let currentAgent = null;
  let isAuthenticated = false;
  let agentRestrictions = {};
  
  // Chat variables
  let socket;
  let usersDropdown;
  let messagesDiv;
  let selectedUser = "";
  let allUsers = new Set();
  const unreadCounts = new Map();
  
  // Server URL - MAKE SURE THIS MATCHES YOUR SERVER
  const SERVER_URL = "https://chat-backend-p2b9.onrender.com";
  
  // DOM elements
  const passwordOverlay = document.getElementById('passwordOverlay');
  const chatContainer = document.getElementById('chatContainer');
  const agentNameInput = document.getElementById('agentNameInput');
  const passwordInput = document.getElementById('passwordInput');
  const passwordError = document.getElementById('passwordError');
  const currentAgentNameSpan = document.getElementById('currentAgentName');
  const restrictionsDiv = document.getElementById('restrictions');
  const restrictionTextSpan = document.getElementById('restrictionText');
  
  // Format time function
  function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString([], { 
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  function updateUnreadCount(whatsapp) {
    const count = unreadCounts.get(whatsapp) || 0;
    unreadCounts.set(whatsapp, count + 1);
    
    const option = document.getElementById(`user-${whatsapp}`);
    if (option) {
      const newCount = unreadCounts.get(whatsapp);
      option.innerHTML = `${whatsapp} ${newCount > 0 ? `<span class="unread-count">${newCount}</span>` : ''}`;
    }
  }
  
  function resetUnreadCount(whatsapp) {
    unreadCounts.set(whatsapp, 0);
    const option = document.getElementById(`user-${whatsapp}`);
    if (option) {
      option.innerHTML = whatsapp;
    }
  }
  
  // Check saved authentication
  function checkSavedAuth() {
    const savedAgent = sessionStorage.getItem('agentData');
    if (savedAgent) {
      try {
        const agentData = JSON.parse(savedAgent);
        console.log("Found saved agent:", agentData.name);
        loginSuccess(agentData);
      } catch (e) {
        console.error("Error parsing saved agent:", e);
        sessionStorage.removeItem('agentData');
      }
    }
  }
  
  // Initialize socket connection
  function initializeSocket() {
    console.log("Connecting to server:", SERVER_URL);
    socket = io(SERVER_URL, {
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionAttempts: 5,
      reconnectionDelay: 1000
    });
    
    // Connection events
    socket.on('connect', () => {
      console.log("‚úÖ Socket connected with ID:", socket.id);
      passwordError.textContent = '';
    });
    
    socket.on('connect_error', (error) => {
      console.error("‚ùå Connection error:", error);
      passwordError.textContent = 'Connection failed. Retrying...';
    });
    
    socket.on('disconnect', (reason) => {
      console.log("üîå Disconnected:", reason);
      if (currentAgent) {
        addSystemMessage("Disconnected from server. Reconnecting...");
      }
    });
  }
  
  // Agent login
  function loginAgent() {
    const agentName = agentNameInput.value.trim();
    const password = passwordInput.value.trim();
    
    if (!agentName || !password) {
      passwordError.textContent = 'Please enter both agent name and password';
      return;
    }
    
    passwordError.textContent = 'Connecting...';
    
    // Initialize socket if not already
    if (!socket || !socket.connected) {
      initializeSocket();
    }
    
    // Wait for connection
    if (socket.connected) {
      performLogin(agentName, password);
    } else {
      socket.once('connect', () => {
        performLogin(agentName, password);
      });
      
      setTimeout(() => {
        if (!isAuthenticated && passwordError.textContent.includes('Connecting')) {
          passwordError.textContent = 'Connection timeout. Please try again.';
        }
      }, 5000);
    }
  }
  
  function performLogin(agentName, password) {
    console.log("Attempting login for:", agentName);
    
    socket.emit('agent_login', { 
      agentName, 
      password,
      socketId: socket.id,
      timestamp: new Date().toISOString()
    });
    
    // Listen for login response
    socket.once('agent_login_response', (response) => {
      console.log("Login response:", response);
      if (response.success) {
        currentAgent = {
          name: agentName,
          id: response.agentId,
          socketId: socket.id,
          restrictions: response.restrictions || {}
        };
        
        // Save to session storage
        sessionStorage.setItem('agentData', JSON.stringify(currentAgent));
        
        // Show success and initialize chat
        loginSuccess(currentAgent);
      } else {
        passwordError.textContent = response.message || 'Login failed. Check credentials.';
        if (response.reason === 'agent_not_found') {
          passwordError.textContent += ' Agent does not exist.';
        }
      }
    });
  }
  
  function loginSuccess(agentData) {
    console.log("Login successful for:", agentData.name);
    isAuthenticated = true;
    currentAgent = agentData;
    agentRestrictions = agentData.restrictions || {};
    
    // Update UI
    currentAgentNameSpan.textContent = currentAgent.name;
    passwordOverlay.style.display = 'none';
    chatContainer.style.display = 'block';
    
    // Show restrictions if any
    updateRestrictionsDisplay();
    
    // Initialize chat listeners
    initializeChat();
    
    // Register agent as online
    socket.emit('agent_online', {
      agentId: currentAgent.id,
      agentName: currentAgent.name,
      socketId: socket.id,
      restrictions: agentRestrictions,
      timestamp: new Date().toISOString()
    });
    
    // Request assigned users
    socket.emit('get_assigned_users', { agentId: currentAgent.id });
    
    // Add welcome message
    addSystemMessage(`Welcome, ${currentAgent.name}! You are now online.`);
  }
  
  function updateRestrictionsDisplay() {
    const restrictions = [];
    
    if (agentRestrictions.maxUsers) {
      restrictions.push(`Max users: ${agentRestrictions.maxUsers}`);
    }
    
    if (agentRestrictions.canDelete === false) {
      restrictions.push('Cannot delete messages');
    }
    
    if (agentRestrictions.canClear === false) {
      restrictions.push('Cannot clear chats');
    }
    
    if (restrictions.length > 0) {
      restrictionTextSpan.textContent = restrictions.join(' | ');
      restrictionsDiv.style.display = 'block';
    } else {
      restrictionsDiv.style.display = 'none';
    }
  }
  
  function logoutAgent() {
    if (socket && currentAgent) {
      socket.emit('agent_offline', { 
        agentId: currentAgent.id,
        timestamp: new Date().toISOString()
      });
    }
    
    sessionStorage.removeItem('agentData');
    location.reload();
  }
  
  // Allow pressing Enter to submit login
  agentNameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') loginAgent();
  });
  
  passwordInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') loginAgent();
  });
  
  // Refresh users list
  function refreshUsers() {
    if (currentAgent && socket) {
      socket.emit('get_assigned_users', { agentId: currentAgent.id });
      addInfoMessage("Refreshing users list...");
    }
  }
  
  // Initialize chat system after authentication
  function initializeChat() {
    console.log("Initializing chat...");
    usersDropdown = document.getElementById("users");
    messagesDiv = document.getElementById("messages");
    
    // ===== CRITICAL: Listen for new messages =====
    socket.on("new_message", (msg) => {
      console.log("üì® New message received:", msg);
      
      // Check if this message is assigned to current agent
      const isAssignedToMe = !msg.assignedAgent || msg.assignedAgent === currentAgent.id;
      if (!isAssignedToMe) {
        console.log("Message not assigned to me, assigned to:", msg.assignedAgent);
        return;
      }
      
      // Add user to dropdown if not already there
      if (!allUsers.has(msg.whatsapp)) {
        // Check user limit restriction
        if (agentRestrictions.maxUsers && allUsers.size >= agentRestrictions.maxUsers) {
          addSystemMessage(`Cannot add more users. Limit: ${agentRestrictions.maxUsers}`);
          return;
        }
        
        allUsers.add(msg.whatsapp);
        addUserToDropdown(msg.whatsapp);
        updateUserCount();
        addInfoMessage(`New user added: ${msg.whatsapp}`);
      }

      // Display message if this user is selected
      if (msg.whatsapp === selectedUser) {
        appendMessage(msg);
        // Mark as read immediately if we're viewing this chat
        if (msg.sender === "user" && !msg.read) {
          socket.emit("mark_messages_read", { 
            whatsapp: msg.whatsapp,
            agentId: currentAgent.id,
            timestamp: new Date().toISOString()
          });
        }
      } else {
        // Highlight this user in dropdown
        highlightUserInDropdown(msg.whatsapp);
        if (msg.sender !== "agent") {
          addNotification(msg);
          // Update unread count
          updateUnreadCount(msg.whatsapp);
        }
      }
      
      // Notify super admin about active chat
      socket.emit('agent_received_message', {
        agentId: currentAgent.id,
        agentName: currentAgent.name,
        whatsapp: msg.whatsapp,
        message: msg.text,
        timestamp: new Date().toISOString()
      });
    });

    // Receive message history
    socket.on("message_history", (messages) => {
      console.log("Message history received:", messages.length, "messages");
      messagesDiv.innerHTML = "";
      
      if (messages && messages.length > 0) {
        messages.forEach(msg => appendMessage(msg));
      } else {
        addInfoMessage("No previous messages with this user. Start the conversation!");
      }
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
    
    // Receive assigned users
    socket.on('assigned_users', (users) => {
      console.log('Assigned users received:', users);
      // Clear and repopulate dropdown with assigned users
      usersDropdown.innerHTML = '<option value="">-- Select a user --</option>';
      allUsers.clear();
      unreadCounts.clear();
      
      if (users && users.length > 0) {
        users.forEach(whatsapp => {
          allUsers.add(whatsapp);
          addUserToDropdown(whatsapp);
        });
        addInfoMessage(`Loaded ${users.length} assigned users`);
      } else {
        addInfoMessage("No users assigned to you yet. Wait for incoming messages.");
      }
      
      updateUserCount();
    });
    
    // User assignment notification
    socket.on('user_assigned', (data) => {
      console.log('User assigned:', data);
      if (data.agentId === currentAgent.id) {
        if (!allUsers.has(data.whatsapp)) {
          allUsers.add(data.whatsapp);
          addUserToDropdown(data.whatsapp);
          updateUserCount();
          addSystemMessage(`‚úÖ New user assigned to you: ${data.whatsapp}`);
        }
      }
    });
    
    // User unassignment notification
    socket.on('user_unassigned', (data) => {
      console.log('User unassigned:', data);
      if (data.agentId === currentAgent.id) {
        removeUserFromDropdown(data.whatsapp);
        if (selectedUser === data.whatsapp) {
          selectedUser = "";
          messagesDiv.innerHTML = "";
          addSystemMessage("User was unassigned from you");
        }
      }
    });
    
    // Mark messages as read confirmation
    socket.on('messages_marked_read', (data) => {
      console.log('Messages marked as read for:', data.whatsapp);
      if (data.whatsapp === selectedUser) {
        // Update UI to show messages as read
        document.querySelectorAll('.unread-message').forEach(msg => {
          msg.classList.remove('unread-message');
          msg.classList.add('read-message');
        });
      }
    });
    
    // Connection status
    socket.on('agent_status_update', (data) => {
      if (data.agentId === currentAgent.id) {
        const statusSpan = document.getElementById('currentAgentStatus');
        statusSpan.textContent = data.status;
        const statusIndicator = document.getElementById('agentStatus');
        statusIndicator.className = data.status === 'online' ? 'status-online' : 'status-offline';
        
        if (data.status === 'offline') {
          addSystemMessage("You have been marked as offline. Reconnecting...");
        }
      }
    });

    // User selection
    usersDropdown.addEventListener("change", function() {
      const previousUser = selectedUser;
      selectedUser = this.value;
      console.log("Selected user changed to:", selectedUser);
      
      // Mark previous user's messages as read
      if (previousUser) {
        removeHighlightFromDropdown(previousUser);
        resetUnreadCount(previousUser);
      }
      
      // Clear messages and load history for selected user
      messagesDiv.innerHTML = "";
      if (selectedUser) {
        // Mark messages as read when opening chat
        socket.emit("get_messages", { 
          whatsapp: selectedUser,
          agentId: currentAgent.id,
          markAsRead: true 
        });
        addInfoMessage(`Now chatting with: ${selectedUser} - ${new Date().toLocaleTimeString()}`);
        resetUnreadCount(selectedUser);
        
        // Notify super admin about active chat
        socket.emit('agent_active_chat', {
          agentId: currentAgent.id,
          agentName: currentAgent.name,
          whatsapp: selectedUser,
          timestamp: new Date().toISOString()
        });
      }
    });
    
    // Send heartbeat to stay online
    setInterval(() => {
      if (socket && socket.connected && currentAgent) {
        socket.emit('agent_heartbeat', { 
          agentId: currentAgent.id,
          timestamp: new Date().toISOString()
        });
      }
    }, 25000);
    
    // Send message with Enter key
    document.getElementById("messageInput").addEventListener("keypress", function(e) {
      if (e.key === "Enter") sendMessage();
    });
    
    // Initialize with empty state
    addInfoMessage("Chat initialized. Select a user to start chatting.");
  }

  function addUserToDropdown(whatsapp) {
    const existing = Array.from(usersDropdown.options).find(opt => opt.value === whatsapp);
    if (!existing) {
      const option = document.createElement("option");
      option.value = whatsapp;
      option.textContent = whatsapp;
      option.id = `user-${whatsapp}`;
      usersDropdown.appendChild(option);
    }
  }
  
  function removeUserFromDropdown(whatsapp) {
    const option = document.getElementById(`user-${whatsapp}`);
    if (option) {
      option.remove();
      allUsers.delete(whatsapp);
      updateUserCount();
    }
  }
  
  function updateUserCount() {
    const countSpan = document.getElementById('userCount');
    countSpan.textContent = `(${allUsers.size} users)`;
  }

  function highlightUserInDropdown(whatsapp) {
    const option = document.getElementById(`user-${whatsapp}`);
    if (option && whatsapp !== selectedUser) {
      option.style.backgroundColor = '#ffeb3b';
      option.style.fontWeight = 'bold';
    }
  }

  function removeHighlightFromDropdown(whatsapp) {
    const option = document.getElementById(`user-${whatsapp}`);
    if (option) {
      option.style.backgroundColor = '';
      option.style.fontWeight = '';
    }
  }

  function appendMessage(msg) {
    const div = document.createElement("div");
    div.className = "message-container " + 
      (msg.sender === "user" ? "user-message" : "agent-message") +
      (msg.read ? " read-message" : " unread-message");
    
    const isAgent = msg.sender === 'agent';
    const senderName = isAgent ? (msg.agentName || 'You') : 'User';
    const displayText = msg.text || '(No text)';
    
    div.innerHTML = `
      <div class="message-header">
        <span><strong>${senderName}:</strong> ${displayText.substring(0, 50)}${displayText.length > 50 ? '...' : ''}</span>
        <span class="message-time" title="${formatDateTime(msg.timestamp)}">
          ${formatTime(msg.timestamp)}
        </span>
      </div>
      ${displayText.length > 50 ? `<div style="margin-top: 5px;">${displayText}</div>` : ''}
      ${msg.read ? `<small style="color: #4CAF50; display: block; margin-top: 5px;">‚úì Read</small>` : '<small style="color: #ff9800; display: block; margin-top: 5px;">‚óè Unread</small>'}
    `;
    
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    // Update unread count for this user in dropdown
    if (!msg.read && !isAgent) {
      updateUnreadCount(msg.whatsapp);
    }
  }

  function addInfoMessage(text) {
    const div = document.createElement("div");
    div.className = "message-container info-message";
    div.textContent = text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }
  
  function addSystemMessage(text) {
    const div = document.createElement("div");
    div.className = "message-container system-message";
    div.textContent = text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function addNotification(msg) {
    const div = document.createElement("div");
    div.className = "message-container info-message";
    div.innerHTML = `üì® <strong>New message from ${msg.whatsapp}</strong> at ${formatTime(msg.timestamp)}:<br>${msg.text.substring(0, 50)}${msg.text.length > 50 ? '...' : ''}`;
    div.style.cursor = 'pointer';
    div.style.border = '2px solid #4CAF50';
    div.onclick = () => {
      usersDropdown.value = msg.whatsapp;
      usersDropdown.dispatchEvent(new Event('change'));
    };
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function sendMessage() {
    if (!selectedUser) {
      alert("‚ö†Ô∏è Please select a user first!");
      return;
    }
    
    const text = document.getElementById("messageInput").value.trim();
    if (!text) return;

    const message = {
      whatsapp: selectedUser,
      sender: "agent",
      agentId: currentAgent.id,
      agentName: currentAgent.name,
      text: text,
      timestamp: new Date().toISOString()
    };

    console.log("Sending message as agent:", message);
    socket.emit("send_message", message);
    document.getElementById("messageInput").value = "";
    
    // Immediately show the message in the chat
    const msgWithTimestamp = {
      ...message,
      timestamp: new Date().toISOString(),
      read: true
    };
    appendMessage(msgWithTimestamp);
    
    // Notify super admin about agent response
    socket.emit('agent_sent_message', {
      agentId: currentAgent.id,
      agentName: currentAgent.name,
      whatsapp: selectedUser,
      message: text,
      timestamp: new Date().toISOString()
    });
  }
  
  function clearChat() {
    if (agentRestrictions.canClear === false) {
      addSystemMessage("‚ùå You are not allowed to clear chats");
      return;
    }
    
    if (selectedUser) {
      if (confirm("Are you sure you want to clear all messages in this chat?")) {
        socket.emit('clear_chat', {
          whatsapp: selectedUser,
          agentId: currentAgent.id,
          agentName: currentAgent.name
        });
        messagesDiv.innerHTML = '';
        addSystemMessage("üóëÔ∏è Chat cleared");
      }
    } else {
      alert("Select a user first");
    }
  }
  
  // Initialize on page load
  window.onload = function() {
    console.log("Agent panel loading...");
    initializeSocket();
    checkSavedAuth();
    agentNameInput.focus();
  };
</script>

</body>
</html>