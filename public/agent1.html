<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Dashboard</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body { font-family: Arial; display: flex; flex-direction: column; height: 100vh; margin: 0; background: #f9f9f9; }
header { padding: 10px; background: #222; color: #fff; display: flex; justify-content: space-between; align-items: center; }
#dashboard { display: flex; flex: 1; overflow: hidden; }
#activeMessages { flex: 0 0 250px; overflow-y: auto; border-right: 1px solid #ccc; padding: 10px; background: #fff; }
.user-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; border-radius: 4px; margin-bottom: 5px; }
.user-item:hover { background: #f0f0f0; }
.user-item.highlight { background: #ffd27f !important; }
#main { flex: 1; padding: 10px; }
.status { font-weight: bold; }
.empty-message { font-style: italic; color: #888; }
</style>
</head>
<body>
<header>
  <h2>Agent Dashboard</h2>
  <div>Connection: <span id="connectionStatus" class="status">Connecting...</span></div>
</header>

<div id="dashboard">
  <div id="activeMessages"><div class="empty-message">No active users</div></div>
  <div id="main">Select a user to open chat</div>
</div>

<script>
const agentId = "agent1";
const agentPassword = "agent1";

if (!localStorage.getItem("agentVerified")) window.location.href = "login.html";

const socket = io({ reconnection: true, reconnectionAttempts: Infinity, reconnectionDelay: 1000, reconnectionDelayMax: 5000 });

// ===== CONNECTION STATUS =====
const connectionStatus = document.getElementById("connectionStatus");

socket.on("connect", () => { 
  connectionStatus.textContent = "Connected"; 
  connectionStatus.style.color = "green"; 
  registerAgent(); 
  fetchActiveUsers(); 
});

socket.on("disconnect", () => { 
  connectionStatus.textContent = "Disconnected"; 
  connectionStatus.style.color = "red"; 
});

socket.on("reconnect_attempt", () => { 
  connectionStatus.textContent = "Reconnecting..."; 
  connectionStatus.style.color = "orange"; 
});

// ===== REGISTER AGENT =====
function registerAgent() {
  socket.emit("register_permanent_agent", { id: agentId, name: agentId, password: agentPassword });
}

// ===== FETCH ACTIVE USERS =====
let allUsers = [];
function fetchActiveUsers() {
  socket.emit("get_active_users_for_agent", { agentId });
}

// ===== UPDATE USER LIST =====
socket.on("active_users_list", (users) => {
  allUsers = users; // store all users
  const container = document.getElementById("activeMessages");
  container.innerHTML = "";
  if(users.length === 0){
    const empty = document.createElement("div");
    empty.textContent = "No active users";
    empty.className = "empty-message";
    container.appendChild(empty);
    return;
  }

  users.forEach(u => {
    const div = document.createElement("div");
    div.textContent = u.whatsapp;
    div.className = "user-item";

    div.addEventListener("click", () => {
      window.open(`agent-chat.html?whatsapp=${u.whatsapp}`, "_blank");
      div.classList.remove("highlight"); // remove highlight on click
    });

    container.appendChild(div);
  });
});

// refresh list every 4 seconds
fetchActiveUsers();
setInterval(fetchActiveUsers, 4000);

// ===== USER ROOM EVENTS =====
socket.on("new_message", handleMessageEvent);
socket.on("message_update", handleMessageEvent);
socket.on("chat_deleted", handleMessageEvent);
socket.on("chat_archived", handleMessageEvent);

function handleMessageEvent(msg){
  highlightUser(msg.whatsapp);
}

function highlightUser(whatsapp){
  const items = document.getElementsByClassName("user-item");
  for(let i of items){
    if(i.textContent === whatsapp){
      i.classList.add("highlight");
    }
  }
}
</script>
</body>
</html>
