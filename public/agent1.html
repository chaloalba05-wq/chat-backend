<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Agent Admin</title>
  <style>
    /* ===== RESET & BASE ===== */
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
      margin: 0; 
      background: #f5f5f5; 
      height: 100vh;
      height: -webkit-fill-available;
      overflow: hidden;
      touch-action: manipulation;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    
    /* ===== MAIN LAYOUT ===== */
    .container { 
      display: flex; 
      height: 100vh;
      height: -webkit-fill-available;
      width: 100%;
    }
    
    /* ===== CHAT LIST VIEW (INITIAL VIEW) ===== */
    .chat-list-view {
      width: 100%;
      display: flex;
      flex-direction: column;
      background: white;
    }
    
    /* ===== CHAT DETAIL VIEW (FULL SCREEN) - FIXED ===== */
    .chat-detail-view {
      position: fixed; /* CHANGED from absolute to fixed */
      top: 0;
      left: 0;
      right: 0;
      bottom: 0; /* ADDED: Use bottom instead of height */
      width: 100%;
      display: flex;
      flex-direction: column;
      background: #f8f9fa;
      z-index: 100;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .chat-detail-view.active {
      transform: translateX(0);
    }
    
    /* ===== BROADCAST VIEW ===== */
    .broadcast-view {
      width: 100%;
      display: flex;
      flex-direction: column;
      background: #f8f9fa;
    }
    
    /* ===== VIEW CONTROLS ===== */
    .view-controls {
      display: flex;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      padding: clamp(12px, 2vw, 15px) clamp(16px, 3vw, 20px);
      gap: 10px;
    }
    
    .view-tab {
      flex: 1;
      padding: clamp(10px, 2vw, 12px);
      border: none;
      border-radius: 8px;
      background: #f5f5f5;
      color: #666;
      font-size: clamp(13px, 1.8vw, 14px);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .view-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .view-tab:active {
      transform: scale(0.98);
    }
    
    .view-tab-icon {
      font-size: clamp(14px, 2.5vw, 16px);
    }
    
    /* ===== SIDEBAR - EXACTLY 1/4 OF SCREEN ===== */
    .sidebar { 
      width: 100%;
      height: 100%;
      background: white; 
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    
    .sidebar-header { 
      padding: clamp(16px, 3vw, 20px); 
      background: white;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
    }
    
    .agent-info {
      display: flex;
      align-items: center;
      gap: clamp(10px, 2vw, 12px);
      margin-bottom: clamp(12px, 2vw, 15px);
    }
    
    .agent-avatar {
      width: clamp(36px, 8vw, 40px);
      height: clamp(36px, 8vw, 40px);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: clamp(14px, 3vw, 16px);
      flex-shrink: 0;
    }
    
    .agent-details {
      flex: 1;
      min-width: 0;
    }
    
    .agent-name {
      font-weight: 600;
      color: #333;
      font-size: clamp(14px, 2vw, 15px);
      line-height: 1.2;
    }
    
    .agent-id {
      font-size: clamp(11px, 1.5vw, 12px);
      color: #666;
      margin-top: 2px;
      word-break: break-word;
    }
    
    .status-container {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .connection-dot {
      width: clamp(6px, 1.5vw, 8px);
      height: clamp(6px, 1.5vw, 8px);
      border-radius: 50%;
      display: inline-block;
      flex-shrink: 0;
    }
    
    .dot-connected { background-color: #4CAF50; }
    .dot-connecting { background-color: #FFC107; animation: pulse 1.5s infinite; }
    .dot-disconnected { background-color: #f44336; }
    .dot-error { background-color: #9C27B0; }
    
    .connection-status {
      font-size: clamp(11px, 1.5vw, 12px);
      color: #666;
      line-height: 1.2;
    }
    
    .mute-status {
      padding: clamp(3px, 1vw, 4px) clamp(8px, 2vw, 10px);
      border-radius: 12px;
      font-size: clamp(10px, 1.5vw, 11px);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-left: auto;
      white-space: nowrap;
    }
    
    .muted { background: #ffebee; color: #c62828; }
    .unmuted { background: #e8f5e9; color: #2e7d32; }
    
    /* ===== USER LIST ===== */
    .user-list {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      scrollbar-width: thin;
      scrollbar-color: #c1c1c1 #f1f1f1;
    }
    
    .user-list-title {
      padding: clamp(12px, 2vw, 15px) clamp(16px, 3vw, 20px) clamp(8px, 1.5vw, 10px);
      font-size: clamp(11px, 1.5vw, 12px);
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      background: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    .user-item {
      padding: clamp(14px, 2.5vw, 16px) clamp(16px, 3vw, 20px);
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: flex-start;
      gap: clamp(10px, 2vw, 12px);
      touch-action: manipulation;
    }
    
    .user-item:active {
      background: #f0f0f0;
    }
    
    .user-item:hover { background: #f9f9f9; }
    .user-item.active { background: #e8f0fe; }
    
    .user-avatar {
      width: clamp(32px, 6vw, 36px);
      height: clamp(32px, 6vw, 36px);
      background: #e0e0e0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-weight: 600;
      font-size: clamp(12px, 2vw, 14px);
      flex-shrink: 0;
    }
    
    .user-item.active .user-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .user-content {
      flex: 1;
      min-width: 0;
    }
    
    .user-name-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
      flex-wrap: wrap;
      gap: 4px;
    }
    
    .user-name {
      font-weight: 600;
      color: #333;
      font-size: clamp(13px, 1.8vw, 14px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70%;
    }
    
    .user-time {
      font-size: clamp(10px, 1.5vw, 11px);
      color: #999;
      flex-shrink: 0;
      white-space: nowrap;
    }
    
    .user-preview {
      font-size: clamp(12px, 1.8vw, 13px);
      color: #666;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      word-break: break-word;
    }
    
    /* ===== LOGIN SCREEN ===== */
    .login-screen { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex; 
      justify-content: center; 
      align-items: center;
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    
    .login-container {
      width: 100%;
      max-width: min(420px, 90vw);
      background: white;
      border-radius: clamp(12px, 3vw, 16px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      margin: auto;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }
    
    .login-header {
      padding: clamp(20px, 4vw, 30px);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      text-align: center;
      color: white;
      flex-shrink: 0;
    }
    
    .login-title {
      font-size: clamp(20px, 4vw, 24px);
      font-weight: 700;
      margin-bottom: clamp(6px, 1vw, 8px);
      line-height: 1.2;
    }
    
    .login-subtitle {
      font-size: clamp(13px, 2vw, 14px);
      opacity: 0.9;
    }
    
    .login-body {
      padding: clamp(20px, 4vw, 30px);
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      display: flex;
      flex-direction: column;
    }
    
    .agent-info-section {
      background: #f8f9fa;
      padding: clamp(16px, 3vw, 20px);
      border-radius: clamp(10px, 2vw, 12px);
      margin-bottom: clamp(20px, 3vw, 25px);
      border-left: 4px solid #667eea;
      flex-shrink: 0;
    }
    
    .agent-info-title {
      font-size: clamp(14px, 2vw, 15px);
      font-weight: 600;
      color: #333;
      margin-bottom: clamp(12px, 2vw, 15px);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .agent-details-grid {
      display: grid;
      grid-template-columns: repeat(1, 1fr);
      gap: clamp(10px, 2vw, 12px);
      margin-bottom: clamp(12px, 2vw, 15px);
    }
    
    @media (min-width: 480px) {
      .agent-details-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .agent-field {
      background: white;
      padding: clamp(10px, 2vw, 12px);
      border-radius: clamp(6px, 1.5vw, 8px);
      border: 1px solid #e0e0e0;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .field-label {
      font-size: clamp(11px, 1.5vw, 12px);
      color: #666;
      margin-bottom: clamp(3px, 0.5vw, 4px);
    }
    
    .field-value {
      font-size: clamp(13px, 1.8vw, 14px);
      font-weight: 600;
      color: #333;
      word-break: break-word;
      line-height: 1.3;
    }
    
    .file-info {
      background: #e8f5e9;
      padding: clamp(10px, 2vw, 12px);
      border-radius: clamp(6px, 1.5vw, 8px);
      font-size: clamp(12px, 1.8vw, 13px);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    
    .form-group {
      margin-bottom: clamp(16px, 2.5vw, 20px);
      flex-shrink: 0;
    }
    
    .form-label {
      display: block;
      font-size: clamp(13px, 1.8vw, 14px);
      color: #333;
      margin-bottom: clamp(6px, 1vw, 8px);
      font-weight: 500;
    }
    
    .form-input {
      width: 100%;
      padding: clamp(10px, 2vw, 12px) clamp(12px, 2.5vw, 16px);
      border: 2px solid #e0e0e0;
      border-radius: clamp(6px, 1.5vw, 8px);
      font-size: clamp(14px, 2vw, 16px);
      transition: border 0.2s;
      -webkit-appearance: none;
      appearance: none;
      min-height: 48px;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-error {
      color: #d32f2f;
      font-size: clamp(13px, 1.8vw, 14px);
      margin: clamp(8px, 1.5vw, 10px) 0;
      min-height: clamp(18px, 2vw, 20px);
      text-align: center;
      line-height: 1.3;
      flex-shrink: 0;
    }
    
    .login-button {
      width: 100%;
      padding: clamp(12px, 2.5vw, 14px);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: clamp(6px, 1.5vw, 8px);
      font-size: clamp(15px, 2.5vw, 16px);
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: clamp(44px, 8vh, 48px);
      flex-shrink: 0;
      margin-top: auto;
    }
    
    .login-button:active {
      transform: scale(0.98);
    }
    
    .login-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    .login-note {
      font-size: clamp(11px, 1.5vw, 12px);
      color: #666;
      text-align: center;
      margin-top: clamp(16px, 2.5vw, 20px);
      line-height: 1.5;
      flex-shrink: 0;
    }
    
    /* ================================================ */
    /* NEW CHAT BOX IMPLEMENTATION (Three-Part Layout)  */
    /* ================================================ */
    
    /* ===== CHAT DETAIL HEADER ===== */
    .chat-detail-header {
      padding: clamp(16px, 3vw, 20px) clamp(16px, 3vw, 24px);
      background: white;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: clamp(12px, 2vw, 15px);
      flex-shrink: 0;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .back-button {
      padding: 8px;
      background: #f5f5f5;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    
    .back-button:active {
      background: #e0e0e0;
    }
    
    .chat-detail-user-avatar {
      width: clamp(36px, 8vw, 44px);
      height: clamp(36px, 8vw, 44px);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: clamp(14px, 3vw, 16px);
      flex-shrink: 0;
    }
    
    .chat-detail-user-info {
      flex: 1;
      min-width: 0;
    }
    
    .chat-detail-user-name {
      font-weight: 600;
      color: #333;
      font-size: clamp(14px, 2vw, 16px);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-detail-user-number {
      font-size: clamp(12px, 1.8vw, 13px);
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* ===== BROADCAST HEADER ===== */
    .broadcast-header {
      padding: clamp(16px, 3vw, 20px) clamp(16px, 3vw, 24px);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      gap: clamp(12px, 2vw, 15px);
      flex-shrink: 0;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .broadcast-back-button {
      padding: 8px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: background 0.2s;
      flex-shrink: 0;
      color: white;
    }
    
    .broadcast-back-button:active {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .broadcast-title {
      flex: 1;
      min-width: 0;
    }
    
    .broadcast-title-main {
      font-weight: 600;
      font-size: clamp(16px, 2.5vw, 18px);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .broadcast-title-sub {
      font-size: clamp(12px, 1.8vw, 13px);
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* ===== CHAT WRAPPER - FIXED ===== */
    .chat-wrapper {
      display: flex;
      flex-direction: column;
      flex: 1; /* CHANGED: Use flex: 1 instead of height: 100% */
      min-height: 0;
      overflow: hidden;
    }
    
    /* ===== A. MESSAGES SECTION - FIXED ===== */
    .messages-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
      background: #f8f9fa;
    }
    
    /* Scrollable Messages Container - FIXED */
    #chatMessages,
    #broadcastMessages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      -webkit-overflow-scrolling: touch;
      display: flex; /* REMOVED: overscroll-behavior, will-change, transform, backface-visibility */
      flex-direction: column;
      min-height: 0;
      background: #f8f9fa;
    }
    
    /* Bottom padding for messages */
    #chatMessages::after,
    #broadcastMessages::after {
      content: '';
      flex: 0 0 16px;
    }
    
    /* Optimized scrollbar */
    #chatMessages::-webkit-scrollbar,
    #broadcastMessages::-webkit-scrollbar {
      width: 6px;
    }
    
    #chatMessages::-webkit-scrollbar-track,
    #broadcastMessages::-webkit-scrollbar-track {
      background: rgba(241, 241, 241, 0.5);
      border-radius: 3px;
    }
    
    #chatMessages::-webkit-scrollbar-thumb,
    #broadcastMessages::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.5);
      border-radius: 3px;
    }
    
    #chatMessages::-webkit-scrollbar-thumb:hover,
    #broadcastMessages::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.7);
    }
    
    /* Firefox scrollbar */
    #chatMessages,
    #broadcastMessages {
      scrollbar-width: thin;
      scrollbar-color: rgba(102, 126, 234, 0.5) rgba(241, 241, 241, 0.5);
    }
    
    /* ===== C. SCROLL TO BOTTOM BUTTON ===== */
    .scroll-to-bottom-btn {
      position: absolute;
      bottom: 100px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      z-index: 5;
      transition: all 0.3s ease;
      opacity: 0;
      visibility: hidden;
    }
    
    .scroll-to-bottom-btn.visible {
      opacity: 1;
      visibility: visible;
    }
    
    .scroll-to-bottom-btn:hover {
      background: #764ba2;
      transform: translateY(-2px);
    }
    
    /* ===== B. INPUT SECTION ===== */
    .input-section {
      flex-shrink: 0;
      background: white;
      border-top: 1px solid #e8e8e8;
      z-index: 10;
      position: sticky;
      bottom: 0;
      padding-bottom: max(16px, env(safe-area-inset-bottom));
    }
    
    .input-area-container {
      display: flex;
      flex-direction: column;
      width: 100%;
    }
    
    .upload-progress {
      width: 100%;
      background-color: #f3f3f3;
      border-radius: 10px;
      margin: 8px 16px;
      overflow: hidden;
      display: none;
      flex-shrink: 0;
    }
    
    .progress-bar {
      height: 6px;
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .file-preview {
      padding: 8px 16px;
      background: #f8f9fa;
      border-radius: 20px;
      font-size: 14px;
      color: #666;
      margin: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .sending-indicator,
    .error-message {
      padding: 8px 16px;
      font-size: 14px;
      text-align: center;
      display: none;
      flex-shrink: 0;
    }
    
    .sending-indicator {
      color: #666;
      background: #fff9c4;
    }
    
    .error-message {
      color: #d32f2f;
      background: #ffebee;
    }
    
    .input-area {
      padding: 16px;
      background: white;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    
    #messageInput {
      flex: 1;
      border: 2px solid #e8e8e8;
      margin: 0;
      font-size: clamp(14px, 4vw, 16px);
      padding: 14px 16px;
      min-height: 50px;
      max-height: 120px;
      border-radius: 25px;
      background: #f8f9fa;
      resize: none;
      overflow-y: auto;
    }
    
    .action-buttons {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .file-upload-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .file-upload-btn {
      background: transparent;
      color: #667eea;
      border: none;
      padding: 12px;
      cursor: pointer;
      font-size: 22px;
      border-radius: 50%;
      min-height: 50px;
      min-width: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .file-upload-btn:active {
      background: rgba(102, 126, 234, 0.1);
      transform: scale(0.95);
    }
    
    .file-upload-label {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
      display: none;
    }
    
    .send-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 14px 24px;
      border-radius: 25px;
      font-weight: 600;
      min-height: 50px;
      min-width: 80px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .send-btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }
    
    /* ===== MESSAGE BUBBLES (Updated to match user chat) ===== */
    .message-container {
      margin: 12px 0;
      padding: 14px 18px;
      border-radius: 20px;
      max-width: 85%;
      word-wrap: break-word;
      position: relative;
      animation: fadeIn 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      line-height: 1.4;
      flex-shrink: 0;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .agent-message {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: auto;
      margin-right: 8px;
      border-bottom-right-radius: 6px;
    }
    
    .user-message {
      background: white;
      border: 1px solid #e8e8e8;
      margin-right: auto;
      margin-left: 8px;
      border-bottom-left-radius: 6px;
    }
    
    /* Broadcast message styling */
    .broadcast-message {
      background: white;
      border: 1px solid #e8e8e8;
      margin-right: auto;
      margin-left: auto;
      max-width: 95%;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }
    
    .broadcast-message.agent-message {
      border-left-color: #4CAF50;
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    
    .message-sender {
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .agent-message .message-sender {
      color: rgba(255,255,255,0.95);
    }
    
    .user-message .message-sender,
    .broadcast-message .message-sender {
      color: #444;
    }
    
    .message-time {
      font-size: 0.75rem;
      opacity: 0.8;
      font-weight: 400;
    }
    
    .agent-message .message-time {
      color: rgba(255,255,255,0.8);
    }
    
    .user-message .message-time,
    .broadcast-message .message-time {
      color: #666;
    }
    
    .message-content {
      word-wrap: break-word;
      font-size: clamp(14px, 4vw, 16px);
      line-height: 1.5;
      overflow-wrap: break-word;
      word-break: break-word;
    }
    
    .broadcast-user-info {
      font-size: 0.8rem;
      color: #666;
      margin-top: 4px;
      padding: 4px 8px;
      background: #f8f9fa;
      border-radius: 8px;
      display: inline-block;
    }
    
    /* ===== FILE UPLOAD ===== */
    #fileInput {
      display: none;
    }
    
    /* ===== ATTACHMENTS ===== */
    .attachment {
      margin-top: 12px;
      padding: 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      border-left: 4px solid #4CAF50;
    }
    
    .user-message .attachment {
      background: #f8f9fa;
      border-left-color: #667eea;
    }
    
    .attachment a {
      color: #2196F3;
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .attachment a:hover {
      text-decoration: underline;
    }
    
    .attachment img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 8px;
      border: 1px solid #e0e0e0;
    }
    
    /* ===== TYPING INDICATOR ===== */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      background: white;
      border-radius: 20px;
      margin: 8px 0;
      width: fit-content;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background: #667eea;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-6px);
      }
    }
    
    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center;
      color: #999;
      padding: 40px 20px;
      font-size: 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 200px;
    }
    
    /* ===== UTILITIES ===== */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .hidden { display: none; }
    
    /* ===== MOBILE OPTIMIZATIONS ===== */
    @media (max-width: 768px) {
      .chat-detail-view {
        position: fixed;
      }
      
      .back-button {
        width: 36px;
        height: 36px;
        font-size: 16px;
      }
      
      .broadcast-back-button {
        width: 36px;
        height: 36px;
        font-size: 16px;
      }
      
      .input-area {
        padding: 12px;
        gap: 8px;
      }
      
      #messageInput {
        padding: 12px 16px;
        min-height: 46px;
      }
      
      .file-upload-btn,
      .send-btn {
        min-height: 46px;
        min-width: 46px;
      }
      
      .message-container {
        max-width: 90%;
        padding: 12px 16px;
        margin: 8px 0;
      }
      
      .broadcast-message {
        max-width: 92%;
      }
      
      .attachment img {
        max-height: 150px;
      }
      
      .scroll-to-bottom-btn {
        bottom: 90px;
        right: 16px;
        width: 36px;
        height: 36px;
        font-size: 16px;
      }
    }
    
    @media (max-width: 480px) {
      .chat-detail-header {
        padding: 12px 16px;
      }
      
      .broadcast-header {
        padding: 12px 16px;
      }
      
      .back-button {
        width: 36px;
        height: 36px;
        font-size: 16px;
      }
      
      .broadcast-back-button {
        width: 36px;
        height: 36px;
        font-size: 16px;
      }
      
      .chat-detail-user-avatar {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }
      
      .input-area {
        padding: 10px;
      }
      
      .message-container {
        max-width: 92%;
        padding: 10px 14px;
      }
      
      .broadcast-message {
        max-width: 94%;
      }
      
      .send-btn {
        min-width: 70px;
        padding: 12px 20px;
      }
      
      .file-upload-btn {
        font-size: 20px;
      }
      
      .scroll-to-bottom-btn {
        bottom: 85px;
        right: 12px;
        width: 32px;
        height: 32px;
        font-size: 14px;
      }
      
      .view-controls {
        padding: 10px 12px;
      }
      
      .view-tab {
        padding: 8px 10px;
        font-size: 12px;
      }
    }
    
    /* ===== SCROLLBAR STYLING ===== */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* ===== SAFE AREA SUPPORT ===== */
    @supports (padding: max(0px)) {
      body {
        padding-left: max(16px, env(safe-area-inset-left));
        padding-right: max(16px, env(safe-area-inset-right));
      }
      
      .sidebar-header, .chat-detail-header, .input-area, .broadcast-header {
        padding-left: max(clamp(16px, 3vw, 20px), env(safe-area-inset-left));
        padding-right: max(clamp(16px, 3vw, 20px), env(safe-area-inset-right));
      }
      
      .login-screen {
        padding-top: max(20px, env(safe-area-inset-top));
        padding-bottom: max(20px, env(safe-area-inset-bottom));
      }
    }
    
    /* ===== LOADING STATES ===== */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    /* ===== NOTIFICATION ===== */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      left: 20px;
      max-width: 400px;
      margin: 0 auto;
      padding: 12px 16px;
      border-radius: 8px;
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* ===== DATE SEPARATOR ===== */
    .date-separator {
      text-align: center;
      margin: clamp(16px, 3vw, 20px) 0;
      color: #666;
      font-size: clamp(11px, 1.5vw, 12px);
      font-weight: 500;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .date-separator::before,
    .date-separator::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #e0e0e0;
    }
    
    .date-separator span {
      padding: 4px 12px;
      background: #f8f9fa;
      border-radius: 12px;
      margin: 0 8px;
    }
    
    /* ===== CONNECTION STATUS ===== */
    .connection-status-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      z-index: 1000;
      display: none;
    }
    
    .connected {
      background: #4CAF50;
      color: white;
    }
    
    .disconnected {
      background: #f44336;
      color: white;
    }
    
    /* ===== CRITICAL FIX FOR SCROLLING ===== */
    html, body, #app {
      height: 100%;
      overflow: hidden;
    }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
  <div class="login-container">
    <div class="login-header">
      <div class="login-title">üîê Agent Login</div>
      <div class="login-subtitle">Permanent Agent Account</div>
    </div>
    
    <div class="login-body">
      <!-- Agent Information Section -->
      <div class="agent-info-section">
        <div class="agent-info-title">
          <span>üìã Agent Configuration</span>
        </div>
        
        <div class="file-info">
          <span>üìÅ</span>
          <span><strong>Agent File:</strong> <span id="agentFileName">Loading...</span></span>
        </div>
        
        <div class="agent-details-grid">
          <div class="agent-field">
            <div class="field-label">Agent ID</div>
            <div class="field-value" id="displayAgentId">Loading...</div>
          </div>
          <div class="agent-field">
            <div class="field-label">Agent Name</div>
            <div class="field-value" id="displayAgentName">Loading...</div>
          </div>
          <div class="agent-field">
            <div class="field-label">Status</div>
            <div id="agentStatus" class="mute-status unmuted">‚ö° Ready</div>
          </div>
          <div class="agent-field">
            <div class="field-label">Server</div>
            <div class="field-value">chat-backend-p2b9.onrender.com</div>
          </div>
        </div>
        
        <div class="note" style="font-size: 11px; color: #666; font-style: italic; margin-top: 10px;">
          This agent account is permanently created on the server.
        </div>
      </div>
      
      <!-- Login Form -->
      <div class="form-group">
        <label class="form-label">Agent ID</label>
        <input type="text" id="agentId" class="form-input" placeholder="Enter Agent ID">
      </div>
      
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="agentPass" class="form-input" placeholder="Enter Password">
      </div>
      
      <div id="loginError" class="login-error"></div>
      
      <button onclick="login()" id="loginButton" class="login-button">
        <span>üîì</span>
        <span>Login as Agent</span>
      </button>
      
      <div class="login-note">
        <div><strong>Note:</strong> This agent is automatically registered on the server.</div>
        <div style="margin-top: 5px;">Credentials are hardcoded for permanent access.</div>
      </div>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="app" class="container" style="display: none;">
  
  <!-- View Controls -->
  <div class="view-controls">
    <button class="view-tab active" onclick="switchView('broadcast')">
      <span class="view-tab-icon">üì°</span>
      <span>Broadcast Room</span>
    </button>
    <button class="view-tab" onclick="switchView('users')">
      <span class="view-tab-icon">üë•</span>
      <span>User Conversations</span>
    </button>
  </div>
  
  <!-- Broadcast View -->
  <div id="broadcastView" class="broadcast-view">
    <!-- Broadcast Header -->
    <div class="broadcast-header">
      <button class="broadcast-back-button" onclick="exitBroadcast()" style="display: none;">‚Üê</button>
      <div class="broadcast-title">
        <div class="broadcast-title-main">üì° Broadcast Room</div>
        <div class="broadcast-title-sub">All messages from all users</div>
      </div>
    </div>
    
    <!-- Broadcast Messages -->
    <div class="chat-wrapper">
      <div class="messages-section">
        <!-- Scroll to bottom button -->
        <button class="scroll-to-bottom-btn" id="broadcastScrollToBottomBtn" title="Scroll to bottom">
          ‚Üì
        </button>
        
        <!-- Scrollable broadcast messages -->
        <div id="broadcastMessages">
          <div class="empty-state">
            <div>Loading broadcast messages...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Chat List View (Initial View) -->
  <div id="chatListView" class="chat-list-view" style="display: none;">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <!-- Agent Info -->
        <div class="agent-info">
          <div class="agent-avatar" id="agentAvatar">A1</div>
          <div class="agent-details">
            <div class="agent-name" id="agentNameDisplay">Agent 1</div>
            <div class="agent-id">ID: <span id="agentIdDisplay">agent1</span></div>
          </div>
        </div>
        
        <!-- Connection Status -->
        <div class="status-container">
          <span class="connection-dot" id="connectionDot"></span>
          <span class="connection-status" id="connectionStatus">Connected</span>
          <span id="muteIndicator" class="mute-status unmuted" style="margin-left: auto;">‚ö° Active</span>
        </div>
      </div>
      
      <!-- User List -->
      <div class="user-list-title">Active Conversations</div>
      <div id="userList" class="user-list">
        <div class="empty-state">
          <div class="empty-state-icon">üí¨</div>
          <div class="empty-state-title">No conversations yet</div>
          <div class="empty-state-subtitle">Users will appear here when they send messages</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Chat Detail View (Full Screen) -->
  <div id="chatDetailView" class="chat-detail-view">
    <!-- Chat Header with Back Button -->
    <div class="chat-detail-header">
      <button class="back-button" onclick="exitChat()">‚Üê</button>
      <div class="chat-detail-user-avatar" id="chatDetailUserAvatar">U</div>
      <div class="chat-detail-user-info">
        <div class="chat-detail-user-name" id="currentUser">Select a user</div>
        <div class="chat-detail-user-number" id="whatsappNumber">Click on a user from the left</div>
      </div>
    </div>
    
    <!-- ================================================ -->
    <!-- NEW THREE-PART CHAT LAYOUT -->
    <!-- ================================================ -->
    <div class="chat-wrapper">
      <!-- A. Messages Section - Fixed box with scroll -->
      <div class="messages-section">
        <!-- Scroll to bottom button -->
        <button class="scroll-to-bottom-btn" id="scrollToBottomBtn" title="Scroll to bottom">
          ‚Üì
        </button>
        
        <!-- Scrollable messages box -->
        <div id="chatMessages">
          <div class="empty-state">
            <div>Select a conversation to view messages</div>
          </div>
        </div>
      </div>
      
      <!-- B. Input Section - Always fixed at bottom -->
      <div class="input-section">
        <div class="input-area-container">
          <div class="upload-progress" id="uploadProgress">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          
          <div class="file-preview" id="filePreview"></div>
          
          <div class="sending-indicator" id="sendingIndicator">Sending...</div>
          <div class="error-message" id="errorMessage">Please wait before sending another message</div>
          
          <div class="input-area">
            <textarea 
              id="messageInput" 
              placeholder="Type your message here..." 
              rows="1"
            ></textarea>
            <div class="action-buttons">
              <div class="file-upload-container">
                <button class="file-upload-btn" onclick="document.getElementById('fileInput').click()" title="Attach file">
                  üìé
                </button>
                <span class="file-upload-label">file upload</span>
              </div>
              <button class="send-btn" onclick="sendMessage()" id="sendButton">
                Send
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect()">
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  // ================================================
  // AGENT CONFIGURATION - FIXED VALUES
  // ================================================
  const AGENT_CONFIG = {
    id: "agent1", // FIXED: Always use "agent1" for consistent login
    name: "agent1", // Display name
    password: "agent1", // Login password
    filename: window.location.pathname.split('/').pop() || "agent1.html" // Auto-detect filename
  };
  
  let socket = null;
  let currentAgent = null;
  let selectedUser = null;
  let currentView = 'broadcast'; // 'broadcast' or 'users'
  let users = new Map();
  let broadcastMessages = new Map(); // Store broadcast messages with ID as key
  let broadcastDuplicateManager = {
    seenMessages: new Set(),
    
    isDuplicate(msg) {
      if (!msg.id) return false;
      
      const key = msg.id;
      const now = Date.now();
      
      // Clean old entries
      if (this.seenMessages.size > 1000) {
        this.seenMessages.clear();
      }
      
      if (this.seenMessages.has(key)) {
        console.log('üî¥ BROADCAST DUPLICATE DETECTED:', {
          id: key,
          timestamp: msg.timestamp,
          sender: msg.sender
        });
        return true;
      }
      
      this.seenMessages.add(key);
      return false;
    },
    
    clear() {
      this.seenMessages.clear();
    }
  };
  
  let isMuted = false;
  let autoReconnectAttempts = 0;
  const MAX_RECONNECT_ATTEMPTS = 20;
  const RECONNECT_DELAY = 2000;
  let reconnectTimeout = null;
  let selectedFile = null;
  let isMobile = window.innerWidth < 768;
  let isScrolledToBottom = true;
  let duplicateManager = {
    seenMessages: new Map(),
    
    isDuplicate(msg) {
      if (!msg.id) return false;
      
      const key = msg.id;
      const now = Date.now();
      
      // Clean old entries
      for (const [oldKey, timestamp] of this.seenMessages.entries()) {
        if (now - timestamp > 60000) {
          this.seenMessages.delete(oldKey);
        }
      }
      
      if (this.seenMessages.has(key)) {
        console.log('üî¥ DUPLICATE DETECTED:', {
          id: key,
          timestamp: msg.timestamp,
          sender: msg.sender
        });
        return true;
      }
      
      this.seenMessages.set(key, now);
      
      if (this.seenMessages.size > 1000) {
        const keys = Array.from(this.seenMessages.keys()).slice(0, 500);
        keys.forEach(k => this.seenMessages.delete(k));
      }
      
      return false;
    },
    
    clear() {
      this.seenMessages.clear();
    }
  };
  
  // ================================================
  // VIEW MANAGEMENT
  // ================================================
  function switchView(view) {
    currentView = view;
    
    // Update tab buttons
    document.querySelectorAll('.view-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    
    if (view === 'broadcast') {
      document.querySelector('.view-tab:nth-child(1)').classList.add('active');
      document.getElementById('broadcastView').style.display = 'flex';
      document.getElementById('chatListView').style.display = 'none';
      document.getElementById('chatDetailView').classList.remove('active');
      
      // Show broadcast messages
      showBroadcastMessages();
      
    } else if (view === 'users') {
      document.querySelector('.view-tab:nth-child(2)').classList.add('active');
      document.getElementById('broadcastView').style.display = 'none';
      document.getElementById('chatListView').style.display = 'flex';
      
      // Exit chat if open
      if (selectedUser) {
        document.getElementById('chatDetailView').classList.add('active');
      }
    }
    
    updateActivity();
  }
  
  function exitBroadcast() {
    // In broadcast view, just switch to users view
    switchView('users');
  }
  
  // ================================================
  // SCROLL MANAGEMENT FUNCTIONS - FIXED
  // ================================================
  function setupScrollListener() {
    const messagesDiv = document.getElementById("chatMessages");
    const scrollToBottomBtn = document.getElementById("scrollToBottomBtn");
    
    if (!messagesDiv || !scrollToBottomBtn) return;
    
    messagesDiv.addEventListener('scroll', function() {
      const scrollTop = messagesDiv.scrollTop;
      const scrollHeight = messagesDiv.scrollHeight;
      const clientHeight = messagesDiv.clientHeight;
      
      isScrolledToBottom = (scrollHeight - scrollTop - clientHeight) < 50;
      
      if (!isScrolledToBottom) {
        scrollToBottomBtn.classList.add('visible');
      } else {
        scrollToBottomBtn.classList.remove('visible');
      }
    }, { passive: true });
    
    scrollToBottomBtn.addEventListener('click', scrollToBottom);
  }
  
  function setupBroadcastScrollListener() {
    const broadcastDiv = document.getElementById("broadcastMessages");
    const scrollToBottomBtn = document.getElementById("broadcastScrollToBottomBtn");
    
    if (!broadcastDiv || !scrollToBottomBtn) return;
    
    broadcastDiv.addEventListener('scroll', function() {
      const scrollTop = broadcastDiv.scrollTop;
      const scrollHeight = broadcastDiv.scrollHeight;
      const clientHeight = broadcastDiv.clientHeight;
      
      const isBroadcastScrolledToBottom = (scrollHeight - scrollTop - clientHeight) < 50;
      
      if (!isBroadcastScrolledToBottom) {
        scrollToBottomBtn.classList.add('visible');
      } else {
        scrollToBottomBtn.classList.remove('visible');
      }
    }, { passive: true });
    
    scrollToBottomBtn.addEventListener('click', scrollBroadcastToBottom);
  }
  
  function scrollToBottom() {
    const messagesDiv = document.getElementById("chatMessages");
    if (messagesDiv) {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      isScrolledToBottom = true;
      document.getElementById("scrollToBottomBtn").classList.remove('visible');
    }
  }
  
  function scrollBroadcastToBottom() {
    const broadcastDiv = document.getElementById("broadcastMessages");
    if (broadcastDiv) {
      broadcastDiv.scrollTop = broadcastDiv.scrollHeight;
      document.getElementById("broadcastScrollToBottomBtn").classList.remove('visible');
    }
  }
  
  // ================================================
  // PERSISTENT CONNECTION SYSTEM
  // ================================================
  const CONNECTION_CONFIG = {
    heartbeatInterval: 25000,
    heartbeatTimeout: 10000,
    maxReconnectAttempts: 20,
    baseReconnectDelay: 2000,
    maxReconnectDelay: 30000,
    connectionCheckInterval: 5000,
    offlineBuffer: [],
    lastHeartbeat: null,
    heartbeatTimer: null,
    connectionCheckTimer: null,
    isManualDisconnect: false,
    connectionState: 'disconnected',
    pingPongEnabled: true,
    lastActivity: null
  };
  
  function initPersistentConnection() {
    console.log("üîÑ Initializing persistent connection system");
    
    clearTimers();
    
    CONNECTION_CONFIG.connectionState = 'disconnected';
    CONNECTION_CONFIG.isManualDisconnect = false;
    CONNECTION_CONFIG.lastActivity = Date.now();
    
    startConnectionMonitoring();
    
    window.addEventListener('beforeunload', handleBeforeUnload);
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    console.log("‚úÖ Persistent connection system initialized");
  }
  
  function clearTimers() {
    if (CONNECTION_CONFIG.heartbeatTimer) {
      clearInterval(CONNECTION_CONFIG.heartbeatTimer);
      CONNECTION_CONFIG.heartbeatTimer = null;
    }
    
    if (CONNECTION_CONFIG.connectionCheckTimer) {
      clearInterval(CONNECTION_CONFIG.connectionCheckTimer);
      CONNECTION_CONFIG.connectionCheckTimer = null;
    }
    
    if (reconnectTimeout) {
      clearTimeout(reconnectTimeout);
      reconnectTimeout = null;
    }
  }
  
  function startConnectionMonitoring() {
    CONNECTION_CONFIG.connectionCheckTimer = setInterval(() => {
      checkConnectionHealth();
    }, CONNECTION_CONFIG.connectionCheckInterval);
    
    console.log("üîç Started connection monitoring");
  }
  
  function checkConnectionHealth() {
    if (!socket || !currentAgent) return;
    
    const now = Date.now();
    const lastActivity = CONNECTION_CONFIG.lastActivity || now;
    const timeSinceLastActivity = now - lastActivity;
    
    if (socket.connected && timeSinceLastActivity > 60000) {
      console.log("üîÑ No activity detected, sending keep-alive ping");
      sendHeartbeat();
    }
    
    if (CONNECTION_CONFIG.lastHeartbeat && 
        now - CONNECTION_CONFIG.lastHeartbeat > CONNECTION_CONFIG.heartbeatTimeout + 5000) {
      console.warn("‚ö†Ô∏è Heartbeat response overdue, connection may be stale");
    }
  }
  
  function sendHeartbeat() {
    if (!socket || !socket.connected || !currentAgent) return;
    
    try {
      socket.emit('heartbeat', {
        agentId: currentAgent.id,
        timestamp: Date.now(),
        type: 'ping'
      });
      
      CONNECTION_CONFIG.lastHeartbeat = Date.now();
      console.log("üíì Sent heartbeat");
    } catch (error) {
      console.error("Failed to send heartbeat:", error);
    }
  }
  
  function startHeartbeat() {
    if (CONNECTION_CONFIG.heartbeatTimer) {
      clearInterval(CONNECTION_CONFIG.heartbeatTimer);
    }
    
    CONNECTION_CONFIG.heartbeatTimer = setInterval(() => {
      if (socket && socket.connected && currentAgent) {
        sendHeartbeat();
      }
    }, CONNECTION_CONFIG.heartbeatInterval);
    
    console.log("‚ù§Ô∏è Heartbeat system started");
  }
  
  function updateActivity() {
    CONNECTION_CONFIG.lastActivity = Date.now();
  }
  
  function handleBeforeUnload(event) {
    if (currentAgent && socket && socket.connected) {
      CONNECTION_CONFIG.isManualDisconnect = true;
      
      if (socket && socket.connected) {
        socket.emit('agent_disconnect', {
          agentId: currentAgent.id,
          timestamp: Date.now()
        });
      }
      
      setTimeout(() => {
        if (socket) socket.disconnect();
      }, 100);
    }
  }
  
  function handleVisibilityChange() {
    if (!document.hidden && currentAgent && (!socket || !socket.connected)) {
      console.log("üì± Page became visible, checking connection...");
      
      if (CONNECTION_CONFIG.connectionState === 'disconnected' && 
          !CONNECTION_CONFIG.isManualDisconnect) {
        console.log("üîÑ Attempting reconnection after page visibility restored");
        reconnect();
      }
    }
  }
  
  function reconnect() {
    if (CONNECTION_CONFIG.isManualDisconnect) {
      console.log("Reconnection cancelled - manual disconnect");
      return;
    }
    
    if (autoReconnectAttempts >= CONNECTION_CONFIG.maxReconnectAttempts) {
      console.log("Max reconnection attempts reached");
      updateConnectionStatus('error', 'Max reconnection attempts');
      showNotification('Connection failed after multiple attempts. Please refresh the page.', '#ffebee', '#c62828');
      return;
    }
    
    autoReconnectAttempts++;
    const delay = calculateReconnectDelay();
    
    console.log(`üîÑ Scheduling reconnection attempt ${autoReconnectAttempts} in ${delay}ms`);
    
    updateConnectionStatus('connecting', `Reconnecting (${autoReconnectAttempts}/${CONNECTION_CONFIG.maxReconnectAttempts})`);
    
    if (reconnectTimeout) {
      clearTimeout(reconnectTimeout);
    }
    
    reconnectTimeout = setTimeout(() => {
      console.log("üîÑ Attempting to reconnect...");
      performReconnection();
    }, delay);
  }
  
  function calculateReconnectDelay() {
    const baseDelay = CONNECTION_CONFIG.baseReconnectDelay;
    const maxDelay = CONNECTION_CONFIG.maxReconnectDelay;
    const exponentialDelay = baseDelay * Math.pow(1.5, autoReconnectAttempts - 1);
    const jitter = Math.random() * 1000;
    
    return Math.min(exponentialDelay + jitter, maxDelay);
  }
  
  function performReconnection() {
    CONNECTION_CONFIG.connectionState = 'connecting';
    
    if (socket) {
      socket.removeAllListeners();
      socket.disconnect();
    }
    
    socket = io("https://chat-backend-p2b9.onrender.com", {
      transports: ['websocket', 'polling'],
      reconnection: false,
      timeout: 30000,
      forceNew: true,
      multiplex: false,
      upgrade: true,
      rememberUpgrade: true,
      path: '/socket.io/',
      query: {
        agentId: AGENT_CONFIG.id,
        persistent: 'true',
        reconnectAttempt: autoReconnectAttempts
      }
    });
    
    setupSocketListeners();
    
    const connectionTimeout = setTimeout(() => {
      if (CONNECTION_CONFIG.connectionState === 'connecting') {
        console.log("Connection timeout");
        if (socket) {
          socket.disconnect();
        }
        scheduleReconnect();
      }
    }, 15000);
    
    socket.once('connect', () => {
      clearTimeout(connectionTimeout);
      CONNECTION_CONFIG.connectionState = 'connected';
      autoReconnectAttempts = 0;
      
      console.log("‚úÖ Reconnected to server, Socket ID:", socket.id);
      updateConnectionStatus('connected', 'Reconnected');
      showNotification('Connection restored successfully!', '#e8f5e9', '#2e7d32');
      
      socket.emit('agent_login', { 
        agentId: AGENT_CONFIG.id, 
        password: AGENT_CONFIG.password,
        reconnect: true
      });
    });
    
    socket.once('connect_error', (error) => {
      clearTimeout(connectionTimeout);
      console.error("Reconnection failed:", error);
      scheduleReconnect();
    });
  }
  
  function updateConnectionStatus(status, message = '') {
    const connectionDot = document.getElementById('connectionDot');
    const connectionStatus = document.getElementById('connectionStatus');
    
    if (!connectionDot || !connectionStatus) return;
    
    connectionDot.className = 'connection-dot';
    
    CONNECTION_CONFIG.connectionState = status;
    
    switch(status) {
      case 'connected':
        connectionDot.classList.add('dot-connected');
        connectionStatus.textContent = message || 'Connected';
        connectionStatus.style.color = "#4CAF50";
        break;
      case 'connecting':
        connectionDot.classList.add('dot-connecting');
        connectionStatus.textContent = message || 'Connecting...';
        connectionStatus.style.color = "#FFC107";
        break;
      case 'disconnected':
        connectionDot.classList.add('dot-disconnected');
        connectionStatus.textContent = message || 'Disconnected';
        connectionStatus.style.color = "#ff9800";
        break;
      case 'error':
        connectionDot.classList.add('dot-error');
        connectionStatus.textContent = message || 'Connection Error';
        connectionStatus.style.color = "#f44336";
        break;
    }
    
    updateActivity();
  }
  
  function scheduleReconnect() {
    reconnect();
  }
  
  // ================================================
  // INITIALIZATION
  // ================================================
  window.onload = function() {
    const fileName = getCurrentFileName();
    AGENT_CONFIG.filename = fileName;
    
    // Set agent details immediately
    document.getElementById('agentFileName').textContent = fileName;
    document.getElementById('displayAgentId').textContent = AGENT_CONFIG.id;
    document.getElementById('displayAgentName').textContent = AGENT_CONFIG.name;
    
    document.getElementById('agentId').value = AGENT_CONFIG.id;
    document.getElementById('agentPass').value = AGENT_CONFIG.password;
    
    // Setup textarea auto-resize
    const textarea = document.getElementById('messageInput');
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Register agent on server immediately
    registerAgentOnServer();
    
    initPersistentConnection();
    
    window.addEventListener('resize', handleResize);
    
    setTimeout(() => {
      document.getElementById('agentId').focus();
    }, 300);
  };
  
  function handleResize() {
    isMobile = window.innerWidth < 768;
  }
  
  function getCurrentFileName() {
    const path = window.location.pathname;
    return path.split('/').pop() || "agent1.html";
  }
  
  // ================================================
  // AGENT REGISTRATION FUNCTION
  // ================================================
  function registerAgentOnServer() {
    console.log("üîÑ Attempting to register agent on server...");
    
    // Create a temporary socket connection just for registration
    const tempSocket = io("https://chat-backend-p2b9.onrender.com", {
      transports: ['websocket', 'polling'],
      reconnection: false,
      timeout: 10000
    });
    
    const statusElement = document.getElementById('agentStatus');
    statusElement.textContent = "üîÑ Registering...";
    statusElement.className = "mute-status muted";
    
    tempSocket.on('connect', () => {
      console.log("‚úÖ Connected for registration, Socket ID:", tempSocket.id);
      
      tempSocket.emit('register_permanent_agent', {
        id: AGENT_CONFIG.id,
        name: AGENT_CONFIG.name,
        password: AGENT_CONFIG.password,
        filename: AGENT_CONFIG.filename
      });
      
      // Set a timeout to disconnect after registration attempt
      setTimeout(() => {
        if (tempSocket.connected) {
          tempSocket.disconnect();
        }
        console.log("‚úÖ Registration attempt completed");
      }, 3000);
    });
    
    tempSocket.on('agent_registered', (response) => {
      console.log("‚úÖ Agent registration successful:", response);
      statusElement.textContent = "‚úÖ Registered";
      statusElement.className = "mute-status unmuted";
      
      // Disconnect after successful registration
      setTimeout(() => {
        if (tempSocket.connected) {
          tempSocket.disconnect();
        }
      }, 1000);
    });
    
    tempSocket.on('agent_already_exists', (response) => {
      console.log("‚ÑπÔ∏è Agent already exists:", response);
      statusElement.textContent = "‚úÖ Already Registered";
      statusElement.className = "mute-status unmuted";
      
      setTimeout(() => {
        if (tempSocket.connected) {
          tempSocket.disconnect();
        }
      }, 1000);
    });
    
    tempSocket.on('connect_error', (error) => {
      console.error("‚ùå Registration connection error:", error);
      statusElement.textContent = "‚ö†Ô∏è Registration Failed";
      statusElement.className = "mute-status muted";
      
      // Try again after 5 seconds
      setTimeout(() => {
        console.log("üîÑ Retrying registration...");
        registerAgentOnServer();
      }, 5000);
    });
    
    tempSocket.on('disconnect', () => {
      console.log("üîå Registration socket disconnected");
    });
  }
  
  // ================================================
  // SOCKET SETUP
  // ================================================
  function setupSocketListeners() {
    socket.on('connect', () => {
      console.log("‚úÖ Connected to server, Socket ID:", socket.id);
      updateConnectionStatus('connected');
      autoReconnectAttempts = 0;
      CONNECTION_CONFIG.connectionState = 'connected';
      
      startHeartbeat();
      updateActivity();
      
      if (currentAgent) {
        console.log("üîÑ Re-authenticating after reconnection...");
        socket.emit('agent_login', { 
          agentId: AGENT_CONFIG.id, 
          password: AGENT_CONFIG.password,
          reconnect: true
        });
      }
    });
    
    socket.on('agent_login_response', (res) => {
      const loginButton = document.getElementById('loginButton');
      
      if (res.success) {
        console.log("‚úÖ Login successful:", res);
        currentAgent = { 
          id: AGENT_CONFIG.id, 
          name: res.name || AGENT_CONFIG.name,
          muted: res.muted || false
        };
        
        isMuted = res.muted || false;
        updateMuteStatus();
        
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        document.getElementById('agentNameDisplay').textContent = currentAgent.name;
        document.getElementById('agentIdDisplay').textContent = currentAgent.id;
        document.getElementById('agentAvatar').textContent = currentAgent.name.charAt(0).toUpperCase();
        
        // Load broadcast history first
        loadBroadcastHistory();
        loadAllConversations();
        showNotification('Connected to server successfully!', '#e8f5e9', '#2e7d32');
        
        // Setup broadcast scroll listener
        setTimeout(setupBroadcastScrollListener, 100);
        
      } else {
        console.error("‚ùå Login failed:", res.message);
        document.getElementById('loginError').textContent = res.message || 'Login failed';
        
        if (loginButton) {
          loginButton.disabled = false;
          loginButton.innerHTML = '<span>üîì</span><span>Login as Agent</span>';
        }
        
        // If agent not found, try to register again
        if (res.message && res.message.includes('not found')) {
          console.log("üîÑ Agent not found, attempting to re-register...");
          document.getElementById('loginError').textContent = 'Agent not registered. Attempting to register now...';
          registerAgentOnServer();
          
          // Enable login button after 3 seconds
          setTimeout(() => {
            if (loginButton) {
              loginButton.disabled = false;
              loginButton.innerHTML = '<span>üîì</span><span>Try Login Again</span>';
              document.getElementById('loginError').textContent = 'Registration attempt completed. Please try logging in again.';
            }
          }, 3000);
        }
        
        if (currentAgent) {
          setTimeout(() => reconnect(), 3000);
        }
      }
      
      updateActivity();
    });
    
    socket.on('connect_error', (error) => {
      console.error("‚ùå Connection error:", error);
      updateConnectionStatus('error', 'Connection error');
      document.getElementById('loginError').textContent = `Connection error: ${error.message}`;
      
      const loginButton = document.getElementById('loginButton');
      if (loginButton) {
        loginButton.disabled = false;
        loginButton.innerHTML = '<span>üîì</span><span>Login as Agent</span>';
      }
      
      if (currentAgent && !CONNECTION_CONFIG.isManualDisconnect) {
        scheduleReconnect();
      }
      
      updateActivity();
    });
    
    socket.on('disconnect', (reason) => {
      console.log("üîå Disconnected:", reason);
      updateConnectionStatus('disconnected');
      CONNECTION_CONFIG.connectionState = 'disconnected';
      
      if (CONNECTION_CONFIG.heartbeatTimer) {
        clearInterval(CONNECTION_CONFIG.heartbeatTimer);
        CONNECTION_CONFIG.heartbeatTimer = null;
      }
      
      if (reason !== 'io client disconnect' && 
          reason !== 'transport close' &&
          currentAgent && 
          !CONNECTION_CONFIG.isManualDisconnect) {
        
        showNotification('Connection lost. Reconnecting...', '#fff3e0', '#f57c00');
        scheduleReconnect();
      }
      
      if (CONNECTION_CONFIG.isManualDisconnect) {
        console.log("Manual disconnect, not reconnecting");
        updateConnectionStatus('disconnected', 'Disconnected by user');
      }
      
      updateActivity();
    });
    
    socket.on('heartbeat_response', (data) => {
      console.log("üíì Heartbeat response received");
      CONNECTION_CONFIG.lastHeartbeat = Date.now();
      updateActivity();
    });
    
    socket.on('pong', () => {
      updateActivity();
    });
    
    // ===== BROADCAST MESSAGE HANDLER =====
    socket.on('broadcast_message', (msg) => {
      console.log("üì° Received broadcast message:", msg);
      updateActivity();
      
      if (broadcastDuplicateManager.isDuplicate(msg)) {
        console.log("üõë Skipping duplicate broadcast message");
        return;
      }
      
      // Store broadcast message
      const messageId = msg.id || msg.broadcastId || Date.now().toString();
      broadcastMessages.set(messageId, msg);
      
      // Also handle as user message for user list
      const whatsapp = msg.whatsapp || 'unknown';
      
      if (whatsapp !== 'unknown' && !users.has(whatsapp)) {
        users.set(whatsapp, {
          name: whatsapp,
          lastMsg: msg.text || msg.message || '[Attachment]',
          time: msg.timestamp || new Date().toISOString(),
          messages: []
        });
      }
      
      if (whatsapp !== 'unknown') {
        const user = users.get(whatsapp);
        if (user) {
          user.lastMsg = msg.text || msg.message || '[Attachment]';
          user.time = msg.timestamp || new Date().toISOString();
          
          user.messages.push({
            text: msg.text || msg.message,
            time: msg.timestamp || new Date().toISOString(),
            sender: msg.sender || 'unknown',
            attachment: msg.attachment,
            agentId: msg.agentId,
            agentName: msg.agentName,
            id: msg.id
          });
        }
      }
      
      updateUserList();
      
      // Show in broadcast view if active
      if (currentView === 'broadcast') {
        addBroadcastMessage(msg);
      }
      
      // If we're in a user chat with this user, update their messages
      if (selectedUser === whatsapp) {
        showMessages();
      }
    });
    
    // ===== USER CHAT HISTORY HANDLER =====
    socket.on('user_chat_history', (msg) => {
      console.log("üì® Received user chat history:", msg);
      updateActivity();
      
      const whatsapp = msg.whatsapp || 'unknown';
      const user = users.get(whatsapp);
      
      if (user) {
        // Add to user's messages if not duplicate
        if (!duplicateManager.isDuplicate(msg)) {
          user.messages.push({
            text: msg.text || msg.message,
            time: msg.timestamp || new Date().toISOString(),
            sender: msg.sender || 'unknown',
            attachment: msg.attachment,
            agentId: msg.agentId,
            agentName: msg.agentName,
            id: msg.id
          });
          
          // Sort messages by time
          user.messages.sort((a, b) => new Date(a.time) - new Date(b.time));
          
          if (selectedUser === whatsapp) {
            showMessages();
          }
        }
      }
    });
    
    // ===== USER ROOM JOINED CONFIRMATION =====
    socket.on('user_room_joined', (data) => {
      console.log("‚úÖ Joined user room:", data);
      updateActivity();
      
      if (data.success) {
        showNotification(`Now monitoring ${data.whatsapp}`, '#e8f5e9', '#2e7d32');
      }
    });
    
    // ===== USER MESSAGE UPDATE HANDLER =====
    socket.on('user_message_update', (msg) => {
      console.log("üîÑ Received user message update:", msg);
      updateActivity();
      
      const whatsapp = msg.whatsapp || 'unknown';
      const user = users.get(whatsapp);
      
      if (user) {
        // Update user's last message
        user.lastMsg = msg.text || msg.message || '[Attachment]';
        user.time = msg.timestamp || new Date().toISOString();
        
        // Add to messages if not duplicate
        if (!duplicateManager.isDuplicate(msg)) {
          user.messages.push({
            text: msg.text || msg.message,
            time: msg.timestamp || new Date().toISOString(),
            sender: msg.sender || 'unknown',
            attachment: msg.attachment,
            agentId: msg.agentId,
            agentName: msg.agentName,
            id: msg.id
          });
        }
        
        updateUserList();
        
        if (selectedUser === whatsapp) {
          showMessages();
        }
      }
    });
    
    // ===== BROADCAST MESSAGE DELETED =====
    socket.on('broadcast_message_deleted', (data) => {
      console.log("üóëÔ∏è Broadcast message deleted:", data);
      updateActivity();
      
      // Remove from broadcast messages
      broadcastMessages.delete(data.messageId);
      
      // Update broadcast view
      if (currentView === 'broadcast') {
        showBroadcastMessages();
      }
    });
    
    socket.on('new_message', (msg) => {
      console.log("üì® Received message:", msg);
      updateActivity();
      
      if (duplicateManager.isDuplicate(msg)) {
        console.log("üõë Skipping duplicate message");
        return;
      }
      
      const whatsapp = msg.whatsapp || 'unknown';
      
      if (!users.has(whatsapp)) {
        users.set(whatsapp, {
          name: whatsapp,
          lastMsg: msg.text || msg.message || '[Attachment]',
          time: msg.timestamp || new Date().toISOString(),
          messages: []
        });
      }
      
      const user = users.get(whatsapp);
      user.lastMsg = msg.text || msg.message || '[Attachment]';
      user.time = msg.timestamp || new Date().toISOString();
      
      user.messages.push({
        text: msg.text || msg.message,
        time: msg.timestamp || new Date().toISOString(),
        sender: msg.sender || 'unknown',
        attachment: msg.attachment,
        agentId: msg.agentId,
        agentName: msg.agentName,
        id: msg.id
      });
      
      updateUserList();
      
      if (selectedUser === whatsapp) {
        showMessages();
      }
    });
    
    socket.on('forwarded_message', (data) => {
      updateActivity();
      if (data.type === 'user_message' && data.data) {
        const whatsapp = data.data.whatsapp || data.data.userId || 'User';
        addUserMessage(whatsapp, data.data.message, data.data);
      } else if (data.type === 'broadcast' && data.data) {
        addUserMessage('Super Admin', data.data.message, data);
      }
    });
    
    socket.on('message_deleted', (data) => {
      console.log("üóëÔ∏è Message deleted:", data);
      updateActivity();
      if (data.whatsapp && users.has(data.whatsapp)) {
        const user = users.get(data.whatsapp);
        const index = user.messages.findIndex(m => m.id === data.messageId);
        if (index > -1) {
          user.messages.splice(index, 1);
        }
      }
      
      if (selectedUser === data.whatsapp) {
        showMessages();
      }
    });
    
    socket.on('chat_deleted', (data) => {
      console.log("üóëÔ∏è Chat deleted:", data.whatsapp);
      updateActivity();
      if (users.has(data.whatsapp)) {
        users.delete(data.whatsapp);
      }
      updateUserList();
      
      if (selectedUser === data.whatsapp) {
        exitChat();
      }
    });
    
    socket.on('mute_status', (data) => {
      updateActivity();
      if (data.agentId === AGENT_CONFIG.id) {
        isMuted = data.muted;
        updateMuteStatus();
        
        showNotification(
          isMuted ? 'üîá Account muted by Super Admin' : 'üîä Account unmuted by Super Admin',
          isMuted ? '#ffcdd2' : '#c8e6c9',
          isMuted ? '#c62828' : '#2e7d32'
        );
      }
    });
    
    socket.on('message_history', (messages) => {
      updateActivity();
      if (selectedUser && messages) {
        const user = users.get(selectedUser);
        if (user) {
          // Filter duplicates from history
          user.messages = messages.filter(msg => !duplicateManager.isDuplicate(msg));
          showMessages();
        }
      }
    });
    
    socket.on('connection_stable', () => {
      console.log("‚úÖ Connection is stable");
      updateConnectionStatus('connected', 'Stable connection');
      updateActivity();
    });
    
    // ===== BROADCAST MESSAGES HISTORY =====
    socket.on('broadcast_messages_history', (messages) => {
      console.log("üì° Received broadcast messages history:", messages.length);
      updateActivity();
      
      broadcastDuplicateManager.clear();
      
      messages.forEach(msg => {
        if (!broadcastDuplicateManager.isDuplicate(msg)) {
          const messageId = msg.id || msg.broadcastId || Date.now().toString();
          broadcastMessages.set(messageId, msg);
        }
      });
      
      showBroadcastMessages();
    });
  }
  
  // ================================================
  // BROADCAST FUNCTIONS
  // ================================================
  function loadBroadcastHistory() {
    if (!socket) return;
    
    console.log("üì° Loading broadcast history...");
    updateActivity();
    
    socket.emit('get_broadcast_messages');
  }
  
  function addBroadcastMessage(msg) {
    const broadcastDiv = document.getElementById('broadcastMessages');
    if (!broadcastDiv) return;
    
    const messageElement = createBroadcastMessageElement(msg);
    broadcastDiv.appendChild(messageElement);
    
    // Scroll to bottom if we're near the bottom
    if (currentView === 'broadcast') {
      setTimeout(() => {
        const broadcastContainer = document.getElementById('broadcastMessages');
        const scrollHeight = broadcastContainer.scrollHeight;
        const scrollTop = broadcastContainer.scrollTop;
        const clientHeight = broadcastContainer.clientHeight;
        
        if (scrollHeight - scrollTop - clientHeight < 100) {
          scrollBroadcastToBottom();
        }
      }, 100);
    }
  }
  
  function createBroadcastMessageElement(msg) {
    const messageDiv = document.createElement("div");
    const isAgent = msg.sender === 'agent' || msg.sender === 'admin' || msg.agentId;
    
    messageDiv.className = "message-container broadcast-message " + (isAgent ? "agent-message" : "user-message");
    
    let content = "";
    if (msg.attachment) {
      content = formatAttachment(msg.attachment);
    }
    
    const senderName = isAgent 
      ? (msg.agentName || 'Agent') 
      : 'User';
    
    const whatsappInfo = msg.whatsapp && msg.whatsapp !== 'unknown' 
      ? `<div class="broadcast-user-info">WhatsApp: ${msg.whatsapp}</div>`
      : '';
    
    messageDiv.innerHTML = `
      <div class="message-header">
        <span class="message-sender">${senderName}</span>
        <span class="message-time" title="${formatDateTime(msg.timestamp)}">
          ${formatTime(msg.timestamp)}
        </span>
      </div>
      <div class="message-content">${msg.text || msg.message || ''}</div>
      ${whatsappInfo}
      ${content}
    `;
    
    messageDiv.dataset.messageId = msg.id || msg.broadcastId || 'no-id';
    
    return messageDiv;
  }
  
  function showBroadcastMessages() {
    const broadcastDiv = document.getElementById('broadcastMessages');
    if (!broadcastDiv) return;
    
    broadcastDiv.innerHTML = '';
    
    if (broadcastMessages.size === 0) {
      broadcastDiv.innerHTML = `
        <div class="empty-state">
          <div>No broadcast messages yet</div>
          <div style="font-size: 14px; color: #666; margin-top: 8px;">Messages from all users will appear here</div>
        </div>
      `;
      return;
    }
    
    // Sort messages by time
    const sortedMessages = Array.from(broadcastMessages.values())
      .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    // Group by date
    const groupedMessages = groupMessagesByDate(sortedMessages);
    
    Object.keys(groupedMessages).forEach(date => {
      if (Object.keys(groupedMessages).length > 1) {
        const dateDiv = document.createElement('div');
        dateDiv.className = 'date-separator';
        dateDiv.innerHTML = `<span>${formatDate(date)}</span>`;
        broadcastDiv.appendChild(dateDiv);
      }
      
      groupedMessages[date].forEach(msg => {
        const messageElement = createBroadcastMessageElement(msg);
        broadcastDiv.appendChild(messageElement);
      });
    });
    
    setTimeout(() => {
      scrollBroadcastToBottom();
    }, 100);
  }
  
  // ================================================
  // USER MANAGEMENT
  // ================================================
  function loadAllConversations() {
    if (!socket) return;
    
    console.log("üìã Loading all conversations...");
    updateActivity();
    
    socket.emit('get_existing_users');
    
    socket.once('existing_users', (usersList) => {
      console.log("üìã Loaded existing users:", usersList.length);
      updateActivity();
      
      users.clear();
      duplicateManager.clear();
      
      usersList.forEach(user => {
        if (user.whatsapp) {
          users.set(user.whatsapp, {
            name: user.whatsapp,
            lastMsg: user.lastMessage || 'No messages yet',
            time: user.lastMessageTime || new Date().toISOString(),
            messages: []
          });
        }
      });
      
      updateUserList();
      
      // Join each user's room to get their history
      users.forEach((user, whatsapp) => {
        socket.emit('get_messages', { 
          whatsapp: whatsapp, 
          agentId: AGENT_CONFIG.id,
          markAsRead: true 
        });
        
        // Also join the user room to get updates
        socket.emit('join_user_room', { whatsapp: whatsapp });
      });
    });
  }
  
  function addUserMessage(userId, message, data) {
    updateActivity();
    if (!users.has(userId)) {
      users.set(userId, {
        name: userId,
        lastMsg: message || '[Attachment]',
        time: data.timestamp || new Date().toISOString(),
        messages: []
      });
    }
    
    const user = users.get(userId);
    user.messages.push({
      text: message,
      time: data.timestamp || new Date().toISOString(),
      sender: data.sender || 'user',
      attachment: data.attachment,
      id: data.id
    });
    user.lastMsg = message || '[Attachment]';
    user.time = data.timestamp || new Date().toISOString();
    
    updateUserList();
    
    if (selectedUser === userId) {
      showMessages();
    }
  }
  
  function updateUserList() {
    const userList = document.getElementById('userList');
    updateActivity();
    
    const sortedUsers = Array.from(users.entries())
      .sort((a, b) => new Date(b[1].time) - new Date(a[1].time));
    
    userList.innerHTML = '';
    
    if (sortedUsers.length === 0) {
      userList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üí¨</div>
          <div class="empty-state-title">No conversations yet</div>
          <div class="empty-state-subtitle">Users will appear here when they send messages</div>
        </div>
      `;
      return;
    }
    
    sortedUsers.forEach(([userId, user]) => {
      const div = document.createElement('div');
      div.className = `user-item ${selectedUser === userId ? 'active' : ''}`;
      div.onclick = () => {
        selectUser(userId);
      };
      
      const time = formatTime(user.time);
      const userInitial = userId.charAt(0).toUpperCase();
      const preview = user.lastMsg.length > 50 ? user.lastMsg.substring(0, 50) + '...' : user.lastMsg;
      
      div.innerHTML = `
        <div class="user-avatar">${userInitial}</div>
        <div class="user-content">
          <div class="user-name-row">
            <div class="user-name">${user.name}</div>
            <div class="user-time">${time}</div>
          </div>
          <div class="user-preview">${preview}</div>
        </div>
      `;
      
      userList.appendChild(div);
    });
  }
  
  // ================================================
  // CHAT FUNCTIONS
  // ================================================
  function selectUser(userId) {
    selectedUser = userId;
    const user = users.get(userId);
    updateActivity();
    
    document.getElementById('currentUser').textContent = user.name;
    document.getElementById('whatsappNumber').textContent = `WhatsApp: ${userId}`;
    document.getElementById('chatDetailUserAvatar').textContent = userId.charAt(0).toUpperCase();
    
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendButton');
    
    if (!isMuted) {
      messageInput.disabled = false;
      sendBtn.disabled = false;
      messageInput.placeholder = "Type your message here...";
      messageInput.focus();
      
      if (socket) {
        socket.emit('join_user_room', { whatsapp: userId });
        
        socket.emit('get_messages', { 
          whatsapp: userId, 
          agentId: AGENT_CONFIG.id,
          markAsRead: true 
        });
      }
    }
    
    showMessages();
    document.getElementById('chatDetailView').classList.add('active');
    
    setTimeout(setupScrollListener, 100);
  }
  
  function exitChat() {
    selectedUser = null;
    
    document.getElementById('chatDetailView').classList.remove('active');
    
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendButton');
    messageInput.disabled = true;
    sendBtn.disabled = true;
    messageInput.value = '';
    messageInput.placeholder = "Select a conversation to start chatting";
    
    updateUserList();
    
    updateActivity();
  }
  
  function showMessages() {
    if (!selectedUser) return;
    updateActivity();
    
    const messagesDiv = document.getElementById('chatMessages');
    const user = users.get(selectedUser);
    
    messagesDiv.innerHTML = '';
    
    if (!user.messages || user.messages.length === 0) {
      messagesDiv.innerHTML = `
        <div class="empty-state">
          <div>No messages yet. Start the conversation!</div>
        </div>
      `;
      return;
    }
    
    const groupedMessages = groupMessagesByDate(user.messages);
    
    Object.keys(groupedMessages).forEach(date => {
      if (Object.keys(groupedMessages).length > 1) {
        const dateDiv = document.createElement('div');
        dateDiv.className = 'date-separator';
        dateDiv.innerHTML = `<span>${formatDate(date)}</span>`;
        messagesDiv.appendChild(dateDiv);
      }
      
      groupedMessages[date].forEach(msg => {
        const messageElement = createMessageElement(msg);
        messagesDiv.appendChild(messageElement);
      });
    });
    
    setTimeout(() => {
      scrollToBottom();
    }, 50);
  }
  
  function createMessageElement(msg) {
    const messageDiv = document.createElement("div");
    const isAgent = msg.sender === 'agent' || msg.sender === 'admin' || msg.agentId === AGENT_CONFIG.id;
    
    messageDiv.className = "message-container " + (isAgent ? "agent-message" : "user-message");
    
    let content = "";
    if (msg.attachment) {
      content = formatAttachment(msg.attachment);
    }
    
    const senderName = isAgent 
      ? (msg.agentName || currentAgent?.name || 'Agent') 
      : 'User';
    
    messageDiv.innerHTML = `
      <div class="message-header">
        <span class="message-sender">${senderName}</span>
        <span class="message-time" title="${formatDateTime(msg.time)}">
          ${formatTime(msg.time)}
        </span>
      </div>
      <div class="message-content">${msg.text || msg.message || ''}</div>
      ${content}
    `;
    
    messageDiv.dataset.messageId = msg.id || 'no-id';
    
    return messageDiv;
  }
  
  function formatAttachment(attachment) {
    if (!attachment) return '';
    
    const fileType = attachment.mimetype?.split('/')[0] || 'file';
    let icon = 'üìÑ';
    let preview = '';
    
    const fileUrl = attachment.url || attachment.path;
    const fileName = attachment.originalname || attachment.filename || 'file';
    const fileSize = attachment.size ? formatFileSize(attachment.size) : '';
    
    if (fileType === 'image') {
      icon = 'üñºÔ∏è';
      preview = `<img src="${fileUrl}" alt="${fileName}" loading="lazy">`;
    } else if (fileType === 'video') {
      icon = 'üé¨';
      preview = `<div><video src="${fileUrl}" controls preload="metadata"></video></div>`;
    } else if (fileType === 'audio') {
      icon = 'üéµ';
      preview = `<div><audio src="${fileUrl}" controls preload="metadata"></audio></div>`;
    } else if (attachment.mimetype?.includes('pdf')) {
      icon = 'üìï';
    }
    
    return `
      <div class="attachment">
        <a href="${fileUrl}" target="_blank" download="${fileName}">
          ${icon} ${fileName}
          ${fileSize ? `<span style="color: #666; font-size: 0.9em; margin-left: 8px;">(${fileSize})</span>` : ''}
        </a>
        ${preview}
      </div>
    `;
  }
  
  function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
  
  function groupMessagesByDate(messages) {
    const grouped = {};
    
    messages.forEach(msg => {
      const date = new Date(msg.time).toDateString();
      if (!grouped[date]) {
        grouped[date] = [];
      }
      grouped[date].push(msg);
    });
    
    return grouped;
  }
  
  // ================================================
  // FILE HANDLING
  // ================================================
  function handleFileSelect() {
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    
    if (fileInput.files.length > 0) {
      selectedFile = fileInput.files[0];
      filePreview.innerHTML = `üìé ${selectedFile.name} (${formatFileSize(selectedFile.size)})`;
      filePreview.style.display = 'flex';
    } else {
      selectedFile = null;
      filePreview.innerHTML = '';
      filePreview.style.display = 'none';
    }
    updateActivity();
  }
  
  function uploadFile(callback) {
    if (!selectedFile) {
      if (callback) callback(null);
      return;
    }
    
    const formData = new FormData();
    formData.append('file', selectedFile);
    
    const xhr = new XMLHttpRequest();
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    
    xhr.upload.addEventListener('progress', function(e) {
      if (e.lengthComputable) {
        const percentComplete = (e.loaded / e.total) * 100;
        progressBar.style.width = percentComplete + '%';
      }
    });
    
    xhr.addEventListener('load', function() {
      progressDiv.style.display = 'none';
      
      if (xhr.status === 200) {
        try {
          const response = JSON.parse(xhr.responseText);
          if (response.success && callback) {
            callback(response.file);
          } else {
            alert('Upload failed: ' + (response.message || 'Unknown error'));
            if (callback) callback(null);
          }
        } catch (e) {
          alert('Upload failed: Invalid response from server');
          if (callback) callback(null);
        }
      } else {
        alert('Upload failed with status: ' + xhr.status);
        if (callback) callback(null);
      }
      
      document.getElementById('fileInput').value = '';
      document.getElementById('filePreview').innerHTML = '';
      document.getElementById('filePreview').style.display = 'none';
      selectedFile = null;
    });
    
    xhr.addEventListener('error', function() {
      progressDiv.style.display = 'none';
      alert('Upload failed. Please check your connection.');
      if (callback) callback(null);
    });
    
    xhr.open('POST', '/upload');
    xhr.send(formData);
  }
  
  // ================================================
  // MESSAGE SENDING
  // ================================================
  function sendMessage() {
    if (isMuted) {
      alert("Your account is muted by Super Admin. You cannot send messages.");
      updateActivity();
      return;
    }
    
    if (!socket || !socket.connected) {
      alert("Not connected to server. Please wait for reconnection.");
      updateActivity();
      return;
    }
    
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    const fileInput = document.getElementById('fileInput');
    
    if (!text && !fileInput.files.length) {
      alert("Please enter a message or select a file");
      return;
    }
    
    updateActivity();
    
    if (fileInput.files.length > 0) {
      uploadFile(function(fileInfo) {
        if (fileInfo) {
          sendMessageToServer(text, fileInfo);
        } else {
          if (text) {
            sendMessageToServer(text);
          }
        }
        
        finishMessageSend();
        input.value = "";
        fileInput.value = "";
        document.getElementById("filePreview").innerHTML = "";
        document.getElementById("filePreview").style.display = 'none';
        
        input.style.height = 'auto';
        input.style.height = '50px';
      });
    } else {
      sendMessageToServer(text);
      
      setTimeout(() => {
        finishMessageSend();
        input.value = "";
        
        input.style.height = 'auto';
        input.style.height = '50px';
      }, 500);
    }
  }
  
  function sendMessageToServer(text, fileInfo = null) {
    if (!selectedUser) return;
    
    const messageData = {
      whatsapp: selectedUser,
      message: text,
      agentId: currentAgent.id,
      agentName: currentAgent.name,
      sender: 'agent'
    };
    
    if (fileInfo) {
      messageData.attachment = fileInfo;
    }
    
    // Add to local messages immediately
    const user = users.get(selectedUser);
    const tempMessage = {
      text: text,
      time: new Date().toISOString(),
      sender: 'agent',
      agentId: currentAgent.id,
      agentName: currentAgent.name,
      attachment: fileInfo
    };
    
    if (user) {
      user.messages.push(tempMessage);
      user.lastMsg = text || '[Attachment]';
      user.time = new Date().toISOString();
      showMessages();
    }
    
    // Send to server (will be saved to both broadcast room and user room)
    socket.emit('agent_message', messageData);
  }
  
  function finishMessageSend() {
    const sendButton = document.getElementById('sendButton');
    const sendingIndicator = document.getElementById('sendingIndicator');
    
    if (sendButton) sendButton.disabled = false;
    if (sendingIndicator) sendingIndicator.style.display = 'none';
    
    const messageInput = document.getElementById('messageInput');
    if (messageInput) messageInput.focus();
  }
  
  function showError(message) {
    const errorMessage = document.getElementById('errorMessage');
    if (errorMessage) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 3000);
    }
  }
  
  // ================================================
  // UTILITY FUNCTIONS
  // ================================================
  function login() {
    const id = document.getElementById('agentId').value.trim();
    const pass = document.getElementById('agentPass').value.trim();
    
    if (!id || !pass) {
      document.getElementById('loginError').textContent = 'Please enter both ID and password';
      return;
    }
    
    if (id !== AGENT_CONFIG.id) {
      document.getElementById('loginError').textContent = 'Invalid Agent ID';
      return;
    }
    
    if (pass !== AGENT_CONFIG.password) {
      document.getElementById('loginError').textContent = 'Invalid password';
      return;
    }
    
    const loginButton = document.getElementById('loginButton');
    loginButton.disabled = true;
    loginButton.innerHTML = '<span>üîÑ</span><span>Connecting...</span>';
    
    if (reconnectTimeout) {
      clearTimeout(reconnectTimeout);
      reconnectTimeout = null;
    }
    
    autoReconnectAttempts = 0;
    document.getElementById('loginError').textContent = '';
    CONNECTION_CONFIG.isManualDisconnect = false;
    
    updateConnectionStatus('connecting');
    
    socket = io("https://chat-backend-p2b9.onrender.com", {
      transports: ['websocket', 'polling'],
      reconnection: false,
      timeout: 30000,
      forceNew: true,
      multiplex: false,
      upgrade: true,
      rememberUpgrade: true,
      path: '/socket.io/',
      query: {
        agentId: AGENT_CONFIG.id,
        persistent: 'true'
      }
    });
    
    setupSocketListeners();
    
    socket.once('connect', () => {
      console.log("Socket connected, sending login credentials...");
      socket.emit('agent_login', { 
        agentId: AGENT_CONFIG.id, 
        password: AGENT_CONFIG.password,
        persistent: true
      });
    });
    
    const connectionTimeout = setTimeout(() => {
      if (!currentAgent && loginButton.disabled) {
        console.log("Connection timeout");
        document.getElementById('loginError').textContent = 'Connection timeout. Please try again.';
        loginButton.disabled = false;
        loginButton.innerHTML = '<span>üîì</span><span>Login as Agent</span>';
        updateConnectionStatus('error', 'Connection timeout');
        
        if (socket) {
          socket.disconnect();
        }
        
        scheduleReconnect();
      }
    }, 15000);
    
    socket.once('connect', () => {
      clearTimeout(connectionTimeout);
    });
    
    socket.once('connect_error', () => {
      clearTimeout(connectionTimeout);
    });
    
    updateActivity();
  }
  
  function updateMuteStatus() {
    const muteIndicator = document.getElementById('muteIndicator');
    const sendBtn = document.getElementById('sendButton');
    const messageInput = document.getElementById('messageInput');
    
    if (isMuted) {
      muteIndicator.textContent = "üîá Muted";
      muteIndicator.className = "mute-status muted";
      if (sendBtn) sendBtn.disabled = true;
      if (messageInput) {
        messageInput.disabled = true;
        messageInput.placeholder = "Account is muted by Super Admin";
      }
    } else {
      muteIndicator.textContent = "‚ö° Active";
      muteIndicator.className = "mute-status unmuted";
      if (sendBtn && selectedUser) sendBtn.disabled = false;
      if (messageInput && selectedUser) {
        messageInput.disabled = false;
        messageInput.placeholder = "Type your message here...";
      }
    }
    
    updateActivity();
  }
  
  function showNotification(message, bgColor, textColor) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.style.cssText = `
      background: ${bgColor}; 
      color: ${textColor}; 
      border: 1px solid ${textColor}33;
    `;
    notification.innerHTML = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
    updateActivity();
  }
  
  function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString([], { 
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  function formatDate(dateString) {
    const date = new Date(dateString);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) {
      return 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
      return 'Yesterday';
    } else {
      return date.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
    }
  }
  
  // ================================================
  // EVENT LISTENERS
  // ================================================
  document.getElementById('agentPass').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') login();
  });
  
  document.getElementById('messageInput').addEventListener('keypress', (e) => {
    updateActivity();
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  document.getElementById('messageInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
  });
  
  window.addEventListener('popstate', function() {
    updateActivity();
    if (selectedUser) {
      exitChat();
    }
  });
  
  document.addEventListener('touchmove', function(e) {
    if (e.scale !== 1) { e.preventDefault(); }
  }, { passive: false });
</script>
</body>
</html>