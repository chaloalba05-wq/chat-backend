<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Agent Admin</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
    .container { max-width: 800px; margin: 0 auto; }
    
    .login-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 10px;
      text-align: center;
      width: 90%;
      max-width: 400px;
    }
    
    #chatContainer {
      border: 1px solid #ccc;
      border-radius: 5px;
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
      background: white;
      margin: 10px 0;
    }
    
    .message {
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
    }
    
    .user-message { background: #f1f8e9; }
    .agent-message { background: #e3f2fd; }
    .super-message { background: #e8eaf6; }
    
    .status {
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 12px;
      display: inline-block;
    }
    
    .connected { background: #4CAF50; color: white; }
    .disconnected { background: #f44336; color: white; }
  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div id="loginOverlay" class="login-overlay">
    <div class="login-box">
      <h2>Agent Login</h2>
      <input type="text" id="agentIdInput" placeholder="Agent ID" 
             style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
      <input type="password" id="agentPassword" placeholder="Password" 
             style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
      <div id="loginError" style="color: #f44336; margin: 10px 0; min-height: 20px;"></div>
      <button onclick="loginAgent()" 
              style="width: 100%; padding: 12px; background: #1976d2; color: white; border: none; border-radius: 4px;">
        Login
      </button>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard" class="container" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div>
        <h1>Agent Dashboard</h1>
        <p id="agentInfo"></p>
        <span id="connectionStatus" class="status disconnected">Disconnected</span>
      </div>
      <button onclick="logout()" style="padding: 8px 15px; background: #f44336; color: white; border: none; border-radius: 4px;">
        Logout
      </button>
    </div>

    <!-- Muted Warning -->
    <div id="mutedWarning" style="background: #ffeb3b; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: none;">
      ‚ö†Ô∏è You are muted and will not receive user messages
    </div>

    <!-- Messages Container -->
    <div id="chatContainer"></div>

    <!-- Message Input -->
    <div style="display: flex; gap: 10px; margin: 10px 0;">
      <input type="text" id="messageInput" placeholder="Type message..." 
             style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
      <button id="sendBtn" onclick="sendMessage()" 
              style="padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 4px;">
        Send
      </button>
    </div>

    <!-- Activity Log -->
    <div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #ddd;">
      <h3>Activity Log</h3>
      <div id="activityLog" style="max-height: 150px; overflow-y: auto; margin-top: 10px;"></div>
    </div>
  </div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  let socket = null;
  let currentAgentId = null;
  let currentAgentName = null;
  let isMuted = false;
  let messages = [];

  // DOM Elements
  const loginOverlay = document.getElementById('loginOverlay');
  const dashboard = document.getElementById('dashboard');
  const agentIdInput = document.getElementById('agentIdInput');
  const agentPassword = document.getElementById('agentPassword');
  const loginError = document.getElementById('loginError');
  const agentInfo = document.getElementById('agentInfo');
  const chatContainer = document.getElementById('chatContainer');
  const messageInput = document.getElementById('messageInput');
  const activityLog = document.getElementById('activityLog');
  const connectionStatus = document.getElementById('connectionStatus');
  const mutedWarning = document.getElementById('mutedWarning');

  // Login function
  function loginAgent() {
    const agentId = agentIdInput.value.trim();
    const password = agentPassword.value.trim();
    
    if (!agentId || !password) {
      loginError.textContent = 'Please enter both ID and password';
      return;
    }

    loginError.textContent = 'Connecting...';

    // Connect to server
    socket = io("https://chat-backend-p2b9.onrender.com", {
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionAttempts: 3
    });

    socket.on('connect', () => {
      console.log('Connected to server');
      connectionStatus.textContent = 'Connected';
      connectionStatus.className = 'status connected';
      
      // Send login credentials
      socket.emit('agent_login', {
        agentId: agentId,
        password: password
      });
    });

    socket.on('agent_login_response', (response) => {
      if (response.success) {
        currentAgentId = agentId;
        currentAgentName = response.name;
        isMuted = response.muted || false;
        
        // Update UI
        agentInfo.textContent = `Logged in as: ${currentAgentName} (${currentAgentId})`;
        loginOverlay.style.display = 'none';
        dashboard.style.display = 'block';
        
        // Update muted status
        updateMutedStatus();
        logActivity('‚úÖ Login successful');
        
        // Set up message listeners
        setupMessageListeners();
      } else {
        loginError.textContent = response.message || 'Login failed';
        socket.disconnect();
      }
    });

    socket.on('connect_error', (error) => {
      loginError.textContent = `Connection error: ${error.message}`;
      connectionStatus.textContent = 'Connection Failed';
      connectionStatus.className = 'status disconnected';
    });

    socket.on('disconnect', () => {
      connectionStatus.textContent = 'Disconnected';
      connectionStatus.className = 'status disconnected';
      logActivity('üîå Disconnected from server');
    });
  }

  // Setup message listeners
  function setupMessageListeners() {
    // Listen for forwarded messages from users (via Super Admin)
    socket.on('forwarded_message', (data) => {
      if (data.type === 'user_message') {
        if (!isMuted) {
          addMessage(data.data.userId || 'User', data.data.message, 'user');
          logActivity(`üì© New message from user: ${data.data.message}`);
        }
      }
    });

    // Listen for messages from Super Admin
    socket.on('super_message', (data) => {
      addMessage('Super Admin', data.message, 'super');
      logActivity(`üì¢ Message from Super Admin: ${data.message}`);
    });

    // Listen for mute status updates
    socket.on('mute_status', (data) => {
      if (data.agentId === currentAgentId) {
        isMuted = data.muted;
        updateMutedStatus();
        logActivity(isMuted ? 'üîá You have been muted' : 'üîä You have been unmuted');
      }
    });
  }

  // Update muted status UI
  function updateMutedStatus() {
    if (isMuted) {
      mutedWarning.style.display = 'block';
    } else {
      mutedWarning.style.display = 'none';
    }
  }

  // Send message
  function sendMessage() {
    const message = messageInput.value.trim();
    if (!message || !socket.connected) return;

    // Add to local display
    addMessage(currentAgentName, message, 'agent');
    logActivity(`You: ${message}`);

    // Send to server
    socket.emit('agent_message', {
      agentId: currentAgentId,
      agentName: currentAgentName,
      message: message,
      timestamp: new Date().toISOString()
    });

    // Clear input
    messageInput.value = '';
    messageInput.focus();
  }

  // Add message to chat container
  function addMessage(sender, content, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    messageDiv.innerHTML = `
      <strong>${sender}:</strong> ${content}<br>
      <small>${new Date().toLocaleTimeString()}</small>
    `;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  // Log activity
  function logActivity(text) {
    const logEntry = document.createElement('div');
    logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
    activityLog.appendChild(logEntry);
    activityLog.scrollTop = activityLog.scrollHeight;
  }

  // Logout
  function logout() {
    if (socket) {
      socket.disconnect();
    }
    currentAgentId = null;
    currentAgentName = null;
    isMuted = false;
    messages = [];
    
    // Reset UI
    chatContainer.innerHTML = '';
    activityLog.innerHTML = '';
    agentIdInput.value = '';
    agentPassword.value = '';
    loginError.textContent = '';
    
    // Show login
    dashboard.style.display = 'none';
    loginOverlay.style.display = 'flex';
  }

  // Enter key support
  agentPassword.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') loginAgent();
  });

  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  // Auto-focus on login
  window.addEventListener('load', () => {
    agentIdInput.focus();
  });
</script>
</body>
</html>