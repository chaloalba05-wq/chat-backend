<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Dashboard</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body { font-family: Arial; display: flex; flex-direction: column; height: 100vh; margin: 0; background: #f9f9f9; }
header { padding: 10px; background: #222; color: #fff; display: flex; justify-content: space-between; align-items: center; }
#dashboard { display: flex; flex: 1; overflow: hidden; }
#activeMessages { flex: 0 0 250px; overflow-y: auto; border-right: 1px solid #ccc; padding: 10px; background: #fff; }
.user-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; border-radius: 4px; margin-bottom: 5px; }
.user-item:hover { background: #f0f0f0; }
.user-item.highlight { background: #ffd27f !important; }
#main { flex: 1; padding: 10px; }
.status { font-weight: bold; }
.empty-message { font-style: italic; color: #888; }
</style>
</head>
<body>
<header>
  <h2>Agent Dashboard</h2>
  <div>
    Connection: <span id="connectionStatus" class="status">Connecting...</span> | 
    Unread: <span id="unreadCount">0</span>
  </div>
</header>

<div id="dashboard">
  <div id="activeMessages"><div class="empty-message">No active users</div></div>
  <div id="main">Select a user to open chat</div>
</div>

<audio id="notificationSound" src="notification.mp3" preload="auto"></audio>

<script>
const agentId = "agent1";
const agentPassword = "agent1";

// Redirect to login page if not verified
if (!localStorage.getItem("agentVerified")) window.location.href = "login.html";

const socket = io({ reconnection: true, reconnectionAttempts: Infinity, reconnectionDelay: 1000, reconnectionDelayMax: 5000 });

// ===== CONNECTION STATUS =====
const connectionStatus = document.getElementById("connectionStatus");

socket.on("connect", () => { 
  connectionStatus.textContent = "Connected"; 
  connectionStatus.style.color = "green"; 
  registerAgent();
});

socket.on("disconnect", () => { 
  connectionStatus.textContent = "Disconnected"; 
  connectionStatus.style.color = "red"; 
});

socket.on("reconnect_attempt", () => { 
  connectionStatus.textContent = "Reconnecting..."; 
  connectionStatus.style.color = "orange"; 
});

// ===== REGISTER AND LOGIN AGENT =====
function registerAgent() {
  socket.emit("register_permanent_agent", { id: agentId, name: agentId, password: agentPassword });
  loginAgent();
}

function loginAgent() {
  socket.emit("agent_login", { agentId, password: agentPassword, persistent: true });
}

socket.on("agent_login_response", (res) => {
  if(res.success){
    console.log("Agent logged in successfully");
    fetchActiveUsers();
  } else {
    console.error("Agent login failed:", res.message);
  }
});

// ===== FETCH ACTIVE USERS =====
let allUsers = [];
function fetchActiveUsers() {
  socket.emit("get_existing_users"); // server emits "existing_users"
}

socket.on("existing_users", (users) => {
  updateUserList(users.map(u => ({ whatsapp: u.whatsapp })));
});

// ===== PER-MESSAGE UNREAD TRACKING =====
let unreadMessages = JSON.parse(localStorage.getItem("unreadMessages")) || {}; 
function saveUnreadMessages() {
  localStorage.setItem("unreadMessages", JSON.stringify(unreadMessages));
}

function updateUnreadCount() {
  let count = 0;
  for (const user in unreadMessages) {
    count += Object.keys(unreadMessages[user]).length;
  }
  document.getElementById("unreadCount").textContent = count;
}

// ===== UPDATE USER LIST =====
function updateUserList(users){
  allUsers = users;
  const container = document.getElementById("activeMessages");
  container.innerHTML = "";

  if(users.length === 0){
    const empty = document.createElement("div");
    empty.textContent = "No active users";
    empty.className = "empty-message";
    container.appendChild(empty);
    updateUnreadCount();
    return;
  }

  users.forEach(u => {
    const div = document.createElement("div");
    div.textContent = u.whatsapp;
    div.className = "user-item";

    if(unreadMessages[u.whatsapp] && Object.keys(unreadMessages[u.whatsapp]).length > 0){
      div.classList.add("highlight");
    }

    div.addEventListener("click", () => {
      window.open(`agent-chat.html?whatsapp=${u.whatsapp}`, "_blank");
      div.classList.remove("highlight");
      if(unreadMessages[u.whatsapp]){
        delete unreadMessages[u.whatsapp];
        saveUnreadMessages();
      }
      updateUnreadCount();
    });

    container.appendChild(div);
  });

  updateUnreadCount();
}

// ===== REAL-TIME EVENTS =====
socket.on("new_message", handleMessageEvent);
socket.on("message_update", handleMessageEvent);
socket.on("chat_deleted", handleMessageEvent);
socket.on("chat_archived", handleMessageEvent);
socket.on("broadcast_message", handleMessageEvent);

function handleMessageEvent(msg){
  if(msg.whatsapp && msg.id){
    highlightMessage(msg.whatsapp, msg.id);
  }
}

// ===== NOTIFICATION FUNCTIONS =====
function requestNotificationPermission() {
  if("Notification" in window && Notification.permission !== "granted"){
    Notification.requestPermission();
  }
}

function notifyUser(title, body) {
  if("Notification" in window && Notification.permission === "granted"){
    const notification = new Notification(title, { body, icon: "notification.png" });
    notification.onclick = () => window.focus();
  }
}

// Highlight user for unread message, per message
function highlightMessage(whatsapp, msgId){
  if(!unreadMessages[whatsapp]) unreadMessages[whatsapp] = {};

  if(!unreadMessages[whatsapp][msgId]){
    unreadMessages[whatsapp][msgId] = true;
    saveUnreadMessages();
    updateUnreadCount();

    // Play sound repeatedly until window focused
    const audio = document.getElementById("notificationSound");
    let interval = setInterval(() => audio.play(), 1500);
    window.addEventListener("focus", () => clearInterval(interval), { once: true });

    // Browser notification
    notifyUser("New message from " + whatsapp, "You have a new message waiting in the dashboard");

    // Highlight user in sidebar
    const items = document.getElementsByClassName("user-item");
    for(let i of items){
      if(i.textContent === whatsapp){
        i.classList.add("highlight");
      }
    }
  }
}

// ===== INITIAL FETCH =====
fetchActiveUsers();

// Restore highlights for persisted unread messages on page load
window.addEventListener("DOMContentLoaded", () => {
  requestNotificationPermission();
  for(const whatsapp in unreadMessages){
    const items = document.getElementsByClassName("user-item");
    for(let i of items){
      if(i.textContent === whatsapp && Object.keys(unreadMessages[whatsapp]).length > 0){
        i.classList.add("highlight");
      }
    }
  }
  updateUnreadCount();
});
</script>
</body>
</html>
