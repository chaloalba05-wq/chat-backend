<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Chat</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    #users { margin-bottom: 10px; width: 300px; padding: 5px; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
    input, button { padding: 8px; font-size: 14px; margin-top: 5px; }
    .message { margin: 5px 0; padding: 8px; border-radius: 5px; }
    .user-message { background-color: #e3f2fd; text-align: left; }
    .admin-message { background-color: #ffe0b2; text-align: right; }
    .info-message { background-color: #f0f0f0; color: #666; font-style: italic; text-align: center; }
  </style>
</head>
<body>

<h3>Admin Chat Panel</h3>

<div>
  <label>Select User (WhatsApp number):</label>
  <select id="users">
    <option value="">-- Select a user --</option>
  </select>
</div>

<div id="messages"></div>

<div>
  <input id="messageInput" placeholder="Type your reply" style="width: 300px;">
  <button onclick="sendMessage()">Send</button>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const socket = io("http://localhost:3000");
  const usersDropdown = document.getElementById("users");
  const messagesDiv = document.getElementById("messages");
  let selectedUser = "";
  let allUsers = new Set();

  // Identify as admin immediately
  socket.on("connect", () => {
    console.log("Connected as admin:", socket.id);
    socket.emit("admin_connect");
    addInfoMessage("Connected to server as admin");
  });

  // Listen for new messages from ALL users
  socket.on("new_message", (msg) => {
    console.log("New message received:", msg);
    
    // Add user to dropdown if not already there
    if (!allUsers.has(msg.whatsapp)) {
      allUsers.add(msg.whatsapp);
      addUserToDropdown(msg.whatsapp);
    }

    // Display message if this user is selected
    if (msg.whatsapp === selectedUser) {
      appendMessage(msg);
    } else {
      // Highlight this user in dropdown
      highlightUserInDropdown(msg.whatsapp);
      if (msg.sender !== "admin") {
        addNotification(msg);
      }
    }
  });

  // Receive message history
  socket.on("message_history", (messages) => {
    console.log("Message history received:", messages.length, "messages");
    messagesDiv.innerHTML = "";
    messages.forEach(msg => appendMessage(msg));
    if (messages.length === 0) {
      addInfoMessage("No previous messages with this user");
    }
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  function addUserToDropdown(whatsapp) {
    // Check if user already exists in dropdown
    const existing = Array.from(usersDropdown.options).find(opt => opt.value === whatsapp);
    if (!existing) {
      const option = document.createElement("option");
      option.value = whatsapp;
      option.textContent = whatsapp;
      option.id = `user-${whatsapp}`;
      usersDropdown.appendChild(option);
    }
  }

  function highlightUserInDropdown(whatsapp) {
    const option = document.getElementById(`user-${whatsapp}`);
    if (option && whatsapp !== selectedUser) {
      option.style.backgroundColor = '#ffeb3b';
      option.style.fontWeight = 'bold';
    }
  }

  function removeHighlightFromDropdown(whatsapp) {
    const option = document.getElementById(`user-${whatsapp}`);
    if (option) {
      option.style.backgroundColor = '';
      option.style.fontWeight = '';
    }
  }

  // Select a user
  usersDropdown.addEventListener("change", function() {
    const previousUser = selectedUser;
    selectedUser = this.value;
    console.log("Selected user:", selectedUser);
    
    // Remove highlight from previous user
    if (previousUser) {
      removeHighlightFromDropdown(previousUser);
    }
    
    // Clear messages and load history for selected user
    messagesDiv.innerHTML = "";
    if (selectedUser) {
      socket.emit("get_messages", { whatsapp: selectedUser });
      addInfoMessage(`Now chatting with: ${selectedUser}`);
    }
  });

  function appendMessage(msg) {
    const div = document.createElement("div");
    div.className = "message " + (msg.sender === "user" ? "user-message" : "admin-message");
    div.textContent = `${msg.sender === 'admin' ? 'You' : 'User'}: ${msg.text}`;
    div.title = new Date(msg.timestamp).toLocaleString();
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function addInfoMessage(text) {
    const div = document.createElement("div");
    div.className = "message info-message";
    div.textContent = text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function addNotification(msg) {
    const div = document.createElement("div");
    div.className = "message info-message";
    div.textContent = `ðŸ“¨ New message from ${msg.whatsapp}: "${msg.text.substring(0, 30)}${msg.text.length > 30 ? '...' : ''}"`;
    div.style.cursor = 'pointer';
    div.onclick = () => {
      usersDropdown.value = msg.whatsapp;
      usersDropdown.dispatchEvent(new Event('change'));
    };
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function sendMessage() {
    if (!selectedUser) return alert("Select a user first");
    const text = document.getElementById("messageInput").value.trim();
    if (!text) return;

    const message = {
      whatsapp: selectedUser,
      sender: "admin",  // IMPORTANT: Send as "admin"
      text: text
    };

    console.log("Sending as admin:", message);
    socket.emit("send_message", message);
    document.getElementById("messageInput").value = "";
    
    // Immediately show the message in the chat
    appendMessage(message);
  }

  // Send message with Enter key
  document.getElementById("messageInput").addEventListener("keypress", function(e) {
    if (e.key === "Enter") sendMessage();
  });
</script>

</body>
</html>