<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body { font-family: Arial; display: flex; flex-direction: column; height: 100vh; margin: 0; }
#header { background: #333; color: #fff; padding: 10px; }
#messages { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; }
.message { margin: 5px 0; }
#inputSection { display: flex; padding: 10px; border-top: 1px solid #ccc; }
#inputSection input[type=text] { flex: 1; padding: 5px; margin-right: 5px; }
#inputSection button { padding: 5px 10px; }
</style>
</head>
<body>
<div id="header">Chat</div>
<div id="messages"></div>
<div id="inputSection">
  <input type="text" id="messageInput" placeholder="Type message...">
  <input type="file" id="fileInput">
  <button id="sendBtn">Send</button>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const whatsapp = params.get("whatsapp");
const agentId = localStorage.getItem("agentId");

document.getElementById("header").textContent = `Chat with ${whatsapp}`;

// Connect socket with reconnection enabled
const socket = io({ 
  reconnection: true, 
  reconnectionAttempts: Infinity, 
  reconnectionDelay: 1000, 
  reconnectionDelayMax: 5000 
});

// Fetch chat history automatically for this user
socket.emit("get_messages", { whatsapp, agentId });

socket.on("message_history", (messages) => {
  const container = document.getElementById("messages");
  container.innerHTML = "";
  messages.forEach(msg => {
    const div = document.createElement("div");
    div.className = "message";
    div.textContent = `${msg.sender === 'agent' ? 'You' : 'User'}: ${msg.text || '[Attachment]'}`;
    container.appendChild(div);
  });
  container.scrollTop = container.scrollHeight;
});

// Listen for new messages from this user
socket.on("new_message", (msg) => {
  if (msg.whatsapp !== whatsapp) return;
  const container = document.getElementById("messages");
  const div = document.createElement("div");
  div.className = "message";
  div.textContent = `${msg.sender === 'agent' ? 'You' : 'User'}: ${msg.text || '[Attachment]'}`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
});

// renamed listeners only
socket.on("message_update", (msg) => { if (msg.whatsapp !== whatsapp) return; });
socket.on("chat_deleted", (msg) => { if (msg.whatsapp !== whatsapp) return; });
socket.on("chat_archived", (msg) => { if (msg.whatsapp !== whatsapp) return; });

// Send message
document.getElementById("sendBtn").addEventListener("click", () => {
  const text = document.getElementById("messageInput").value.trim();
  const file = document.getElementById("fileInput").files[0];

  if (!text && !file) return;

  const message = { whatsapp, message: text };

  if (file) {
    const reader = new FileReader();
    reader.onload = () => {
      message.attachment = { name: file.name, data: reader.result, mimetype: file.type };
      socket.emit("agent_message", message);
    };
    reader.readAsDataURL(file);
  } else {
    socket.emit("agent_message", message);
  }

  document.getElementById("messageInput").value = "";
  document.getElementById("fileInput").value = "";
});
</script>
</body>
</html>
