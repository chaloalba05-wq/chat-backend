<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Super Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
    .container { max-width: 1200px; margin: 0 auto; }

    /* Login overlay */
    #loginOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #loginContainer {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    input, button { font-size: 16px; }
    button { cursor: pointer; }

    /* Debug console */
    #debugConsole {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: 300px;
      height: 200px;
      background: rgba(0,0,0,0.8);
      color: #00ff00;
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      overflow-y: auto;
      border-radius: 5px;
      z-index: 9999;
      display: none;
    }

    #toggleDebug {
      position: fixed;
      bottom: 220px;
      right: 10px;
      padding: 5px 10px;
      background: #333;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      z-index: 10000;
    }
  </style>
</head>
<body>

<div id="debugConsole"></div>
<button id="toggleDebug" onclick="toggleDebug()">üêõ Debug</button>

<!-- Login Overlay -->
<div id="loginOverlay">
  <div id="loginContainer">
    <h1 style="margin-bottom: 30px; color: #333;">üîê Super Admin</h1>
    <p style="color: #666; margin-bottom: 20px;">Enter super admin password:</p>
    <input type="password" id="superPassword" placeholder="Password" autocomplete="off" 
           style="width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 5px;">
    <div id="loginError" style="color: #d32f2f; margin: 10px 0; min-height: 20px;"></div>
    <button onclick="loginSuperAdmin()" 
            style="width: 100%; padding: 15px; background: #1a237e; color: white; border: none; border-radius: 5px; margin-top: 10px;">
      Access Dashboard
    </button>
    <div style="margin-top: 20px; font-size: 12px; color: #888;">
      <em>Server URL: <span id="serverUrl">https://chat-backend-p2b9.onrender.com</span></em>
    </div>
    <div style="margin-top: 10px; font-size: 12px; color: #666;">
      <button onclick="testConnection()" style="padding: 5px 10px; background: #666; color: white; border: none; border-radius: 3px;">
        Test Connection
      </button>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  let isSuperAdminAuthenticated = false;
  let socket = null;
  let agents = [];
  let activeChats = [];
  let users = [];
  let activityLogs = [];

  const loginOverlay = document.getElementById('loginOverlay');
  const dashboard = document.createElement('div');
  const superPassword = document.getElementById('superPassword');
  const loginError = document.getElementById('loginError');
  const debugConsole = document.getElementById('debugConsole');

  function debugLog(message, type='info') {
    const timestamp = new Date().toLocaleTimeString();
    const color = type==='error' ? '#ff4444' : type==='success' ? '#44ff44' : type==='warning' ? '#ffaa00' : '#ffffff';
    const logEntry = document.createElement('div');
    logEntry.style.color = color;
    logEntry.textContent = `[${timestamp}] ${message}`;
    debugConsole.appendChild(logEntry);
    debugConsole.scrollTop = debugConsole.scrollHeight;
    console.log(`[SuperAdmin] ${message}`);
  }

  function toggleDebug() {
    debugConsole.style.display = debugConsole.style.display==='none'?'block':'none';
  }

  function testConnection() {
    debugLog('Testing connection to server...', 'info');
    loginError.textContent='Testing connection...';
    const testSocket = io("https://chat-backend-p2b9.onrender.com",{transports:['websocket','polling'],timeout:5000});
    testSocket.on('connect',()=>{debugLog('‚úÖ Connection test successful!','success');loginError.textContent='‚úÖ Connection successful!';loginError.style.color='#4CAF50';testSocket.disconnect();});
    testSocket.on('connect_error',(error)=>{debugLog(`‚ùå Connection failed: ${error.message}`,'error');loginError.textContent=`Connection failed: ${error.message}`;loginError.style.color='#f44336';});
    setTimeout(()=>{if(!testSocket.connected){debugLog('‚ö†Ô∏è Connection test timeout','warning');loginError.textContent='Connection timeout. Server may be offline.';loginError.style.color='#ff9800';}},5000);
  }

  function loginSuperAdmin() {
    const password = superPassword.value.trim();
    if(!password){loginError.textContent='Please enter password';loginError.style.color='#f44336';return;}
    debugLog('Attempting login...','info');loginError.textContent='Connecting to server...';loginError.style.color='#2196F3';

    if(!socket){
      debugLog('Creating new socket connection...','info');
      socket = io("https://chat-backend-p2b9.onrender.com",{transports:['websocket','polling'],reconnection:true,reconnectionAttempts:3,reconnectionDelay:1000,timeout:10000});
      socket.on('connect',()=>{debugLog('‚úÖ Socket connected with ID: '+socket.id,'success');loginError.textContent='Connected to server. Logging in...';});
      socket.on('connect_error',(error)=>{debugLog(`‚ùå Connection error: ${error.message}`,'error');loginError.textContent=`Connection error: ${error.message}`;loginError.style.color='#f44336';});
      socket.on('disconnect',(reason)=>{debugLog(`üîå Disconnected: ${reason}`,'warning');if(isSuperAdminAuthenticated){debugLog('Attempting to reconnect...','info');}});
    }

    debugLog('Sending login request...','info');
    socket.emit('super_admin_login',{password});

    const loginTimeout = setTimeout(()=>{if(!isSuperAdminAuthenticated){debugLog('‚ö†Ô∏è Login timeout - no response from server','warning');loginError.textContent='Login timeout. Server may be busy.';loginError.style.color='#ff9800';}},10000);

    socket.once('super_admin_login_response',(response)=>{
      clearTimeout(loginTimeout);
      if(response.success){
        debugLog('‚úÖ Login successful!','success');
        sessionStorage.setItem('superAdminAuthenticated','true');
        loginOverlay.style.display='none';
        dashboard.style.display='block';
        isSuperAdminAuthenticated=true;
        initializeSuperAdmin();
        socket.emit('get_agent_files');
      }else{
        debugLog(`‚ùå Login failed: ${response.message||'Unknown error'}`,'error');
        loginError.textContent=response.message||'Login failed. Check password.';
        loginError.style.color='#f44336';
        superPassword.value='';superPassword.focus();
      }
    });
  }

  function initializeSuperAdmin() {
    debugLog('Initializing Super Admin dashboard...','info');
    // Socket listeners and broadcasting to agent admins will be added in next chunk
  }
</script>
<script>
  function initializeSuperAdmin() {
    // Create dashboard container
    dashboard.className = 'container';
    dashboard.innerHTML = `
      <h1>Super Admin Dashboard</h1>
      <hr>
      <div style="display:flex; gap:20px; flex-wrap:wrap;">
        <!-- Agents Section -->
        <div style="flex:1; min-width:300px;">
          <h2>Agents</h2>
          <ul id="agentsList" style="list-style:none; padding:0; border:1px solid #ccc; border-radius:5px; max-height:400px; overflow-y:auto;"></ul>
          <input type="text" id="newAgentName" placeholder="Agent Name" style="width:70%; padding:10px; margin-top:10px; border-radius:5px; border:1px solid #ccc;">
          <input type="text" id="newAgentId" placeholder="Agent ID" style="width:70%; padding:10px; margin-top:10px; border-radius:5px; border:1px solid #ccc;">
          <button onclick="addAgent()" style="padding:10px 15px; margin-top:10px; background:#1a237e; color:white; border:none; border-radius:5px;">Add Agent</button>
        </div>

        <!-- Active Chats Section -->
        <div style="flex:2; min-width:400px;">
          <h2>Active Chats</h2>
          <div id="chatContainer" style="border:1px solid #ccc; border-radius:5px; max-height:500px; overflow-y:auto; padding:10px;"></div>
          <input type="text" id="superMessageInput" placeholder="Type message..." style="width:80%; padding:10px; border-radius:5px; border:1px solid #ccc; margin-top:10px;">
          <button onclick="sendSuperMessage()" style="padding:10px 15px; margin-top:10px; background:#388e3c; color:white; border:none; border-radius:5px;">Send</button>
        </div>
      </div>
      <hr>
      <h3>Activity Logs</h3>
      <div id="activityLog" style="border:1px solid #ccc; border-radius:5px; max-height:200px; overflow-y:auto; padding:10px;"></div>
    `;
    document.body.appendChild(dashboard);

    // Request current agents list
    socket.emit('request_agents');
    socket.on('agents_list', (list) => {
      agents = list;
      renderAgents();
    });

    // Listen for messages from users
    socket.on('user_message', handleUserMessage);
    socket.on('user_image', handleUserImage);
  }

  function renderAgents() {
    const agentsList = document.getElementById('agentsList');
    agentsList.innerHTML = '';
    agents.forEach(agent => {
      const li = document.createElement('li');
      li.style.padding = '8px';
      li.style.borderBottom = '1px solid #ddd';
      li.textContent = `${agent.name} (${agent.id})`;
      agentsList.appendChild(li);
    });
  }

  function addAgent() {
    const name = document.getElementById('newAgentName').value.trim();
    const id = document.getElementById('newAgentId').value.trim();
    if(!name || !id){ debugLog('Cannot add agent without name or ID','warning'); return; }
    socket.emit('add_agent', {name, id});
    debugLog(`Agent added: ${name} (${id})`, 'success');
    agents.push({name, id});
    renderAgents();
    document.getElementById('newAgentName').value = '';
    document.getElementById('newAgentId').value = '';
  }

  function handleUserMessage(msg) {
    // msg: {from: userId, content: message}
    activeChats.push(msg);
    renderChats();
    debugLog(`New message from ${msg.from}: ${msg.content}`, 'info');
    broadcastToAgents(msg);
  }

  function handleUserImage(msg) {
    // msg: {from: userId, imageURL: string}
    activeChats.push(msg);
    renderChats();
    debugLog(`New image from ${msg.from}`, 'info');
    broadcastToAgents(msg);
  }

  function renderChats() {
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.innerHTML = '';
    activeChats.forEach(chat => {
      const div = document.createElement('div');
      div.style.padding = '5px';
      div.style.borderBottom = '1px solid #eee';
      if(chat.content){
        div.textContent = `${chat.from}: ${chat.content}`;
      } else if(chat.imageURL){
        const img = document.createElement('img');
        img.src = chat.imageURL;
        img.style.maxWidth = '200px';
        img.style.display = 'block';
        div.appendChild(document.createTextNode(`${chat.from}:`));
        div.appendChild(img);
      }
      chatContainer.appendChild(div);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function sendSuperMessage() {
    const input = document.getElementById('superMessageInput');
    const message = input.value.trim();
    if(!message) return;
    // Broadcast to all agents
    const msgObj = {from: 'SuperAdmin', content: message};
    socket.emit('super_message', msgObj);
    debugLog(`SuperAdmin sent: ${message}`, 'success');
    input.value = '';
  }

  function broadcastToAgents(msg) {
    // Forward message to all connected agent admins
    socket.emit('broadcast_to_agents', msg);
  }

</script>
