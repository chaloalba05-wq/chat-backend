<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Super Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
    .container { max-width: 1200px; margin: 0 auto; }

    /* Login overlay */
    #loginOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #loginContainer {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    input, button, select { font-size: 16px; }
    button { cursor: pointer; }

    .agent-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border: 1px solid #ddd;
      margin: 5px 0;
      border-radius: 5px;
      background: white;
    }

    .muted { opacity: 0.6; background: #f5f5f5; }
    
    .toggle-btn {
      padding: 5px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .mute-btn { background: #ff4444; color: white; }
    .unmute-btn { background: #4CAF50; color: white; }
    
    .chat-message {
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      background: #e3f2fd;
    }
    
    .user-message { background: #f1f8e9; }
    .super-message { background: #e8eaf6; }
    
    .status-badge {
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      margin-left: 5px;
    }
    
    .online { background: #4CAF50; color: white; }
    .offline { background: #9E9E9E; color: white; }
  </style>
</head>
<body>

<!-- Login Overlay -->
<div id="loginOverlay">
  <div id="loginContainer">
    <h1 style="margin-bottom: 30px; color: #333;">üîê Super Admin</h1>
    <p style="color: #666; margin-bottom: 20px;">Enter super admin password:</p>
    <input type="password" id="superPassword" placeholder="Password" autocomplete="off" 
           style="width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 5px;">
    <div id="loginError" style="color: #d32f2f; margin: 10px 0; min-height: 20px;"></div>
    <button onclick="loginSuperAdmin()" 
            style="width: 100%; padding: 15px; background: #1a237e; color: white; border: none; border-radius: 5px; margin-top: 10px;">
      Access Dashboard
    </button>
    <div style="margin-top: 20px; font-size: 12px; color: #888;">
      <em>Server URL: <span id="serverUrl">https://chat-backend-p2b9.onrender.com</span></em>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  let socket = null;
  let agents = [];
  let activeMessages = [];
  let existingAgentFiles = [];

  // DOM Elements
  const loginOverlay = document.getElementById('loginOverlay');
  const superPassword = document.getElementById('superPassword');
  const loginError = document.getElementById('loginError');

  // Login function
  function loginSuperAdmin() {
    const password = superPassword.value.trim();
    if (!password) {
      loginError.textContent = 'Please enter password';
      return;
    }

    // Connect to server
    socket = io("https://chat-backend-p2b9.onrender.com", {
      transports: ['websocket', 'polling']
    });

    socket.on('connect', () => {
      console.log('Connected to server');
      socket.emit('super_admin_login', { password });
    });

    socket.on('super_admin_login_response', (response) => {
      if (response.success) {
        loginOverlay.style.display = 'none';
        initializeDashboard();
        loadAgents();
        getExistingAgentFiles();
      } else {
        loginError.textContent = response.message || 'Login failed';
      }
    });

    socket.on('connect_error', (error) => {
      loginError.textContent = `Connection error: ${error.message}`;
    });
  }

  // Initialize dashboard
  function initializeDashboard() {
    const dashboard = document.createElement('div');
    dashboard.className = 'container';
    dashboard.innerHTML = `
      <h1>Super Admin Dashboard</h1>
      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 20px;">
        
        <!-- Agents Management -->
        <div>
          <h2>Agents Management</h2>
          <div id="agentsList" style="margin-bottom: 20px; max-height: 400px; overflow-y: auto;"></div>
          
          <div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #ddd;">
            <h3>Add/Edit Agent</h3>
            <input type="text" id="agentName" placeholder="Agent Name" 
                   style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
            <input type="text" id="agentId" placeholder="Agent ID (for login)" 
                   style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
            <input type="password" id="agentPassword" placeholder="Agent Password" 
                   style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
            
            <div style="margin: 10px 0;">
              <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #666;">
                Assign to file (optional):
              </label>
              <select id="agentFilename" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">-- No specific file --</option>
                <option value="agent1.html">agent1.html</option>
                <option value="agent2.html">agent2.html</option>
                <option value="agent3.html">agent3.html</option>
                <option value="agent4.html">agent4.html</option>
                <option value="agent5.html">agent5.html</option>
                <option value="agent6.html">agent6.html</option>
                <option value="agent7.html">agent7.html</option>
                <option value="agent8.html">agent8.html</option>
                <option value="agent9.html">agent9.html</option>
                <option value="agent10.html">agent10.html</option>
              </select>
              <div id="fileStatus" style="font-size: 12px; margin-top: 5px; color: #666;"></div>
            </div>
            
            <button onclick="saveAgent()" 
                    style="width: 100%; padding: 10px; background: #1a237e; color: white; border: none; border-radius: 4px; margin-top: 10px;">
              Save Agent
            </button>
          </div>
        </div>

        <!-- Messages Panel -->
        <div>
          <h2>Messages</h2>
          <div id="messagesContainer" style="height: 500px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 20px;"></div>
          
          <div style="display: flex; gap: 10px;">
            <input type="text" id="messageInput" placeholder="Type a message..." 
                   style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <button onclick="sendMessage()" 
                    style="padding: 10px 20px; background: #388e3c; color: white; border: none; border-radius: 4px;">
              Send
            </button>
          </div>
          
          <!-- Activity Log -->
          <div style="margin-top: 20px; background: white; padding: 15px; border-radius: 5px; border: 1px solid #ddd;">
            <h3>Recent Activity</h3>
            <div id="activityLog" style="max-height: 150px; overflow-y: auto; margin-top: 10px;"></div>
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(dashboard);

    // Setup socket listeners
    setupSocketListeners();
    
    // Setup filename selector change event
    setTimeout(() => {
      const filenameSelect = document.getElementById('agentFilename');
      if (filenameSelect) {
        filenameSelect.addEventListener('change', checkFileStatus);
      }
    }, 100);
  }

  // Check if selected file is already assigned
  function checkFileStatus() {
    const filenameSelect = document.getElementById('agentFilename');
    const fileStatus = document.getElementById('fileStatus');
    const selectedFile = filenameSelect.value;
    
    if (!selectedFile) {
      fileStatus.innerHTML = '';
      return;
    }
    
    // Check if any agent is already using this file
    const agentUsingFile = agents.find(agent => agent.filename === selectedFile);
    
    if (agentUsingFile) {
      fileStatus.innerHTML = `‚ö†Ô∏è This file is already assigned to: <strong>${agentUsingFile.name}</strong>`;
      fileStatus.style.color = '#f44336';
    } else {
      fileStatus.innerHTML = `‚úÖ File is available for assignment`;
      fileStatus.style.color = '#4CAF50';
    }
  }

  // Load agents from server
  function loadAgents() {
    socket.emit('get_agents');
  }

  // Get existing agent files from server
  function getExistingAgentFiles() {
    socket.emit('get_agent_files');
  }

  // Setup socket listeners
  function setupSocketListeners() {
    // Listen for agents list
    socket.on('agents_list', (agentList) => {
      agents = agentList;
      renderAgents();
    });

    // Listen for agent files list
    socket.on('agent_files_list', (files) => {
      existingAgentFiles = files;
      updateFilenameDropdown();
    });

    // Listen for user messages
    socket.on('user_message', (data) => {
      addMessage(data.userId || 'User', data.message, 'user');
      logActivity(`User message: ${data.message}`);
      
      // Forward to all non-muted agents
      socket.emit('forward_to_agents', {
        type: 'user_message',
        data: data,
        timestamp: new Date().toISOString()
      });
    });

    // Listen for agent messages
    socket.on('agent_message_received', (data) => {
      addMessage(data.agentName, data.message, 'agent');
      logActivity(`${data.agentName}: ${data.message}`);
    });

    // Listen for activity updates
    socket.on('activity_update', (activities) => {
      activities.forEach(activity => {
        logActivity(`${activity.type}: ${JSON.stringify(activity.details)}`);
      });
    });

    // Listen for agent status updates
    socket.on('agent_updated', () => {
      loadAgents(); // Reload agents list
    });
  }

  // Update filename dropdown with existing files
  function updateFilenameDropdown() {
    const filenameSelect = document.getElementById('agentFilename');
    if (!filenameSelect) return;
    
    // Save current selection
    const currentSelection = filenameSelect.value;
    
    // Clear existing options except the first one
    while (filenameSelect.options.length > 1) {
      filenameSelect.remove(1);
    }
    
    // Add existing agent files
    existingAgentFiles.forEach(file => {
      const option = document.createElement('option');
      option.value = file;
      option.textContent = file;
      filenameSelect.appendChild(option);
    });
    
    // Add custom files if they don't exist
    for (let i = 1; i <= 10; i++) {
      const filename = `agent${i}.html`;
      if (!existingAgentFiles.includes(filename)) {
        const option = document.createElement('option');
        option.value = filename;
        option.textContent = filename;
        filenameSelect.appendChild(option);
      }
    }
    
    // Restore selection if still valid
    if (currentSelection && Array.from(filenameSelect.options).some(opt => opt.value === currentSelection)) {
      filenameSelect.value = currentSelection;
    }
  }

  // Render agents list
  function renderAgents() {
    const agentsList = document.getElementById('agentsList');
    agentsList.innerHTML = '';
    
    if (agents.length === 0) {
      agentsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No agents yet. Add your first agent above.</div>';
      return;
    }
    
    agents.forEach(agent => {
      const agentDiv = document.createElement('div');
      agentDiv.className = `agent-item ${agent.muted ? 'muted' : ''}`;
      
      const statusBadge = agent.isOnline 
        ? `<span class="status-badge online">Online</span>`
        : `<span class="status-badge offline">Offline</span>`;
      
      const fileInfo = agent.filename 
        ? `<br><small style="color: #666;">File: ${agent.filename}</small>`
        : '';
      
      agentDiv.innerHTML = `
        <div style="flex: 1;">
          <strong>${agent.name}</strong> ${statusBadge}
          <br>
          <small style="color: #666;">ID: ${agent.id}</small>
          ${fileInfo}
          ${agent.muted ? '<br><small style="color: #f44336;">üîá Muted</small>' : ''}
        </div>
        <div>
          <button class="toggle-btn ${agent.muted ? 'unmute-btn' : 'mute-btn'}" 
                  onclick="toggleAgentMute('${agent.id}')">
            ${agent.muted ? 'Unmute' : 'Mute'}
          </button>
        </div>
      `;
      agentsList.appendChild(agentDiv);
    });
    
    // Update file status after rendering
    setTimeout(checkFileStatus, 100);
  }

  // Save/Update agent
  function saveAgent() {
    const name = document.getElementById('agentName').value.trim();
    const id = document.getElementById('agentId').value.trim();
    const password = document.getElementById('agentPassword').value.trim();
    const filename = document.getElementById('agentFilename').value;
    
    if (!name || !id || !password) {
      alert('Please fill all required fields: Name, ID, and Password');
      return;
    }
    
    socket.emit('save_agent', {
      name: name,
      id: id,
      password: password,
      filename: filename || undefined
    });
    
    // Clear form
    document.getElementById('agentName').value = '';
    document.getElementById('agentId').value = '';
    document.getElementById('agentPassword').value = '';
    document.getElementById('agentFilename').value = '';
    document.getElementById('fileStatus').innerHTML = '';
  }

  // Toggle agent mute status
  function toggleAgentMute(agentId) {
    socket.emit('toggle_agent_mute', { agentId: agentId });
  }

  // Add message to display
  function addMessage(sender, content, type = 'user') {
    const messagesContainer = document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}-message`;
    messageDiv.innerHTML = `
      <strong>${sender}:</strong> ${content}<br>
      <small>${new Date().toLocaleTimeString()}</small>
    `;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Log activity
  function logActivity(text) {
    const activityLog = document.getElementById('activityLog');
    if (!activityLog) return;
    
    const logEntry = document.createElement('div');
    logEntry.style.padding = '5px 0';
    logEntry.style.borderBottom = '1px solid #eee';
    logEntry.style.fontSize = '12px';
    logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${text}`;
    
    activityLog.appendChild(logEntry);
    activityLog.scrollTop = activityLog.scrollHeight;
  }

  // Send message from Super Admin
  function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add to display
    addMessage('Super Admin', message, 'super');
    logActivity(`You: ${message}`);
    
    // Broadcast to all non-muted agents
    socket.emit('forward_to_agents', {
      type: 'super_message',
      data: {
        from: 'Super Admin',
        message: message
      },
      timestamp: new Date().toISOString()
    });
    
    input.value = '';
    input.focus();
  }

  // Auto-login if already authenticated
  window.addEventListener('load', () => {
    const savedPassword = localStorage.getItem('superAdminPassword');
    if (savedPassword) {
      superPassword.value = savedPassword;
    }
  });

  // Enter key for login
  superPassword.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') loginSuperAdmin();
  });
</script>
</body>
</html>