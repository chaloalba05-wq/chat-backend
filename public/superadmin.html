<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Super Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
    .container { max-width: 1200px; margin: 0 auto; }

    /* Login overlay */
    #loginOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #loginContainer {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    input, button { font-size: 16px; }
    button { cursor: pointer; }

    .agent-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border: 1px solid #ddd;
      margin: 5px 0;
      border-radius: 5px;
      background: white;
    }

    .muted { opacity: 0.6; background: #f5f5f5; }
    
    .toggle-btn {
      padding: 5px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .mute-btn { background: #ff4444; color: white; }
    .unmute-btn { background: #4CAF50; color: white; }
    
    .chat-message {
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      background: #e3f2fd;
    }
    
    .user-message { background: #f1f8e9; }
    .super-message { background: #e8eaf6; }
  </style>
</head>
<body>

<!-- Login Overlay -->
<div id="loginOverlay">
  <div id="loginContainer">
    <h1 style="margin-bottom: 30px; color: #333;">üîê Super Admin</h1>
    <p style="color: #666; margin-bottom: 20px;">Enter super admin password:</p>
    <input type="password" id="superPassword" placeholder="Password" autocomplete="off" 
           style="width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 5px;">
    <div id="loginError" style="color: #d32f2f; margin: 10px 0; min-height: 20px;"></div>
    <button onclick="loginSuperAdmin()" 
            style="width: 100%; padding: 15px; background: #1a237e; color: white; border: none; border-radius: 5px; margin-top: 10px;">
      Access Dashboard
    </button>
    <div style="margin-top: 20px; font-size: 12px; color: #888;">
      <em>Server URL: <span id="serverUrl">https://chat-backend-p2b9.onrender.com</span></em>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  let socket = null;
  let agents = [];
  let activeMessages = [];

  // DOM Elements
  const loginOverlay = document.getElementById('loginOverlay');
  const superPassword = document.getElementById('superPassword');
  const loginError = document.getElementById('loginError');

  // Login function
  function loginSuperAdmin() {
    const password = superPassword.value.trim();
    if (!password) {
      loginError.textContent = 'Please enter password';
      return;
    }

    // Connect to server
    socket = io("https://chat-backend-p2b9.onrender.com", {
      transports: ['websocket', 'polling']
    });

    socket.on('connect', () => {
      console.log('Connected to server');
      socket.emit('super_admin_login', { password });
    });

    socket.on('super_admin_login_response', (response) => {
      if (response.success) {
        loginOverlay.style.display = 'none';
        initializeDashboard();
        loadAgents();
      } else {
        loginError.textContent = response.message || 'Login failed';
      }
    });

    socket.on('connect_error', (error) => {
      loginError.textContent = `Connection error: ${error.message}`;
    });
  }

  // Initialize dashboard
  function initializeDashboard() {
    const dashboard = document.createElement('div');
    dashboard.className = 'container';
    dashboard.innerHTML = `
      <h1>Super Admin Dashboard</h1>
      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 20px;">
        
        <!-- Agents Management -->
        <div>
          <h2>Agents Management</h2>
          <div id="agentsList" style="margin-bottom: 20px; max-height: 400px; overflow-y: auto;"></div>
          
          <div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #ddd;">
            <h3>Add/Edit Agent</h3>
            <input type="text" id="agentName" placeholder="Agent Name" 
                   style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
            <input type="text" id="agentId" placeholder="Agent ID" 
                   style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
            <input type="password" id="agentPassword" placeholder="Agent Password" 
                   style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
            <button onclick="saveAgent()" 
                    style="width: 100%; padding: 10px; background: #1a237e; color: white; border: none; border-radius: 4px; margin-top: 10px;">
              Save Agent
            </button>
          </div>
        </div>

        <!-- Messages Panel -->
        <div>
          <h2>Messages</h2>
          <div id="messagesContainer" style="height: 500px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 20px;"></div>
          
          <div style="display: flex; gap: 10px;">
            <input type="text" id="messageInput" placeholder="Type a message..." 
                   style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <button onclick="sendMessage()" 
                    style="padding: 10px 20px; background: #388e3c; color: white; border: none; border-radius: 4px;">
              Send
            </button>
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(dashboard);

    // Setup socket listeners
    setupSocketListeners();
  }

  // Load agents from server
  function loadAgents() {
    socket.emit('get_agents');
  }

  // Setup socket listeners
  function setupSocketListeners() {
    // Listen for agents list
    socket.on('agents_list', (agentList) => {
      agents = agentList;
      renderAgents();
    });

    // Listen for user messages
    socket.on('user_message', (data) => {
      addMessage(data.userId || 'User', data.message, 'user');
      
      // Forward to all non-muted agents
      socket.emit('forward_to_agents', {
        type: 'user_message',
        data: data,
        timestamp: new Date().toISOString()
      });
    });

    // Listen for agent status updates
    socket.on('agent_updated', () => {
      loadAgents(); // Reload agents list
    });
  }

  // Render agents list
  function renderAgents() {
    const agentsList = document.getElementById('agentsList');
    agentsList.innerHTML = '';
    
    agents.forEach(agent => {
      const agentDiv = document.createElement('div');
      agentDiv.className = `agent-item ${agent.muted ? 'muted' : ''}`;
      agentDiv.innerHTML = `
        <div>
          <strong>${agent.name}</strong><br>
          <small>ID: ${agent.id}</small>
        </div>
        <button class="toggle-btn ${agent.muted ? 'unmute-btn' : 'mute-btn'}" 
                onclick="toggleAgentMute('${agent.id}')">
          ${agent.muted ? 'Unmute' : 'Mute'}
        </button>
      `;
      agentsList.appendChild(agentDiv);
    });
  }

  // Save/Update agent
  function saveAgent() {
    const name = document.getElementById('agentName').value.trim();
    const id = document.getElementById('agentId').value.trim();
    const password = document.getElementById('agentPassword').value.trim();
    
    if (!name || !id || !password) {
      alert('Please fill all fields');
      return;
    }
    
    socket.emit('save_agent', {
      name: name,
      id: id,
      password: password
    });
    
    // Clear form
    document.getElementById('agentName').value = '';
    document.getElementById('agentId').value = '';
    document.getElementById('agentPassword').value = '';
  }

  // Toggle agent mute status
  function toggleAgentMute(agentId) {
    socket.emit('toggle_agent_mute', { agentId: agentId });
  }

  // Add message to display
  function addMessage(sender, content, type = 'user') {
    const messagesContainer = document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}-message`;
    messageDiv.innerHTML = `
      <strong>${sender}:</strong> ${content}<br>
      <small>${new Date().toLocaleTimeString()}</small>
    `;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Send message from Super Admin
  function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add to display
    addMessage('Super Admin', message, 'super');
    
    // Broadcast to all non-muted agents
    socket.emit('forward_to_agents', {
      type: 'super_message',
      data: {
        from: 'Super Admin',
        message: message
      },
      timestamp: new Date().toISOString()
    });
    
    input.value = '';
    input.focus();
  }

  // Auto-login if already authenticated
  window.addEventListener('load', () => {
    const savedPassword = localStorage.getItem('superAdminPassword');
    if (savedPassword) {
      superPassword.value = savedPassword;
    }
  });

  // Enter key for login
  superPassword.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') loginSuperAdmin();
  });
</script>
</body>
</html>