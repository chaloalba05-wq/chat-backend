<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Agent Admin</title>
  <style>
    body { font-family: Arial; margin: 0; background: #f5f5f5; }
    
    /* Layout */
    .container { display: flex; height: 100vh; }
    .sidebar { width: 250px; background: white; border-right: 1px solid #ddd; overflow-y: auto; }
    .chat-area { flex: 1; display: flex; flex-direction: column; }
    
    /* User list */
    .user { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
    .user:hover { background: #f9f9f9; }
    .user.active { background: #e3f2fd; }
    .user-name { font-weight: bold; }
    .user-preview { font-size: 12px; color: #666; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* Messages */
    .messages { flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; }
    .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 8px; max-width: 70%; }
    .msg.user { background: #e3f2fd; float: left; }
    .msg.agent { background: #dcf8c6; float: right; }
    .msg-img { max-width: 200px; margin-top: 5px; border-radius: 5px; }
    
    /* Input */
    .input-area { padding: 15px; background: white; border-top: 1px solid #ddd; display: flex; gap: 10px; }
    .input-area input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    .input-area button { padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; }
    
    /* Login */
    .login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center; }
    .login-box { width: 300px; padding: 30px; border: 1px solid #ddd; border-radius: 5px; text-align: center; }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login">
  <div class="login-box">
    <h3>Agent Login</h3>
    <input type="text" id="agentId" placeholder="Agent ID" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
    <input type="password" id="agentPass" placeholder="Password" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
    <div id="loginError" style="color: red; margin: 10px 0; font-size: 14px;"></div>
    <button onclick="login()" style="width: 100%; padding: 10px; background: #1976d2; color: white; border: none; border-radius: 4px;">Login</button>
  </div>
</div>

<!-- Main App -->
<div id="app" class="container" style="display: none;">
  
  <!-- Sidebar: User List -->
  <div class="sidebar">
    <div style="padding: 15px; border-bottom: 1px solid #ddd; background: #f9f9f9;">
      <strong>Chats</strong>
      <div id="agentName" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
    </div>
    <div id="userList">
      <!-- Users will appear here -->
    </div>
  </div>
  
  <!-- Chat Area -->
  <div class="chat-area">
    
    <!-- Chat Header -->
    <div style="padding: 15px; border-bottom: 1px solid #ddd; background: white;">
      <strong id="currentUser">Select a user to chat</strong>
      <div id="userInfo" style="font-size: 12px; color: #666; margin-top: 2px;">Click on a user from the left</div>
    </div>
    
    <!-- Messages -->
    <div id="messages" class="messages">
      <!-- Messages will appear here -->
    </div>
    
    <!-- Input Area -->
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Type message..." disabled>
      <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  let socket = null;
  let currentAgent = null;
  let selectedUser = null;
  let users = new Map(); // Store users and their messages

  // Login
  function login() {
    const id = document.getElementById('agentId').value.trim();
    const pass = document.getElementById('agentPass').value.trim();
    
    if (!id || !pass) {
      document.getElementById('loginError').textContent = 'Enter ID and password';
      return;
    }
    
    socket = io("https://chat-backend-p2b9.onrender.com");
    
    socket.on('connect', () => {
      socket.emit('agent_login', { agentId: id, password: pass });
    });
    
    socket.on('agent_login_response', (res) => {
      if (res.success) {
        currentAgent = { id: id, name: res.name };
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        document.getElementById('agentName').textContent = res.name;
        setupListeners();
      } else {
        document.getElementById('loginError').textContent = res.message || 'Login failed';
      }
    });
  }

  // Setup socket listeners
  function setupListeners() {
    // Listen for user messages
    socket.on('user_message', (data) => {
      addUserMessage(data.userId || 'User', data.message, data);
    });
    
    // Listen for messages with attachments
    socket.on('new_message', (msg) => {
      if (msg.sender === 'user') {
        addUserMessage(msg.whatsapp || 'User', msg.text || msg.message, msg);
      }
    });
    
    // Listen for Super Admin messages
    socket.on('super_message', (data) => {
      addUserMessage('Super Admin', data.message, data);
    });
  }

  // Add user message
  function addUserMessage(userId, message, data) {
    // Add to users map
    if (!users.has(userId)) {
      users.set(userId, {
        name: userId,
        lastMsg: message,
        time: new Date().toISOString(),
        messages: []
      });
    }
    
    const user = users.get(userId);
    user.messages.push({
      text: message,
      time: data.timestamp || new Date().toISOString(),
      image: data.attachment || data.imageURL
    });
    user.lastMsg = message;
    user.time = data.timestamp || new Date().toISOString();
    
    // Update user list
    updateUserList();
    
    // If this user is selected, show the message
    if (selectedUser === userId) {
      showMessages();
    }
  }

  // Update user list UI
  function updateUserList() {
    const userList = document.getElementById('userList');
    userList.innerHTML = '';
    
    users.forEach((user, userId) => {
      const div = document.createElement('div');
      div.className = `user ${selectedUser === userId ? 'active' : ''}`;
      div.onclick = () => selectUser(userId);
      
      div.innerHTML = `
        <div class="user-name">${user.name}</div>
        <div class="user-preview">${user.lastMsg}</div>
      `;
      
      userList.appendChild(div);
    });
  }

  // Select a user
  function selectUser(userId) {
    selectedUser = userId;
    const user = users.get(userId);
    
    document.getElementById('currentUser').textContent = user.name;
    document.getElementById('userInfo').textContent = 'Last message: ' + new Date(user.time).toLocaleTimeString();
    
    // Enable input
    document.getElementById('messageInput').disabled = false;
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('messageInput').focus();
    
    // Show messages
    showMessages();
  }

  // Show messages for selected user
  function showMessages() {
    if (!selectedUser) return;
    
    const messagesDiv = document.getElementById('messages');
    const user = users.get(selectedUser);
    
    messagesDiv.innerHTML = '';
    
    user.messages.forEach(msg => {
      const div = document.createElement('div');
      div.className = `msg ${msg.sender === 'agent' ? 'agent' : 'user'}`;
      
      let content = msg.text || '';
      if (msg.image) {
        const imgUrl = msg.image.path || msg.image;
        content += `<br><img src="${imgUrl}" class="msg-img">`;
      }
      
      div.innerHTML = content + `<div style="font-size: 11px; color: #666; margin-top: 3px;">${formatTime(msg.time)}</div>`;
      messagesDiv.appendChild(div);
    });
    
    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Send message
  function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text || !selectedUser) return;
    
    // Add to local messages
    const user = users.get(selectedUser);
    user.messages.push({
      text: text,
      time: new Date().toISOString(),
      sender: 'agent'
    });
    
    // Send to server
    socket.emit('agent_message', {
      agentId: currentAgent.id,
      agentName: currentAgent.name,
      message: text
    });
    
    // Update UI
    showMessages();
    input.value = '';
    input.focus();
  }

  // Helper: Format time
  function formatTime(timestamp) {
    return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  // Enter key support
  document.getElementById('agentPass').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') login();
  });
  
  document.getElementById('messageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
</script>
</body>
</html>